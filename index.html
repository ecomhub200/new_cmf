<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crash Analysis System - Henrico County</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<style>
:root{--primary:#1e40af;--primary-dark:#1e3a8a;--primary-light:#dbeafe;--secondary:#7c3aed;--success:#059669;--success-light:#d1fae5;--warning:#d97706;--warning-light:#fef3c7;--danger:#dc2626;--danger-light:#fee2e2;--dark:#1e293b;--gray:#64748b;--gray-light:#e2e8f0;--light:#f8fafc;--white:#fff;--border:#cbd5e1;--shadow:0 1px 3px rgba(0,0,0,.1);--shadow-lg:0 4px 12px rgba(0,0,0,.15);--radius:8px;--radius-lg:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--light);min-height:100vh;color:var(--dark)}
.header{background:linear-gradient(135deg,#1e3a5f 0%,#1e40af 50%,#3b82f6 100%);padding:1rem 2rem;color:var(--white);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;box-shadow:var(--shadow-lg)}
.header-left h1{font-size:1.4rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.header-left p{opacity:.9;font-size:.8rem;margin-top:.2rem}
.header-right{display:flex;gap:.5rem;flex-wrap:wrap}
.header-btn{padding:.45rem .9rem;border-radius:var(--radius);border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15);color:var(--white);font-size:.8rem;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:.4rem;transition:all .2s}
.header-btn:hover{background:rgba(255,255,255,.25)}
.nav-tabs{display:flex;background:var(--white);border-bottom:1px solid var(--border);overflow-x:auto;box-shadow:var(--shadow)}
.nav-tab{padding:.8rem 1.1rem;cursor:pointer;border:none;background:none;color:var(--gray);font-size:.82rem;font-weight:500;white-space:nowrap;display:flex;align-items:center;gap:.35rem;border-bottom:3px solid transparent;transition:all .2s}
.nav-tab:hover{background:var(--light);color:var(--primary)}
.nav-tab.active{color:var(--primary);border-bottom-color:var(--primary);background:var(--primary-light)}
.container{max-width:1800px;margin:0 auto;padding:1.25rem}
.tab-content{display:none}.tab-content.active{display:block}
.card{background:var(--white);border-radius:var(--radius-lg);padding:1.25rem;margin-bottom:1.25rem;box-shadow:var(--shadow);border:1px solid var(--gray-light)}
.card-title{font-size:1rem;font-weight:600;margin-bottom:.75rem;color:var(--dark);display:flex;align-items:center;gap:.5rem}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:2.5rem;text-align:center;cursor:pointer;background:var(--light);transition:all .3s}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--primary);background:var(--primary-light)}
.upload-zone h2{font-size:1.3rem;margin-bottom:.4rem;color:var(--dark)}
.upload-zone p{color:var(--gray);margin-bottom:.75rem;font-size:.9rem}
.btn{padding:.55rem 1.1rem;border-radius:var(--radius);border:none;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;transition:all .2s}
.btn-primary{background:var(--primary);color:var(--white)}.btn-primary:hover{background:var(--primary-dark)}
.btn-success{background:var(--success);color:var(--white)}.btn-success:hover{background:#047857}
.btn-warning{background:var(--warning);color:var(--white)}.btn-warning:hover{background:#b45309}
.btn-danger{background:var(--danger);color:var(--white)}
.btn-secondary{background:var(--gray-light);color:var(--dark)}.btn-secondary:hover{background:var(--border)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--gray)}
.btn-outline:hover,.btn-outline.active{background:var(--primary);color:var(--white);border-color:var(--primary)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-sm{padding:.35rem .7rem;font-size:.78rem}
.btn-group{display:flex;gap:.4rem;flex-wrap:wrap}
.progress-container{margin-top:1.25rem}
.progress-bar-outer{background:var(--gray-light);border-radius:999px;height:22px;overflow:hidden;position:relative}
.progress-bar-inner{background:linear-gradient(90deg,var(--primary),var(--secondary));height:100%;width:0;transition:width .1s;border-radius:999px}
.progress-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:600;font-size:.75rem;color:var(--dark)}
.progress-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.75rem;margin-top:.75rem}
.stat-box{background:var(--light);padding:.75rem;border-radius:var(--radius);text-align:center;border:1px solid var(--gray-light)}
.stat-box .value{font-size:1.1rem;font-weight:700;color:var(--primary)}
.stat-box .label{font-size:.7rem;color:var(--gray);margin-top:.2rem}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(145px,1fr));gap:.75rem;margin-bottom:1.25rem}
.kpi-card{padding:1rem;border-radius:var(--radius-lg);text-align:center;color:var(--white);position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:rgba(255,255,255,.1);border-radius:50%;transform:scale(2)}
.kpi-card.total{background:linear-gradient(135deg,#1e40af,#1e3a8a)}
.kpi-card.fatal{background:linear-gradient(135deg,#dc2626,#991b1b)}
.kpi-card.injury-a{background:linear-gradient(135deg,#ea580c,#c2410c)}
.kpi-card.injury-bc{background:linear-gradient(135deg,#d97706,#b45309)}
.kpi-card.pdo{background:linear-gradient(135deg,#0284c7,#0369a1)}
.kpi-card.epdo{background:linear-gradient(135deg,var(--secondary),#5b21b6)}
.kpi-card.ped{background:linear-gradient(135deg,#0891b2,#0e7490)}
.kpi-card.bike{background:linear-gradient(135deg,#059669,#047857)}
.kpi-card .kpi-value{font-size:1.5rem;font-weight:700;position:relative;z-index:1}
.kpi-card .kpi-label{font-size:.72rem;opacity:.9;margin-top:.2rem;position:relative;z-index:1}
.kpi-card .kpi-sub{font-size:.65rem;opacity:.7;position:relative;z-index:1}
.charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:1.25rem}
.chart-card{background:var(--white);border-radius:var(--radius-lg);padding:1rem;box-shadow:var(--shadow);border:1px solid var(--gray-light)}
.chart-card .chart-title{font-size:.9rem;font-weight:600;margin-bottom:.75rem;color:var(--dark)}
.chart-container{height:260px;position:relative}
.filter-panel{background:var(--white);border-radius:var(--radius-lg);padding:1rem;margin-bottom:1.25rem;box-shadow:var(--shadow);border:1px solid var(--gray-light)}
.filter-row{display:flex;flex-wrap:wrap;gap:.75rem;align-items:flex-end}
.filter-group{display:flex;flex-direction:column;gap:.3rem;min-width:130px}
.filter-group label{font-size:.75rem;font-weight:500;color:var(--gray)}
.filter-group select,.filter-group input{padding:.45rem .6rem;border-radius:var(--radius);border:1px solid var(--border);background:var(--white);color:var(--dark);font-size:.82rem}
.filter-group select:focus,.filter-group input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-light)}
.checkbox-group{display:flex;flex-wrap:wrap;gap:.6rem}
.checkbox-item{display:flex;align-items:center;gap:.3rem;font-size:.8rem;cursor:pointer}
.checkbox-item input{width:15px;height:15px;accent-color:var(--primary)}
.table-wrapper{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border)}
.data-table{width:100%;border-collapse:collapse;font-size:.8rem}
.data-table th{background:var(--primary);padding:.6rem;text-align:left;font-weight:600;color:var(--white);position:sticky;top:0;z-index:10}
.data-table th.sortable{cursor:pointer}.data-table th.sortable:hover{background:var(--primary-dark)}
.data-table td{padding:.5rem .6rem;border-bottom:1px solid var(--gray-light);color:var(--dark)}
.data-table tbody tr:hover{background:var(--primary-light)}
.data-table tbody tr:nth-child(even){background:var(--light)}
.severity-badge{display:inline-block;padding:.2rem .45rem;border-radius:4px;font-weight:600;font-size:.7rem;min-width:24px;text-align:center}
.severity-K{background:#dc2626;color:var(--white)}
.severity-A{background:#ea580c;color:var(--white)}
.severity-B{background:#eab308;color:var(--dark)}
.severity-C{background:#22c55e;color:var(--white)}
.severity-O{background:#64748b;color:var(--white)}
.pagination{display:flex;justify-content:center;align-items:center;gap:.4rem;margin-top:.75rem;flex-wrap:wrap}
.page-btn{padding:.4rem .65rem;border:1px solid var(--border);background:var(--white);color:var(--dark);border-radius:var(--radius);cursor:pointer;font-size:.75rem}
.page-btn:hover{background:var(--light);border-color:var(--primary)}
.page-btn.active{background:var(--primary);color:var(--white);border-color:var(--primary)}
.page-btn:disabled{opacity:.5;cursor:not-allowed}
#map{height:550px;border-radius:var(--radius-lg);z-index:1}
.map-container{position:relative}
.map-controls{display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap;align-items:center}
.map-overlay{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.95);padding:.75rem;border-radius:var(--radius);z-index:1000;box-shadow:var(--shadow-lg);min-width:180px;font-size:.8rem}
.map-stat{display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px solid var(--gray-light)}
.map-stat:last-child{border-bottom:none}
.map-stat .val{font-weight:600;color:var(--primary)}
.map-selection-panel{position:absolute;top:10px;left:10px;background:rgba(255,255,255,.98);padding:1rem;border-radius:var(--radius-lg);z-index:1000;box-shadow:var(--shadow-lg);width:320px;max-height:calc(100% - 20px);overflow-y:auto}
.map-selection-panel h4{font-size:.85rem;margin-bottom:.75rem;color:var(--dark);display:flex;align-items:center;gap:.4rem}
.map-search-input{width:100%;padding:.5rem .75rem;border:1px solid var(--border);border-radius:var(--radius);font-size:.8rem;margin-bottom:.5rem}
.map-search-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px var(--primary-light)}
.map-list{max-height:200px;overflow-y:auto;border:1px solid var(--gray-light);border-radius:var(--radius);margin-bottom:.75rem}
.map-list-item{padding:.5rem .75rem;cursor:pointer;font-size:.78rem;border-bottom:1px solid var(--gray-light);display:flex;justify-content:space-between;align-items:center}
.map-list-item:last-child{border-bottom:none}
.map-list-item:hover{background:var(--primary-light)}
.map-list-item.selected{background:var(--primary);color:var(--white)}
.map-list-item .count{font-weight:600;font-size:.7rem;padding:.15rem .4rem;background:var(--gray-light);border-radius:10px}
.map-list-item.selected .count{background:rgba(255,255,255,.3)}
.map-selected-info{background:var(--light);border-radius:var(--radius);padding:.75rem;margin-top:.5rem;font-size:.8rem}
.map-selected-info h5{font-size:.85rem;color:var(--primary);margin-bottom:.5rem}
.map-selected-stats{display:grid;grid-template-columns:1fr 1fr;gap:.4rem}
.map-selected-stat{text-align:center;padding:.4rem;background:var(--white);border-radius:4px}
.map-selected-stat .val{font-weight:700;font-size:1rem;color:var(--primary)}
.map-selected-stat .lbl{font-size:.65rem;color:var(--gray)}
.epdo-card{position:relative;overflow:visible}
.epdo-breakdown{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--white);border-radius:var(--radius);box-shadow:var(--shadow-lg);padding:1rem;min-width:280px;z-index:100;display:none;border:1px solid var(--gray-light)}
.epdo-card:hover .epdo-breakdown{display:block}
.epdo-row{display:flex;justify-content:space-between;align-items:center;padding:.35rem 0;border-bottom:1px solid var(--gray-light);font-size:.8rem}
.epdo-row:last-child{border-bottom:none}
.epdo-row .sev{display:flex;align-items:center;gap:.4rem}
.epdo-row .contrib{font-weight:600}
.epdo-bar{height:6px;background:var(--gray-light);border-radius:3px;margin-top:.25rem;overflow:hidden}
.epdo-bar-fill{height:100%;border-radius:3px}
.epdo-context{font-size:.7rem;color:var(--gray);margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--gray-light)}
.year-badge{font-size:.6rem;background:rgba(255,255,255,.2);padding:.15rem .4rem;border-radius:10px;margin-left:.3rem}
.filter-chip{padding:.35rem .65rem;border-radius:20px;border:1px solid var(--border);background:var(--white);cursor:pointer;font-size:.75rem;display:inline-flex;align-items:center;gap:.2rem;transition:all .2s}
.filter-chip:hover{border-color:var(--primary);color:var(--primary)}
.filter-chip.active{background:var(--primary);color:var(--white);border-color:var(--primary)}
.hotspot-table{width:100%;border-collapse:collapse;font-size:.8rem}
.hotspot-table th{background:var(--primary);color:var(--white);padding:.6rem;text-align:left;cursor:pointer}
.hotspot-table th:hover{background:var(--primary-dark)}
.hotspot-table td{padding:.6rem;border-bottom:1px solid var(--gray-light)}
.hotspot-table tbody tr:hover{background:var(--primary-light);cursor:pointer}
.hotspot-table tbody tr:nth-child(even){background:var(--light)}
.rank-badge{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;background:var(--primary);color:var(--white);border-radius:50%;font-weight:700;font-size:.75rem}
.rank-badge.top3{background:var(--danger)}
.report-container{background:var(--white);border-radius:var(--radius-lg);padding:1.5rem;box-shadow:var(--shadow)}
.report-header{text-align:center;padding-bottom:1.25rem;border-bottom:3px solid var(--primary);margin-bottom:1.25rem}
.report-header h2{font-size:1.3rem;color:var(--primary);margin-bottom:.3rem}
.report-header p{color:var(--gray);font-size:.85rem}
.report-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.75rem;margin-bottom:1.25rem}
.report-kpi{text-align:center;padding:.75rem;background:var(--light);border-radius:var(--radius)}
.report-kpi .value{font-size:1.3rem;font-weight:700;color:var(--primary)}
.report-kpi .label{font-size:.7rem;color:var(--gray)}
.report-section{margin-bottom:1.25rem}
.report-section h4{font-size:.95rem;font-weight:600;margin-bottom:.5rem;color:var(--dark);border-bottom:1px solid var(--gray-light);padding-bottom:.4rem}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center}
.modal.visible{display:flex}
.modal-content{background:var(--white);border-radius:var(--radius-lg);padding:1.5rem;max-width:900px;width:90%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
.modal-header h2{font-size:1.15rem;font-weight:600}
.modal-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--gray)}
.modal-close:hover{color:var(--dark)}
.loading-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);z-index:3000;align-items:center;justify-content:center;flex-direction:column;gap:.75rem}
.loading-overlay.visible{display:flex}
.spinner{width:44px;height:44px;border:4px solid var(--gray-light);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.summary-box{background:var(--success-light);border:1px solid var(--success);border-radius:var(--radius);padding:1.25rem;margin-top:1.25rem}
.summary-box h3{color:var(--success);margin-bottom:.5rem;font-size:1rem}
.summary-box p{color:var(--dark);margin-bottom:.35rem;font-size:.9rem}
.summary-box a{color:var(--primary);font-weight:600}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
.finding-item{padding:.6rem;background:var(--light);border-radius:var(--radius);margin-bottom:.5rem;font-size:.85rem;border-left:3px solid var(--primary)}
.finding-item.warning{border-left-color:var(--warning);background:var(--warning-light)}
.finding-item.danger{border-left-color:var(--danger);background:var(--danger-light)}
@media(max-width:768px){.two-col,.three-col{grid-template-columns:1fr}.charts-grid{grid-template-columns:1fr}}
@media print{.header,.nav-tabs,.filter-panel,.btn-group,.map-controls,.no-print{display:none!important}.card,.report-container{box-shadow:none;border:1px solid #ddd;page-break-inside:avoid}}
.ai-chat-container{display:flex;flex-direction:column;height:600px;background:var(--white);border-radius:var(--radius-lg);border:1px solid var(--gray-light);overflow:hidden}
.ai-chat-header{padding:1rem;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:var(--white)}
.ai-chat-header h3{font-size:1rem;margin-bottom:.25rem}
.ai-chat-header p{font-size:.75rem;opacity:.9}
.ai-chat-messages{flex:1;overflow-y:auto;padding:1rem;background:var(--light)}
.ai-message{display:flex;gap:.75rem;margin-bottom:1rem;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ai-message.user{flex-direction:row-reverse}
.ai-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.ai-message.assistant .ai-avatar{background:linear-gradient(135deg,#667eea,#764ba2);color:var(--white)}
.ai-message.user .ai-avatar{background:var(--primary);color:var(--white)}
.ai-bubble{max-width:75%;padding:.85rem 1rem;border-radius:var(--radius-lg);font-size:.875rem;line-height:1.6}
.ai-message.assistant .ai-bubble{background:var(--white);border:1px solid var(--gray-light);border-bottom-left-radius:4px}
.ai-message.user .ai-bubble{background:var(--primary);color:var(--white);border-bottom-right-radius:4px}
.ai-bubble p{margin-bottom:.5rem}
.ai-bubble p:last-child{margin-bottom:0}
.ai-bubble ul,.ai-bubble ol{margin:.5rem 0 .5rem 1.25rem}
.ai-bubble li{margin-bottom:.25rem}
.ai-bubble strong{font-weight:600}
.ai-bubble code{background:rgba(0,0,0,.08);padding:.15rem .35rem;border-radius:4px;font-family:monospace;font-size:.8rem}
.ai-typing{display:flex;gap:4px;padding:.5rem}
.ai-typing span{width:8px;height:8px;background:var(--gray);border-radius:50%;animation:typing 1.4s infinite}
.ai-typing span:nth-child(2){animation-delay:.2s}
.ai-typing span:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-8px)}}
.ai-chat-input{padding:1rem;background:var(--white);border-top:1px solid var(--gray-light)}
.ai-input-row{display:flex;gap:.5rem;align-items:flex-end}
.ai-input-wrapper{flex:1;position:relative}
.ai-textarea{width:100%;min-height:60px;max-height:150px;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);resize:none;font-family:inherit;font-size:.875rem;line-height:1.5}
.ai-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.ai-attachments{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
.ai-attachment{display:flex;align-items:center;gap:.35rem;padding:.35rem .6rem;background:var(--light);border:1px solid var(--border);border-radius:var(--radius);font-size:.75rem}
.ai-attachment img{width:32px;height:32px;object-fit:cover;border-radius:4px}
.ai-attachment .remove{cursor:pointer;color:var(--danger);font-weight:bold;margin-left:.25rem}
.ai-controls{display:flex;gap:.5rem;margin-bottom:.75rem;flex-wrap:wrap;align-items:center}
.ai-provider-select{padding:.45rem .75rem;border:1px solid var(--border);border-radius:var(--radius);font-size:.8rem;background:var(--white)}
.ai-key-input{padding:.45rem .75rem;border:1px solid var(--border);border-radius:var(--radius);font-size:.8rem;width:200px}
.ai-btn{padding:.6rem 1.25rem;border:none;border-radius:var(--radius);font-weight:600;cursor:pointer;display:flex;align-items:center;gap:.35rem;font-size:.85rem;transition:all .2s}
.ai-btn-send{background:linear-gradient(135deg,#667eea,#764ba2);color:var(--white)}
.ai-btn-send:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,.4)}
.ai-btn-send:disabled{opacity:.6;cursor:not-allowed;transform:none}
.ai-btn-attach{background:var(--light);border:1px solid var(--border);color:var(--gray)}
.ai-btn-attach:hover{background:var(--gray-light)}
.ai-suggestions{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
.ai-suggestion{padding:.4rem .75rem;background:var(--primary-light);color:var(--primary);border:none;border-radius:20px;font-size:.75rem;cursor:pointer;transition:all .2s}
.ai-suggestion:hover{background:var(--primary);color:var(--white)}
.ai-data-badge{display:inline-flex;align-items:center;gap:.25rem;padding:.2rem .5rem;background:var(--success-light);color:var(--success);border-radius:20px;font-size:.7rem;font-weight:600}
.ai-error{padding:.75rem;background:var(--danger-light);color:var(--danger);border-radius:var(--radius);font-size:.85rem;margin-top:.5rem}
/* Modal Styles */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9998;justify-content:center;align-items:center;padding:1rem}
.modal-overlay.visible{display:flex}
.modal-content{background:var(--white);border-radius:16px;max-width:900px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.modal-header{padding:1.25rem 1.5rem;border-bottom:1px solid var(--gray-light);display:flex;justify-content:space-between;align-items:center;background:var(--primary);color:white;border-radius:16px 16px 0 0}
.modal-header h3{font-size:1.2rem;margin:0}
.modal-close{background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;padding:0.25rem;line-height:1}
.modal-close:hover{opacity:0.8}
.modal-body{padding:1.5rem}
.modal-kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
.modal-kpi{padding:1rem;border-radius:12px;text-align:center;color:white}
.modal-kpi.blue{background:linear-gradient(135deg,#1e40af,#3b82f6)}
.modal-kpi.red{background:linear-gradient(135deg,#dc2626,#ef4444)}
.modal-kpi.purple{background:linear-gradient(135deg,#7c3aed,#8b5cf6)}
.modal-kpi.cyan{background:linear-gradient(135deg,#0891b2,#06b6d4)}
.modal-kpi.green{background:linear-gradient(135deg,#059669,#10b981)}
.modal-kpi-value{font-size:2rem;font-weight:700}
.modal-kpi-label{font-size:.85rem;opacity:.9}
.metric-row{display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid var(--gray-light)}
.metric-row:last-child{border-bottom:none}
.metric-value{font-weight:600;color:var(--primary)}
.btn-details{padding:.35rem .75rem;background:var(--white);border:1px solid var(--primary);color:var(--primary);border-radius:6px;font-size:.75rem;cursor:pointer;transition:all .2s}
.btn-details:hover{background:var(--primary);color:var(--white)}
</style>
</head>
<body>
<div class="header">
<div class="header-left">
<h1>ğŸš— Crash Analysis System</h1>
<p>Henrico County Traffic Engineering Division</p>
</div>
<div class="header-right">
<button class="header-btn" onclick="saveSession()">ğŸ’¾ Save</button>
<button class="header-btn" onclick="document.getElementById('loadSessionInput').click()">ğŸ“‚ Load</button>
<input type="file" id="loadSessionInput" accept=".json" style="display:none" onchange="loadSession(event)">
<button class="header-btn" onclick="window.print()">ğŸ–¨ï¸ Print</button>
</div>
</div>
<nav class="nav-tabs">
<button class="nav-tab active" data-tab="upload">ğŸ“Š Data</button>
<button class="nav-tab" data-tab="dashboard">ğŸ“ˆ Dashboard</button>
<button class="nav-tab" data-tab="map">ğŸ—ºï¸ Map</button>
<button class="nav-tab" data-tab="hotspots">ğŸ”¥ Hot Spots</button>
<button class="nav-tab" data-tab="analysis">ğŸ“ˆ Analysis</button>
<button class="nav-tab" data-tab="intersection">ğŸš¦ Intersections</button>
<button class="nav-tab" data-tab="pedestrian">ğŸš¶ Ped/Bike</button>
<button class="nav-tab" data-tab="search">ğŸ” Search</button>
<button class="nav-tab" data-tab="reports">ğŸ“‹ Reports</button>
<button class="nav-tab" data-tab="cmf">ğŸ’¡ Countermeasures</button>
<button class="nav-tab" data-tab="ai">ğŸ¤– AI Analyst</button>
</nav>
<div class="container">
<!-- UPLOAD TAB - Now shows data status -->
<div id="tab-upload" class="tab-content active">
<div class="card">
<div class="card-title">ğŸ“Š Crash Data Status</div>
<div class="upload-zone" id="uploadZone" style="cursor:default">
<div style="font-size:2.5rem;margin-bottom:.5rem">ğŸ”„</div>
<h2 id="loadingTitle">Loading Crash Data...</h2>
<p id="loadingSubtitle">Fetching data from server</p>
</div>
<div class="progress-container" id="progressContainer">
<div class="progress-bar-outer"><div class="progress-bar-inner" id="progressBar"></div><span class="progress-text" id="progressText">0%</span></div>
<div class="progress-stats">
<div class="stat-box"><div class="value" id="statRows">0</div><div class="label">Rows Processed</div></div>
<div class="stat-box"><div class="value" id="statSpeed">0</div><div class="label">Rows/Second</div></div>
<div class="stat-box"><div class="value" id="statElapsed">0s</div><div class="label">Elapsed</div></div>
</div>
</div>
<div class="summary-box" id="uploadSummary" style="display:none">
<h3>âœ… Data Loaded Successfully</h3>
<p><strong id="summaryTotal">0</strong> crash records</p>
<p>Years: <strong id="summaryYears">--</strong></p>
<p>Routes: <strong id="summaryRoutes">0</strong> unique corridors</p>
<p style="margin-top:.75rem"><a href="#" onclick="showTab('dashboard');return false">â†’ Go to Dashboard</a></p>
</div>
<div id="loadError" style="display:none;padding:1.5rem;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin-top:1rem">
<h3 style="color:#dc2626;margin-bottom:.5rem">âŒ Error Loading Data</h3>
<p id="errorMessage" style="color:#7f1d1d"></p>
<p style="margin-top:.75rem;font-size:.85rem;color:#6b7280">Make sure the CSV file exists at: <code>data/crashes.csv</code></p>
<button class="btn btn-primary" onclick="loadDataFromServer()" style="margin-top:.75rem">ğŸ”„ Retry</button>
</div>
</div>
</div>
<!-- DASHBOARD TAB -->
<div id="tab-dashboard" class="tab-content">
<div class="filter-panel" id="globalFilters">
<div class="filter-row">
<div class="filter-group"><label>Start Year</label><select id="filterStartYear"><option value="">All</option></select></div>
<div class="filter-group"><label>End Year</label><select id="filterEndYear"><option value="">All</option></select></div>
<div class="filter-group"><label>Route/Corridor</label><select id="filterRoute"><option value="">All Routes</option></select></div>
<div class="filter-group"><label>Intersection Type</label><select id="filterIntersection"><option value="">All</option></select></div>
<div class="filter-group" style="flex-direction:row;align-items:flex-end;gap:.4rem">
<button class="btn btn-primary btn-sm" onclick="applyFilters()">Apply</button>
<button class="btn btn-secondary btn-sm" onclick="resetFilters()">Reset</button>
</div>
</div>
<div style="margin-top:.6rem">
<label style="font-size:.75rem;font-weight:500;color:var(--gray);margin-right:.4rem">Severity:</label>
<div class="checkbox-group" style="display:inline-flex">
<label class="checkbox-item"><input type="checkbox" id="sevK" checked> K-Fatal</label>
<label class="checkbox-item"><input type="checkbox" id="sevA" checked> A-Serious</label>
<label class="checkbox-item"><input type="checkbox" id="sevB" checked> B-Minor</label>
<label class="checkbox-item"><input type="checkbox" id="sevC" checked> C-Possible</label>
<label class="checkbox-item"><input type="checkbox" id="sevO" checked> O-PDO</label>
</div>
</div>
</div>
<div class="kpi-grid" id="dashboardKPIs">
<div class="kpi-card total"><div class="kpi-value" id="kpiTotal">0</div><div class="kpi-label">Total Crashes</div><div class="kpi-sub" id="kpiYearRange"></div></div>
<div class="kpi-card fatal"><div class="kpi-value" id="kpiFatal">0</div><div class="kpi-label">Fatal (K)</div><div class="kpi-sub" id="kpiFatalPct">0%</div></div>
<div class="kpi-card injury-a"><div class="kpi-value" id="kpiInjuryA">0</div><div class="kpi-label">Serious Injury (A)</div><div class="kpi-sub" id="kpiAPct">0%</div></div>
<div class="kpi-card injury-bc"><div class="kpi-value" id="kpiInjuryBC">0</div><div class="kpi-label">Other Injury (B+C)</div></div>
<div class="kpi-card pdo"><div class="kpi-value" id="kpiPDO">0</div><div class="kpi-label">PDO (O)</div></div>
<div class="kpi-card epdo epdo-card"><div class="kpi-value" id="kpiEPDO">0</div><div class="kpi-label">Total EPDO</div><div class="kpi-sub" id="kpiEPDOAvg">Hover for breakdown</div>
<div class="epdo-breakdown" id="epdoBreakdown">
<div style="font-weight:600;margin-bottom:.5rem;color:var(--dark)">ğŸ“Š EPDO Breakdown</div>
<div class="epdo-row"><span class="sev"><span class="severity-badge severity-K">K</span> Fatal</span><span id="epdoK">0</span><span class="contrib" id="epdoKPct">0%</span></div>
<div class="epdo-bar"><div class="epdo-bar-fill" id="epdoKBar" style="background:#dc2626;width:0%"></div></div>
<div class="epdo-row"><span class="sev"><span class="severity-badge severity-A">A</span> Serious</span><span id="epdoA">0</span><span class="contrib" id="epdoAPct">0%</span></div>
<div class="epdo-bar"><div class="epdo-bar-fill" id="epdoABar" style="background:#ea580c;width:0%"></div></div>
<div class="epdo-row"><span class="sev"><span class="severity-badge severity-B">B</span> Minor</span><span id="epdoB">0</span><span class="contrib" id="epdoBPct">0%</span></div>
<div class="epdo-bar"><div class="epdo-bar-fill" id="epdoBBar" style="background:#eab308;width:0%"></div></div>
<div class="epdo-row"><span class="sev"><span class="severity-badge severity-C">C</span> Possible</span><span id="epdoC">0</span><span class="contrib" id="epdoCPct">0%</span></div>
<div class="epdo-bar"><div class="epdo-bar-fill" id="epdoCBar" style="background:#22c55e;width:0%"></div></div>
<div class="epdo-row"><span class="sev"><span class="severity-badge severity-O">O</span> PDO</span><span id="epdoO">0</span><span class="contrib" id="epdoOPct">0%</span></div>
<div class="epdo-bar"><div class="epdo-bar-fill" id="epdoOBar" style="background:#64748b;width:0%"></div></div>
<div class="epdo-context">
<div><strong>Annual Avg:</strong> <span id="epdoAnnual">0</span></div>
<div><strong>Per 100 Crashes:</strong> <span id="epdoPer100">0</span></div>
<div style="margin-top:.25rem;font-style:italic">Weights: K=462, A=62, B=12, C=5, O=1</div>
</div>
</div>
</div>
<div class="kpi-card ped"><div class="kpi-value" id="kpiPed">0</div><div class="kpi-label">Pedestrian</div><div class="kpi-sub" id="kpiPedPct">0%</div></div>
<div class="kpi-card bike"><div class="kpi-value" id="kpiBike">0</div><div class="kpi-label">Bicycle</div><div class="kpi-sub" id="kpiBikePct">0%</div></div>
</div>
<div class="charts-grid">
<div class="chart-card"><div class="chart-title">ğŸ“Š Severity Distribution</div><div style="display:flex;align-items:center;gap:1.5rem;padding:.75rem"><div style="width:160px;height:160px;flex-shrink:0"><canvas id="chartSeverity"></canvas></div><div id="legendSeverity" style="font-size:.8rem;line-height:1.9;flex:1"></div></div></div>
<div class="chart-card"><div class="chart-title">ğŸ“… Crashes by Year</div><div class="chart-container"><canvas id="chartYear"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸ’¥ Collision Types (Top 10)</div><div class="chart-container"><canvas id="chartCollision"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸ• Time of Day Distribution</div><div class="chart-container"><canvas id="chartTimeOfDay"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸŒ§ï¸ Weather Conditions</div><div style="display:flex;align-items:center;gap:1.5rem;padding:.75rem"><div style="width:160px;height:160px;flex-shrink:0"><canvas id="chartWeather"></canvas></div><div id="legendWeather" style="font-size:.8rem;line-height:1.9;flex:1"></div></div></div>
<div class="chart-card"><div class="chart-title">ğŸ’¡ Light Conditions</div><div style="display:flex;align-items:center;gap:1.5rem;padding:.75rem"><div style="width:160px;height:160px;flex-shrink:0"><canvas id="chartLight"></canvas></div><div id="legendLight" style="font-size:.8rem;line-height:1.9;flex:1"></div></div></div>
<div class="chart-card"><div class="chart-title">âš–ï¸ EPDO Breakdown</div><div style="display:flex;align-items:center;gap:1.5rem;padding:.75rem"><div style="width:160px;height:160px;flex-shrink:0"><canvas id="chartEPDO"></canvas></div><div id="legendEPDO" style="font-size:.8rem;line-height:1.9;flex:1"></div></div></div>
<div class="chart-card"><div class="chart-title">ğŸ“ˆ EPDO by Year</div><div class="chart-container"><canvas id="chartEPDOYear"></canvas></div></div>
</div>
</div>
<!-- MAP TAB -->
<div id="tab-map" class="tab-content">
<div class="card">
<div class="card-title">ğŸ—ºï¸ Crash Location Map</div>
<div class="map-controls">
<button class="btn btn-outline active" id="btnCluster" onclick="setMapMode('cluster')">ğŸ“ Clusters</button>
<button class="btn btn-outline" id="btnHeat" onclick="setMapMode('heat')">ğŸ”¥ Heatmap</button>
<button class="btn btn-outline" id="btnMarkers" onclick="setMapMode('markers')">âš« Markers</button>
<span style="margin-left:.75rem;color:var(--gray);font-size:.8rem">Filters:</span>
<span class="filter-chip" data-filter="fatal" onclick="toggleMapFilter(this)">ğŸ’€ Fatal</span>
<span class="filter-chip" data-filter="serious" onclick="toggleMapFilter(this)">ğŸ©¹ K+A</span>
<span class="filter-chip" data-filter="ped" onclick="toggleMapFilter(this)">ğŸš¶ Ped</span>
<span class="filter-chip" data-filter="bike" onclick="toggleMapFilter(this)">ğŸš´ Bike</span>
<span class="filter-chip" data-filter="intersection" onclick="toggleMapFilter(this)">ğŸš¦ Intersection</span>
<select id="mapYearFilter" onchange="updateMapDisplay()" style="margin-left:auto;padding:.35rem;border-radius:var(--radius);border:1px solid var(--border);font-size:.8rem"><option value="">All Years</option></select>
</div>
<div class="map-container" style="position:relative">
<div id="map"></div>
<!-- Selection Panel -->
<div class="map-selection-panel" id="mapSelectionPanel">
<h4>ğŸ“ Select Location</h4>
<div style="display:flex;gap:.5rem;margin-bottom:.75rem">
<button class="btn btn-sm btn-outline active" id="btnSelectRoute" onclick="setSelectionMode('route')">ğŸ›£ï¸ Routes</button>
<button class="btn btn-sm btn-outline" id="btnSelectNode" onclick="setSelectionMode('node')">ğŸš¦ Intersections</button>
</div>
<input type="text" class="map-search-input" id="mapSearchInput" placeholder="Search routes or intersections..." oninput="filterMapList()">
<div class="map-list" id="mapList"></div>
<div class="map-selected-info" id="mapSelectedInfo" style="display:none">
<h5 id="selectedLocationName">--</h5>
<div class="map-selected-stats">
<div class="map-selected-stat"><div class="val" id="selTotal">0</div><div class="lbl">Total</div></div>
<div class="map-selected-stat"><div class="val" id="selFatal">0</div><div class="lbl">Fatal</div></div>
<div class="map-selected-stat"><div class="val" id="selKA">0</div><div class="lbl">K+A</div></div>
<div class="map-selected-stat"><div class="val" id="selEPDO">0</div><div class="lbl">EPDO</div></div>
</div>
<div style="margin-top:.5rem">
<button class="btn btn-sm btn-primary" onclick="generateLocationReport()">ğŸ“‹ Report</button>
<button class="btn btn-sm btn-secondary" onclick="clearMapSelection()">âœ• Clear</button>
</div>
</div>
<div style="margin-top:.5rem;font-size:.7rem;color:var(--gray)">
<label style="display:flex;align-items:center;gap:.3rem;cursor:pointer">
<input type="checkbox" id="mapShowLabels" onchange="toggleMapLabels()"> Show route labels
</label>
</div>
</div>
<!-- Stats Overlay -->
<div class="map-overlay" id="mapOverlay">
<div class="map-stat"><span>Showing:</span><span class="val" id="mapCount">0</span></div>
<div class="map-stat"><span>Fatal:</span><span class="val" id="mapFatal">0</span></div>
<div class="map-stat"><span>Serious (A):</span><span class="val" id="mapSerious">0</span></div>
<div class="map-stat"><span>EPDO:</span><span class="val" id="mapEPDO">0</span></div>
<div class="map-stat" style="margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--gray-light)"><span>Selected:</span><span class="val" id="mapSelected">None</span></div>
</div>
</div>
</div>
</div>
<!-- HOTSPOTS TAB -->
<div id="tab-hotspots" class="tab-content">
<div class="card">
<div class="card-title">ğŸ”¥ High-Crash Locations Analysis</div>
<div class="filter-row" style="margin-bottom:.75rem">
<div class="filter-group"><label>Min Crashes</label><input type="number" id="hsMinCrashes" value="5" min="1"></div>
<div class="filter-group"><label>Top N</label><input type="number" id="hsTopN" value="25" min="5" max="100"></div>
<div class="filter-group"><label>Sort By</label><select id="hsSortBy"><option value="epdo">EPDO Score</option><option value="total">Total Crashes</option><option value="ka">K+A Crashes</option><option value="rate">Crash Rate/Year</option></select></div>
<div class="filter-group"><label>Group By</label><select id="hsGroupBy"><option value="route">Route Name</option><option value="node">Intersection Node</option></select></div>
<div class="filter-group" style="flex-direction:row;align-items:flex-end"><button class="btn btn-primary btn-sm" onclick="analyzeHotspots()">ğŸ” Analyze</button></div>
</div>
<div class="table-wrapper" style="max-height:480px;overflow-y:auto">
<table class="hotspot-table" id="hotspotTable">
<thead><tr><th style="width:50px">Rank</th><th>Location</th><th>Total</th><th>K</th><th>A</th><th>B</th><th>C</th><th>O</th><th>EPDO</th><th>Per Year</th><th>Top Type</th><th style="width:70px">Action</th></tr></thead>
<tbody id="hotspotBody"></tbody>
</table>
</div>
<div class="btn-group" style="margin-top:.75rem">
<button class="btn btn-success btn-sm" onclick="exportHotspotsCSV()">ğŸ“¥ Export CSV</button>
<button class="btn btn-warning btn-sm" onclick="exportHotspotsPDF()">ğŸ“„ Export PDF</button>
<button class="btn btn-primary btn-sm" onclick="generateHotspotReport()">ğŸ“‹ Full Report</button>
</div>
</div>
</div>
<!-- ANALYSIS TAB -->
<div id="tab-analysis" class="tab-content">
<div class="card">
<div class="card-title">ğŸ“ˆ Yearly Crash Summary</div>
<div class="table-wrapper">
<table class="data-table" id="yearlyTable">
<thead><tr><th>Year</th><th>Total</th><th>K</th><th>A</th><th>B</th><th>C</th><th>O</th><th>EPDO</th><th>K+A Rate</th><th>Ped</th><th>Bike</th><th>YoY Change</th></tr></thead>
<tbody id="yearlyBody"></tbody>
</table>
</div>
</div>
<div class="charts-grid">
<div class="chart-card"><div class="chart-title">ğŸ“‰ Year-over-Year Change</div><div class="chart-container"><canvas id="chartYoY"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸ“Š K+A Crashes by Year</div><div class="chart-container"><canvas id="chartKAYear"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸ“… Day of Week Distribution</div><div class="chart-container"><canvas id="chartDOW"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸ“† Monthly Distribution</div><div class="chart-container"><canvas id="chartMonth"></canvas></div></div>
</div>
<div class="card">
<div class="card-title">ğŸ›£ï¸ Functional Class Distribution</div>
<div class="two-col">
<div class="chart-container" style="height:280px"><canvas id="chartFuncClass"></canvas></div>
<div class="table-wrapper" style="max-height:280px;overflow-y:auto">
<table class="data-table" id="funcClassTable"><thead><tr><th>Functional Class</th><th>Total</th><th>K</th><th>A</th><th>EPDO</th><th>%</th></tr></thead><tbody id="funcClassBody"></tbody></table>
</div>
</div>
</div>
</div>
<!-- INTERSECTION TAB -->
<div id="tab-intersection" class="tab-content">
<div class="kpi-grid">
<div class="kpi-card total"><div class="kpi-value" id="intTotal">0</div><div class="kpi-label">Intersection Crashes</div></div>
<div class="kpi-card fatal"><div class="kpi-value" id="intFatal">0</div><div class="kpi-label">Fatal at Intersections</div></div>
<div class="kpi-card injury-a"><div class="kpi-value" id="intSerious">0</div><div class="kpi-label">Serious Injury (A)</div></div>
<div class="kpi-card epdo"><div class="kpi-value" id="intPct">0%</div><div class="kpi-label">% of All Crashes</div></div>
</div>
<div class="charts-grid">
<div class="chart-card"><div class="chart-title">ğŸš¦ Intersection Type Distribution</div><div class="chart-container"><canvas id="chartIntType"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸš¥ Traffic Control Type</div><div style="display:flex;align-items:center;gap:1.5rem;padding:.75rem"><div style="width:160px;height:160px;flex-shrink:0"><canvas id="chartTrafficControl"></canvas></div><div id="legendTrafficControl" style="font-size:.8rem;line-height:1.9;flex:1"></div></div></div>
<div class="chart-card"><div class="chart-title">ğŸ’¥ Collision Types at Intersections</div><div class="chart-container"><canvas id="chartIntCollision"></canvas></div></div>
<div class="chart-card"><div class="chart-title">ğŸ“Š Intersection vs Non-Intersection by Severity</div><div class="chart-container"><canvas id="chartIntSeverity"></canvas></div></div>
</div>
<div class="card">
<div class="card-title">ğŸ” Top Intersection Crash Locations</div>
<div class="table-wrapper" style="max-height:350px;overflow-y:auto">
<table class="data-table" id="intTable"><thead><tr><th>Node/Intersection</th><th>Route</th><th>Total</th><th>K</th><th>A</th><th>EPDO</th><th>Control Type</th></tr></thead><tbody id="intBody"></tbody></table>
</div>
</div>
</div>
<!-- PEDESTRIAN/BICYCLE TAB -->
<div id="tab-pedestrian" class="tab-content">
<!-- People Injury Analysis Section -->
<div class="card" style="background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border:none">
<div style="text-align:center;margin-bottom:1rem">
<div style="color:#dc2626;font-size:.85rem;margin-bottom:.5rem">âš ï¸ Information on this page reflects the number of <strong>people</strong> killed or injured, NOT the number of crash collisions. One crash may involve multiple people.</div>
<div class="filter-group" style="display:inline-flex;align-items:center;gap:.5rem">
<label style="font-weight:600;color:var(--primary)">People Injury Type:</label>
<select id="peopleInjuryFilter" onchange="updatePeopleAnalysis()" style="padding:.5rem 1rem;border-radius:var(--radius);border:1px solid var(--primary);font-size:.9rem;font-weight:500">
<option value="all">All Injuries</option>
<option value="K">K. Fatality</option>
<option value="A">A. Serious Injury</option>
<option value="B">B. Minor Injury</option>
<option value="C">C. Possible Injury</option>
</select>
</div>
</div>
<div class="two-col">
<!-- People Type Donut Chart -->
<div class="chart-card" style="background:var(--white);position:relative">
<div class="chart-title" style="text-align:center">ğŸ‘¥ People Injured by Type</div>
<div style="display:flex;align-items:center;justify-content:center;gap:2rem;padding:1rem">
<div style="position:relative;width:280px;height:280px">
<canvas id="chartPeopleType"></canvas>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none">
<div style="font-size:2.5rem;font-weight:700;color:#1e40af" id="peopleTotalNum">0</div>
<div style="font-size:.85rem;color:#64748b;font-weight:500">Total People</div>
</div>
</div>
<div id="peopleTypeLegend" style="font-size:.85rem;line-height:2"></div>
</div>
</div>
<!-- People by Year Bar Chart -->
<div class="chart-card" style="background:var(--white)">
<div class="chart-title" style="text-align:center">ğŸ“… People Killed/Injured by Year</div>
<div class="chart-container" style="height:300px"><canvas id="chartPeopleYear"></canvas></div>
</div>
</div>
</div>
<!-- Contributing Factors Section -->
<div class="card">
<div class="card-title">âš ï¸ Contributing Factors Analysis</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem">
<div class="chart-card" style="padding:1rem;background:var(--white);border:1px solid var(--gray-light)">
<div style="text-align:center;font-size:.9rem;font-weight:700;color:#dc2626;margin-bottom:.75rem;text-transform:uppercase">Speeding</div>
<div style="display:flex;align-items:center;gap:1rem">
<div style="width:110px;height:110px;flex-shrink:0"><canvas id="chartFactorSpeed"></canvas></div>
<div id="legendFactorSpeed" style="font-size:.75rem;line-height:1.7;flex:1"></div>
</div>
<div style="text-align:center;font-size:.7rem;color:var(--gray);margin-top:.5rem;font-style:italic">N/A for Pedestrians</div>
</div>
<div class="chart-card" style="padding:1rem;background:var(--white);border:1px solid var(--gray-light)">
<div style="text-align:center;font-size:.9rem;font-weight:700;color:#dc2626;margin-bottom:.75rem;text-transform:uppercase">Unrestrained</div>
<div style="display:flex;align-items:center;gap:1rem">
<div style="width:110px;height:110px;flex-shrink:0"><canvas id="chartFactorBelt"></canvas></div>
<div id="legendFactorBelt" style="font-size:.75rem;line-height:1.7;flex:1"></div>
</div>
<div style="text-align:center;font-size:.7rem;color:var(--gray);margin-top:.5rem;font-style:italic">N/A for Pedestrians</div>
</div>
<div class="chart-card" style="padding:1rem;background:var(--white);border:1px solid var(--gray-light)">
<div style="text-align:center;font-size:.9rem;font-weight:700;color:#dc2626;margin-bottom:.75rem;text-transform:uppercase">Alcohol</div>
<div style="display:flex;align-items:center;gap:1rem">
<div style="width:110px;height:110px;flex-shrink:0"><canvas id="chartFactorAlcohol"></canvas></div>
<div id="legendFactorAlcohol" style="font-size:.75rem;line-height:1.7;flex:1"></div>
</div>
<div style="text-align:center;font-size:.7rem;color:var(--gray);margin-top:.5rem;font-style:italic">N/A for Passengers</div>
</div>
<div class="chart-card" style="padding:1rem;background:var(--white);border:1px solid var(--gray-light)">
<div style="text-align:center;font-size:.9rem;font-weight:700;color:#dc2626;margin-bottom:.75rem;text-transform:uppercase">Distracted</div>
<div style="display:flex;align-items:center;gap:1rem">
<div style="width:110px;height:110px;flex-shrink:0"><canvas id="chartFactorDistracted"></canvas></div>
<div id="legendFactorDistracted" style="font-size:.75rem;line-height:1.7;flex:1"></div>
</div>
<div style="text-align:center;font-size:.7rem;color:var(--gray);margin-top:.5rem;font-style:italic">N/A for Passengers & Pedestrians</div>
</div>
<div class="chart-card" style="padding:1rem;background:var(--white);border:1px solid var(--gray-light)">
<div style="text-align:center;font-size:.9rem;font-weight:700;color:#0891b2;margin-bottom:.75rem;text-transform:uppercase">Age Group</div>
<div style="display:flex;align-items:center;gap:1rem">
<div style="width:110px;height:110px;flex-shrink:0"><canvas id="chartFactorAge"></canvas></div>
<div id="legendFactorAge" style="font-size:.75rem;line-height:1.7;flex:1"></div>
</div>
<div style="text-align:center;font-size:.7rem;color:var(--gray);margin-top:.5rem;font-style:italic">Senior: â‰¥65 | Young: 15-20</div>
</div>
<div class="chart-card" style="padding:1rem;background:var(--white);border:1px solid var(--gray-light)">
<div style="text-align:center;font-size:.9rem;font-weight:700;color:#0891b2;margin-bottom:.75rem;text-transform:uppercase">User Type</div>
<div style="display:flex;align-items:center;gap:1rem">
<div style="width:110px;height:110px;flex-shrink:0"><canvas id="chartFactorUserType"></canvas></div>
<div id="legendFactorUserType" style="font-size:.75rem;line-height:1.7;flex:1"></div>
</div>
<div style="text-align:center;font-size:.7rem;color:var(--gray);margin-top:.5rem;font-style:italic">Driver / Pedestrian / Passenger</div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- ğŸš¶ PEDESTRIAN CRASHES SECTION -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card" style="border-left:4px solid #0891b2;background:linear-gradient(to right,#f0fdfa,#fff)">
<div class="card-title" style="font-size:1.1rem;color:#0891b2">ğŸš¶ Pedestrian Crash Analysis</div>
<div class="kpi-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:1rem">
<div class="kpi-card" style="background:linear-gradient(135deg,#0891b2,#06b6d4)"><div class="kpi-value" id="pedTotal">0</div><div class="kpi-label">Total Crashes</div></div>
<div class="kpi-card fatal"><div class="kpi-value" id="pedFatal">0</div><div class="kpi-label">Fatal (K)</div></div>
<div class="kpi-card injury-a"><div class="kpi-value" id="pedKA">0</div><div class="kpi-label">Serious (K+A)</div></div>
<div class="kpi-card" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6)"><div class="kpi-value" id="pedEPDO">0</div><div class="kpi-label">EPDO Score</div></div>
<div class="kpi-card" style="background:linear-gradient(135deg,#475569,#64748b)"><div class="kpi-value" id="pedKARate">0%</div><div class="kpi-label">K+A Rate</div></div>
</div>
<div class="chart-card" style="margin-bottom:1rem">
<div class="chart-title">ğŸ“ˆ Pedestrian Crashes by Year</div>
<div class="chart-container" style="height:220px"><canvas id="chartPedYear"></canvas></div>
</div>
<div class="two-col" style="gap:1.5rem">
<div class="chart-card">
<div class="chart-title">ğŸ’¡ Pedestrian Crashes by Light Condition</div>
<div style="display:flex;align-items:center;gap:1.5rem;padding:1rem">
<div style="width:220px;height:220px"><canvas id="chartPedLight"></canvas></div>
<div id="pedLightLegend" style="font-size:.85rem;line-height:1.8"></div>
</div>
</div>
<div>
<div class="chart-card">
<div class="chart-title" style="display:flex;justify-content:space-between;align-items:center">
<span>ğŸ“ Top Pedestrian Crash Locations</span>
<select id="pedYearFilter" onchange="updatePedLocations()" style="padding:.35rem .5rem;border-radius:6px;border:1px solid var(--border);font-size:.8rem">
<option value="">All Years</option>
</select>
</div>
<div class="table-wrapper" style="max-height:280px;overflow-y:auto">
<table class="data-table">
<thead><tr><th>Route</th><th>Total</th><th>K</th><th>A</th><th>EPDO</th><th>Action</th></tr></thead>
<tbody id="pedRouteBody"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- ğŸš´ BICYCLE CRASHES SECTION -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card" style="border-left:4px solid #059669;background:linear-gradient(to right,#f0fdf4,#fff)">
<div class="card-title" style="font-size:1.1rem;color:#059669">ğŸš´ Bicycle Crash Analysis</div>
<div class="kpi-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:1rem">
<div class="kpi-card" style="background:linear-gradient(135deg,#059669,#10b981)"><div class="kpi-value" id="bikeTotal">0</div><div class="kpi-label">Total Crashes</div></div>
<div class="kpi-card fatal"><div class="kpi-value" id="bikeFatal">0</div><div class="kpi-label">Fatal (K)</div></div>
<div class="kpi-card injury-a"><div class="kpi-value" id="bikeKA">0</div><div class="kpi-label">Serious (K+A)</div></div>
<div class="kpi-card" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6)"><div class="kpi-value" id="bikeEPDO">0</div><div class="kpi-label">EPDO Score</div></div>
<div class="kpi-card" style="background:linear-gradient(135deg,#475569,#64748b)"><div class="kpi-value" id="bikeKARate">0%</div><div class="kpi-label">K+A Rate</div></div>
</div>
<div class="chart-card" style="margin-bottom:1rem">
<div class="chart-title">ğŸ“ˆ Bicycle Crashes by Year</div>
<div class="chart-container" style="height:220px"><canvas id="chartBikeYear"></canvas></div>
</div>
<div class="two-col" style="gap:1.5rem">
<div class="chart-card">
<div class="chart-title">ğŸ’¡ Bicycle Crashes by Light Condition</div>
<div style="display:flex;align-items:center;gap:1.5rem;padding:1rem">
<div style="width:220px;height:220px"><canvas id="chartBikeLight"></canvas></div>
<div id="bikeLightLegend" style="font-size:.85rem;line-height:1.8"></div>
</div>
</div>
<div>
<div class="chart-card">
<div class="chart-title" style="display:flex;justify-content:space-between;align-items:center">
<span>ğŸ“ Top Bicycle Crash Locations</span>
<select id="bikeYearFilter" onchange="updateBikeLocations()" style="padding:.35rem .5rem;border-radius:6px;border:1px solid var(--border);font-size:.8rem">
<option value="">All Years</option>
</select>
</div>
<div class="table-wrapper" style="max-height:280px;overflow-y:auto">
<table class="data-table">
<thead><tr><th>Route</th><th>Total</th><th>K</th><th>A</th><th>EPDO</th><th>Action</th></tr></thead>
<tbody id="bikeRouteBody"></tbody>
</table>
</div>
</div>
</div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- ğŸ“Š PED VS BIKE COMPARISON -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="card">
<div class="card-title">ğŸ“Š Pedestrian vs Bicycle Comparison</div>
<div class="table-wrapper">
<table class="data-table" style="width:100%">
<thead>
<tr style="background:linear-gradient(135deg,#1e3a5f,#1e40af);color:#fff">
<th style="text-align:left;padding:.75rem">Metric</th>
<th style="text-align:center;padding:.75rem">ğŸš¶ Pedestrian</th>
<th style="text-align:center;padding:.75rem">ğŸš´ Bicycle</th>
<th style="text-align:center;padding:.75rem">ğŸ“Š Total VRU</th>
</tr>
</thead>
<tbody id="pedBikeCompareBody"></tbody>
</table>
</div>
<div class="chart-card" style="margin-top:1rem">
<div class="chart-title">ğŸ“ˆ Pedestrian vs Bicycle Trends by Year</div>
<div class="chart-container" style="height:250px"><canvas id="chartPedBikeCompare"></canvas></div>
</div>
</div>
</div>
<!-- SEARCH TAB -->
<div id="tab-search" class="tab-content">
<div class="card">
<div class="card-title">ğŸ” Search & Filter Crashes</div>
<div class="filter-row" style="margin-bottom:.75rem">
<div class="filter-group" style="flex:2"><label>Search Text</label><input type="text" id="searchText" placeholder="Route, collision type, etc."></div>
<div class="filter-group"><label>Year</label><select id="searchYear"><option value="">All</option></select></div>
<div class="filter-group"><label>Severity</label><select id="searchSeverity"><option value="">All</option><option value="K">K-Fatal</option><option value="A">A-Serious</option><option value="B">B-Minor</option><option value="C">C-Possible</option><option value="O">O-PDO</option></select></div>
<div class="filter-group"><label>Ped/Bike</label><select id="searchPedBike"><option value="">All</option><option value="ped">Pedestrian</option><option value="bike">Bicycle</option></select></div>
<div class="filter-group" style="flex-direction:row;align-items:flex-end;gap:.4rem">
<button class="btn btn-primary btn-sm" onclick="searchCrashes()">Search</button>
<button class="btn btn-secondary btn-sm" onclick="clearSearch()">Clear</button>
</div>
</div>
<div class="table-wrapper" style="max-height:420px;overflow-y:auto">
<table class="data-table" id="searchTable">
<thead><tr><th>Date</th><th>Time</th><th>Sev</th><th>Route</th><th>Node</th><th>Collision Type</th><th>Weather</th><th>Light</th><th>Flags</th></tr></thead>
<tbody id="searchBody"></tbody>
</table>
</div>
<div class="pagination" id="searchPagination"></div>
<div class="btn-group" style="margin-top:.75rem">
<button class="btn btn-success btn-sm" onclick="exportSearchCSV()">ğŸ“¥ Export Results</button>
</div>
</div>
</div>
<!-- REPORTS TAB -->
<div id="tab-reports" class="tab-content">
<div class="card">
<div class="card-title">ğŸ“‹ Generate Professional Reports</div>
<div class="three-col" style="margin-bottom:1rem">
<div class="filter-group"><label>Report Type</label>
<select id="reportType" onchange="updateReportOptions()">
<option value="corridor">ğŸ“ Corridor/Segment Analysis</option>
<option value="intersection">ğŸš¦ Intersection Analysis</option>
<option value="systemwide">ğŸ“Š System-Wide Summary</option>
<option value="safety">âš ï¸ Safety Performance Report</option>
<option value="pedbike">ğŸš¶ Pedestrian/Bicycle Report</option>
<option value="trend">ğŸ“ˆ Trend Analysis Report</option>
</select>
</div>
<div class="filter-group" id="reportRouteGroup"><label>Route/Corridor</label><select id="reportRoute"><option value="">Select Route</option></select></div>
<div class="filter-group" id="reportNodeGroup" style="display:none"><label>Intersection</label><select id="reportNode"><option value="">All Intersections</option></select></div>
</div>
<div class="filter-row">
<div class="filter-group"><label>Start Year</label><select id="reportStartYear"><option value="">All</option></select></div>
<div class="filter-group"><label>End Year</label><select id="reportEndYear"><option value="">All</option></select></div>
<div class="filter-group"><label>Report Title</label><input type="text" id="reportTitle" value="Crash Analysis Report"></div>
<div class="filter-group"><label>Prepared By</label><input type="text" id="reportAuthor" value="Traffic Engineering Division"></div>
<div class="filter-group" style="flex-direction:row;align-items:flex-end">
<button class="btn btn-primary" onclick="generateReport()">ğŸ“„ Generate Report</button>
</div>
</div>
</div>
<div id="reportOutput" style="display:none">
<div class="report-container" id="reportContainer">
<div class="report-header">
<h2 id="rptTitle">Crash Analysis Report</h2>
<p id="rptSubtitle">Henrico County, Virginia</p>
<p style="font-size:.75rem;color:var(--gray);margin-top:.3rem" id="rptMeta"></p>
</div>
<div id="rptKPIs" class="report-kpis"></div>
<div id="rptFindings" class="report-section"></div>
<div id="rptYearlySection" class="report-section"></div>
<div id="rptChartsSection" class="two-col"></div>
<div id="rptTablesSection" class="report-section"></div>
<div id="rptRecommendations" class="report-section"></div>
</div>
<div class="btn-group" style="margin-top:1rem">
<button class="btn btn-warning" onclick="printReport()">ğŸ–¨ï¸ Print Report</button>
<button class="btn btn-success" onclick="downloadReportPDF()">ğŸ“¥ Download PDF</button>
<button class="btn btn-secondary" onclick="copyReportText()">ğŸ“‹ Copy Text</button>
</div>
</div>
</div>
</div>
<!-- CMF COUNTERMEASURES TAB -->
<div id="tab-cmf" class="tab-content">
<div class="card" style="background:linear-gradient(135deg,#f0fdf4 0%,#dcfce7 100%);border:2px solid #22c55e">
<div class="card-title" style="font-size:1.1rem;color:#15803d">ğŸ’¡ Safety Countermeasure Recommendations</div>
<p style="color:#166534;margin-bottom:1rem;font-size:.9rem">
Select a location from your crash data to receive evidence-based countermeasure recommendations from the 
<strong>FHWA CMF Clearinghouse</strong>. Recommendations are matched based on crash patterns, location type, and roadway characteristics.
</p>
<div class="filter-row" style="margin-bottom:1rem">
<div class="filter-group" style="flex:2">
<label>Select Location</label>
<select id="cmfLocationSelect" onchange="loadLocationForCMF()">
<option value="">-- Select a route or intersection --</option>
</select>
</div>
<div class="filter-group">
<label>Location Type</label>
<select id="cmfLocationType">
<option value="auto">Auto-detect</option>
<option value="intersection">Intersection</option>
<option value="segment">Road Segment</option>
</select>
</div>
<div class="filter-group">
<label>Area Type</label>
<select id="cmfAreaType">
<option value="All">All</option>
<option value="Urban">Urban</option>
<option value="Suburban">Suburban</option>
<option value="Rural">Rural</option>
</select>
</div>
<div class="filter-group">
<label>Min Star Rating</label>
<select id="cmfMinRating">
<option value="3">3+ Stars</option>
<option value="4">4+ Stars</option>
<option value="5">5 Stars Only</option>
</select>
</div>
<div class="filter-group" style="flex-direction:row;align-items:flex-end">
<button class="btn btn-success" onclick="findCountermeasures()">ğŸ” Find Countermeasures</button>
</div>
</div>
<!-- Advanced Filters Row -->
<div class="filter-row" style="margin-bottom:1rem;padding-top:.75rem;border-top:1px dashed var(--gray-light)">
<div class="filter-group">
<label>Number of Lanes</label>
<select id="cmfLanes">
<option value="">Any</option>
<option value="2">2 lanes</option>
<option value="3">3 lanes</option>
<option value="4">4 lanes</option>
<option value="5">5+ lanes</option>
</select>
</div>
<div class="filter-group">
<label>Intersection Geometry</label>
<select id="cmfIntGeometry">
<option value="">Any</option>
<option value="3-leg">3-leg (T-intersection)</option>
<option value="4-leg">4-leg</option>
</select>
</div>
<div class="filter-group">
<label>Road Division</label>
<select id="cmfRoadDivision">
<option value="">Any</option>
<option value="Undivided">Undivided</option>
<option value="Divided">Divided (Median)</option>
<option value="TWLTL">TWLTL</option>
</select>
</div>
<div class="filter-group">
<label style="display:flex;align-items:center;gap:.5rem">
<input type="checkbox" id="cmfProvenOnly" style="width:16px;height:16px"> 
<span>ğŸ† FHWA Proven Only</span>
</label>
</div>
<div class="filter-group">
<label style="display:flex;align-items:center;gap:.5rem">
<input type="checkbox" id="cmfHSMOnly" style="width:16px;height:16px"> 
<span>ğŸ“˜ HSM Only</span>
</label>
</div>
<div class="filter-group">
<label style="display:flex;align-items:center;gap:.5rem">
<input type="checkbox" id="cmfVirginiaFirst" style="width:16px;height:16px"> 
<span>ğŸ—ºï¸ Virginia First</span>
</label>
</div>
</div>
</div>

<!-- Location Crash Summary -->
<div class="card" id="cmfLocationSummary" style="display:none">
<div class="card-title">ğŸ“Š Crash Profile for Selected Location</div>
<div class="kpi-grid" style="grid-template-columns:repeat(6,1fr);margin-bottom:1rem" id="cmfLocationKPIs"></div>
<div class="two-col" style="gap:1rem">
<div>
<h4 style="font-size:.9rem;color:var(--primary);margin-bottom:.5rem">ğŸ¯ Primary Crash Types</h4>
<div id="cmfCrashTypes" style="display:flex;flex-wrap:wrap;gap:.4rem"></div>
</div>
<div>
<h4 style="font-size:.9rem;color:var(--primary);margin-bottom:.5rem">âš ï¸ Contributing Factors</h4>
<div id="cmfContribFactors" style="display:flex;flex-wrap:wrap;gap:.4rem"></div>
</div>
</div>
</div>

<!-- CMF Recommendations -->
<div class="card" id="cmfRecommendations" style="display:none">
<div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
<span>ğŸ› ï¸ Recommended Countermeasures</span>
<div style="display:flex;gap:.5rem;align-items:center">
<span style="font-size:.8rem;color:var(--gray)">Sort by:</span>
<select id="cmfSortBy" onchange="sortCMFResults()" style="padding:.3rem .5rem;border-radius:var(--radius);border:1px solid var(--border);font-size:.8rem">
<option value="effectiveness">Effectiveness (CRF%)</option>
<option value="rating">Star Rating</option>
<option value="relevance">Relevance</option>
</select>
</div>
</div>
<div id="cmfResultsList"></div>
<div class="btn-group" style="margin-top:1rem">
<button class="btn btn-success btn-sm" onclick="exportCMFReport()">ğŸ“¥ Export Report</button>
<button class="btn btn-primary btn-sm" onclick="printCMFReport()">ğŸ–¨ï¸ Print</button>
</div>
</div>

<!-- CMF Database Status -->
<div class="card">
<div class="card-title">ğŸ“š CMF Database Status</div>
<div id="cmfDatabaseStatus" style="padding:.5rem">
<div style="display:flex;align-items:center;gap:.5rem;color:var(--warning)">
<span class="spinner" style="width:20px;height:20px;border-width:2px"></span>
Loading CMF database...
</div>
</div>
</div>
</div>
<!-- AI ANALYST TAB -->
<div id="tab-ai" class="tab-content">
<div class="card">
<div class="card-title">ğŸ¤– AI-Powered Crash Analysis</div>
<div class="ai-controls">
<select class="ai-provider-select" id="aiProvider" onchange="loadSavedKey()">
<option value="openai">OpenAI (GPT-4o)</option>
<option value="claude">Claude (Sonnet 4)</option>
<option value="gemini">Google Gemini 2.0</option>
</select>
<input type="password" class="ai-key-input" id="aiApiKey" placeholder="Enter API key">
<label style="display:flex;align-items:center;gap:.35rem;font-size:.75rem;color:var(--gray);cursor:pointer">
<input type="checkbox" id="aiSaveKey"> Save key (encrypted)
</label>
<button class="btn btn-sm btn-outline" onclick="clearApiKey()" title="Clear saved API key" style="padding:.25rem .5rem;font-size:.7rem">ğŸ”‘ Clear Key</button>
<span class="ai-data-badge" id="aiDataBadge" style="display:none">âœ“ Data Loaded</span>
<button class="btn btn-sm btn-secondary" onclick="clearAIChat()" style="margin-left:auto">ğŸ—‘ï¸ Clear Chat</button>
</div>
<div class="ai-chat-container">
<div class="ai-chat-header">
<h3>ğŸš— Traffic Safety AI Assistant</h3>
<p>Ask questions about your crash data, upload images for analysis, or get safety recommendations</p>
</div>
<div class="ai-chat-messages" id="aiChatMessages">
<div class="ai-message assistant">
<div class="ai-avatar">ğŸ¤–</div>
<div class="ai-bubble">
<p><strong>Hello! I'm your Traffic Safety AI Assistant.</strong></p>
<p>I can help you analyze crash data, identify patterns, and provide safety recommendations. Here's what I can do:</p>
<ul>
<li>ğŸ“Š Analyze crash patterns and trends</li>
<li>ğŸ” Identify high-risk locations and factors</li>
<li>ğŸ“· Analyze uploaded images (crash scenes, intersections, road conditions)</li>
<li>ğŸ“„ Process PDF reports and documents</li>
<li>ğŸ’¡ Provide countermeasure recommendations</li>
</ul>
<p>Upload your crash data first, then ask me anything!</p>
</div>
</div>
</div>
<div class="ai-chat-input">
<div class="ai-attachments" id="aiAttachments"></div>
<div class="ai-input-row">
<button class="ai-btn ai-btn-attach" onclick="document.getElementById('aiFileInput').click()" title="Attach file">
ğŸ“
</button>
<input type="file" id="aiFileInput" accept="image/*,.pdf,.csv,.xlsx" multiple style="display:none" onchange="handleAIFileSelect(event)">
<div class="ai-input-wrapper">
<textarea class="ai-textarea" id="aiQuestion" placeholder="Ask about crash patterns, request analysis, or upload an image..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();askAI()}"></textarea>
</div>
<button class="ai-btn ai-btn-send" id="aiSendBtn" onclick="askAI()">
Send â¤
</button>
</div>
<div class="ai-suggestions">
<button class="ai-suggestion" onclick="askSuggestion(this)">What are the main crash patterns?</button>
<button class="ai-suggestion" onclick="askSuggestion(this)">Which locations need safety improvements?</button>
<button class="ai-suggestion" onclick="askSuggestion(this)">Analyze pedestrian crash risk factors</button>
<button class="ai-suggestion" onclick="askSuggestion(this)">Compare day vs night crashes</button>
<button class="ai-suggestion" onclick="askSuggestion(this)">Generate safety recommendations</button>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- MODALS -->
<div class="modal" id="locationModal">
<div class="modal-content">
<div class="modal-header"><h2 id="modalTitle">Location Details</h2><button class="modal-close" onclick="closeModal()">&times;</button></div>
<div id="modalBody"></div>
</div>
</div>
<div class="loading-overlay" id="loadingOverlay">
<div class="spinner"></div>
<div id="loadingText" style="color:var(--gray)">Processing...</div>
</div>
<script>
// ============================================================
// CRASH ANALYSIS SYSTEM - CORE CONFIGURATION
// ============================================================
const EPDO_WEIGHTS = { K: 462, A: 62, B: 12, C: 5, O: 1 };
const HENRICO_CENTER = [37.55, -77.45];

// Column mapping for Henrico County data format
const COL = {
    ID: 'Document Nbr', YEAR: 'Crash Year', DATE: 'Crash Date', TIME: 'Crash Military Time',
    SEVERITY: 'Crash Severity', K: 'K_People', A: 'A_People', B: 'B_People', C: 'C_People',
    COLLISION: 'Collision Type', WEATHER: 'Weather Condition', LIGHT: 'Light Condition',
    SURFACE: 'Roadway Surface Condition', ALIGNMENT: 'Roadway Alignment',
    ROAD_DESC: 'Roadway Description', INT_TYPE: 'Intersection Type',
    TRAFFIC_CTRL: 'Traffic Control Type', CTRL_STATUS: 'Traffic Control Status',
    WORKZONE: 'Work Zone Related', SCHOOL: 'School Zone',
    ALCOHOL: 'Alcohol?', BIKE: 'Bike?', PED: 'Pedestrian?', SPEED: 'Speed?',
    DISTRACTED: 'Distracted?', DROWSY: 'Drowsy?', HITRUN: 'Hitrun?',
    SENIOR: 'Senior?', YOUNG: 'Young?', NIGHT: 'Night?',
    UNRESTRAINED: 'Unrestrained?', MOTORCYCLE: 'Motorcycle?',
    FUNC_CLASS: 'Functional Class', AREA_TYPE: 'Area Type',
    ROUTE: 'RTE Name', NODE: 'Node', MP: 'RNS MP',
    X: 'x', Y: 'y'
};

// Global application state
const crashState = {
    loaded: false, totalRows: 0, years: [], routes: [], nodes: [],
    aggregates: {
        byYear: {}, bySeverity: { K: 0, A: 0, B: 0, C: 0, O: 0 },
        byCollision: {}, byWeather: {}, byLight: {}, byRoute: {}, byNode: {},
        byHour: {}, byDOW: {}, byMonth: {}, byFuncClass: {}, byIntType: {}, byTrafficCtrl: {},
        ped: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, byYear: {}, byLight: {}, byRoute: {} },
        bike: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, byYear: {}, byLight: {}, byRoute: {} },
        intersection: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 },
        nonIntersection: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 }
    },
    sampleRows: [], mapPoints: [], hotspots: []
};

// Filter state
const currentFilters = {
    startYear: null, endYear: null, route: null, intersection: null,
    severity: ['K', 'A', 'B', 'C', 'O'],
    mapFilters: { fatal: false, serious: false, ped: false, bike: false, intersection: false }
};

// Charts storage
const charts = {};
let crashMap = null, markerCluster = null, heatLayer = null, markersLayer = null;
let currentMapMode = 'cluster';
const PAGE_SIZE = 100;
let currentSearchPage = 1, searchResults = [];

// ============================================================
// UTILITY FUNCTIONS
// ============================================================
const isYes = v => v && (String(v).toLowerCase() === 'yes' || v === 'Y' || v === '1' || v === 1);
const esc = s => s ? String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) : '';
const calcEPDO = s => (s.K||0)*EPDO_WEIGHTS.K + (s.A||0)*EPDO_WEIGHTS.A + (s.B||0)*EPDO_WEIGHTS.B + (s.C||0)*EPDO_WEIGHTS.C + (s.O||0)*EPDO_WEIGHTS.O;
const fmtTime = t => { if(!t)return''; const s=String(t).padStart(4,'0'); return s.slice(0,2)+':'+s.slice(2); };
const getHour = t => { if(!t)return null; return parseInt(String(t).padStart(4,'0').slice(0,2),10); };
const isIntersection = row => {
    const rel = (row['Relation To Roadway']||'').toLowerCase();
    return rel.includes('intersection') || rel.includes('within intersection');
};
const pct = (n, total) => total > 0 ? (n/total*100).toFixed(1) : '0.0';
const showLoading = text => { document.getElementById('loadingText').textContent = text||'Processing...'; document.getElementById('loadingOverlay').classList.add('visible'); };
const hideLoading = () => document.getElementById('loadingOverlay').classList.remove('visible');

function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    
    if (tabId === 'map' && crashState.loaded && !crashMap) setTimeout(initMap, 100);
    if (tabId === 'dashboard' && crashState.loaded) updateDashboard();
    if (tabId === 'analysis' && crashState.loaded) updateAnalysis();
    if (tabId === 'intersection' && crashState.loaded) updateIntersectionTab();
    if (tabId === 'pedestrian' && crashState.loaded) updatePedBikeTab();
    if (tabId === 'hotspots' && crashState.loaded && !crashState.hotspots.length) analyzeHotspots();
}

document.querySelectorAll('.nav-tab').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));
function closeModal() { document.getElementById('locationModal').classList.remove('visible'); }

// ============================================================
// AUTO-LOAD DATA FROM SERVER
// ============================================================
const DATA_FILE = 'data/crashes.csv'; // Path to your CSV file

// Auto-load on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDataFromServer();
});

async function loadDataFromServer() {
    resetState();
    
    const prog = document.getElementById('progressContainer');
    const uploadZone = document.getElementById('uploadZone');
    const loadError = document.getElementById('loadError');
    
    prog.style.display = 'block';
    loadError.style.display = 'none';
    document.getElementById('uploadSummary').style.display = 'none';
    document.getElementById('loadingTitle').textContent = 'Loading Crash Data...';
    document.getElementById('loadingSubtitle').textContent = 'Fetching data from server';
    uploadZone.querySelector('div').textContent = 'ğŸ”„';
    
    try {
        const response = await fetch(DATA_FILE + '?t=' + Date.now()); // Cache bust
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const csvText = await response.text();
        document.getElementById('loadingSubtitle').textContent = 'Processing records...';
        
        const startTime = Date.now();
        let rowCount = 0, lastUpdate = startTime;
        
        Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            chunk: function(results) {
                results.data.forEach(row => { processRow(row); rowCount++; });
                const now = Date.now();
                if (now - lastUpdate > 100) { updateProgress(rowCount, startTime); lastUpdate = now; }
            },
            complete: function() {
                crashState.totalRows = rowCount;
                crashState.loaded = true;
                finalizeData();
                updateProgress(rowCount, startTime);
                
                // Update UI
                uploadZone.querySelector('div').textContent = 'âœ…';
                document.getElementById('loadingTitle').textContent = 'Data Ready!';
                document.getElementById('loadingSubtitle').textContent = `${rowCount.toLocaleString()} crash records loaded`;
                
                setTimeout(() => { 
                    prog.style.display = 'none'; 
                    showUploadSummary(); 
                    initDropdowns();
                    // Auto-switch to dashboard
                    showTab('dashboard');
                }, 500);
            },
            error: function(e) {
                showLoadError('Parse error: ' + e.message);
            }
        });
        
    } catch (error) {
        showLoadError(error.message);
    }
}

function showLoadError(message) {
    const prog = document.getElementById('progressContainer');
    const loadError = document.getElementById('loadError');
    const uploadZone = document.getElementById('uploadZone');
    
    prog.style.display = 'none';
    loadError.style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
    uploadZone.querySelector('div').textContent = 'âŒ';
    document.getElementById('loadingTitle').textContent = 'Failed to Load Data';
    document.getElementById('loadingSubtitle').textContent = 'Check console for details';
    console.error('Data load error:', message);
}

function resetState() {
    crashState.loaded = false;
    crashState.totalRows = 0;
    crashState.aggregates = {
        byYear: {}, bySeverity: { K: 0, A: 0, B: 0, C: 0, O: 0 },
        byCollision: {}, byWeather: {}, byLight: {}, byRoute: {}, byNode: {},
        byHour: {}, byDOW: {}, byMonth: {}, byFuncClass: {}, byIntType: {}, byTrafficCtrl: {},
        ped: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, byYear: {}, byLight: {}, byRoute: {} },
        bike: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, byYear: {}, byLight: {}, byRoute: {} },
        intersection: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 },
        nonIntersection: { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 }
    };
    crashState.sampleRows = [];
    crashState.mapPoints = [];
    crashState.hotspots = [];
    crashState.years = [];
    crashState.routes = [];
    crashState.nodes = [];
    Object.keys(charts).forEach(k => { if(charts[k]) { charts[k].destroy(); delete charts[k]; } });
    if (crashMap) { crashMap.remove(); crashMap = null; markerCluster = null; heatLayer = null; }
}

function processRow(row) {
    const agg = crashState.aggregates;
    const year = parseInt(row[COL.YEAR]) || null;
    const sev = (row[COL.SEVERITY] || '').trim().toUpperCase().charAt(0);
    const collision = row[COL.COLLISION] || 'Unknown';
    const weather = row[COL.WEATHER] || 'Unknown';
    const light = row[COL.LIGHT] || 'Unknown';
    const route = row[COL.ROUTE] || 'Unknown';
    const node = row[COL.NODE] || '';
    const hour = getHour(row[COL.TIME]);
    const isPed = isYes(row[COL.PED]);
    const isBike = isYes(row[COL.BIKE]);
    const isInt = isIntersection(row);
    const funcClass = row[COL.FUNC_CLASS] || 'Unknown';
    const intType = row[COL.INT_TYPE] || '';
    const trafficCtrl = row[COL.TRAFFIC_CTRL] || '';
    
    // By year
    if (year) {
        if (!agg.byYear[year]) agg.byYear[year] = { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, ped: 0, bike: 0 };
        agg.byYear[year].total++;
        if (sev && agg.byYear[year][sev] !== undefined) agg.byYear[year][sev]++;
        if (isPed) agg.byYear[year].ped++;
        if (isBike) agg.byYear[year].bike++;
    }
    
    // By severity
    if (sev && agg.bySeverity[sev] !== undefined) agg.bySeverity[sev]++;
    
    // By collision type
    agg.byCollision[collision] = (agg.byCollision[collision] || 0) + 1;
    
    // By weather
    agg.byWeather[weather] = (agg.byWeather[weather] || 0) + 1;
    
    // By light
    agg.byLight[light] = (agg.byLight[light] || 0) + 1;
    
    // By route
    if (route !== 'Unknown') {
        if (!agg.byRoute[route]) agg.byRoute[route] = { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, collisions: {} };
        agg.byRoute[route].total++;
        if (sev) agg.byRoute[route][sev]++;
        agg.byRoute[route].collisions[collision] = (agg.byRoute[route].collisions[collision] || 0) + 1;
    }
    
    // By node (intersection)
    if (node) {
        if (!agg.byNode[node]) agg.byNode[node] = { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, route: route, ctrl: trafficCtrl };
        agg.byNode[node].total++;
        if (sev) agg.byNode[node][sev]++;
    }
    
    // By hour, DOW, month
    if (hour !== null) agg.byHour[hour] = (agg.byHour[hour] || 0) + 1;
    if (row[COL.DATE]) {
        const d = new Date(row[COL.DATE]);
        if (!isNaN(d)) {
            agg.byDOW[d.getDay()] = (agg.byDOW[d.getDay()] || 0) + 1;
            agg.byMonth[d.getMonth()] = (agg.byMonth[d.getMonth()] || 0) + 1;
        }
    }
    
    // By functional class
    agg.byFuncClass[funcClass] = agg.byFuncClass[funcClass] || { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 };
    agg.byFuncClass[funcClass].total++;
    if (sev) agg.byFuncClass[funcClass][sev]++;
    
    // By intersection type
    if (intType) {
        agg.byIntType[intType] = agg.byIntType[intType] || { total: 0, K: 0, A: 0 };
        agg.byIntType[intType].total++;
        if (sev === 'K') agg.byIntType[intType].K++;
        if (sev === 'A') agg.byIntType[intType].A++;
    }
    
    // By traffic control
    if (trafficCtrl) {
        agg.byTrafficCtrl[trafficCtrl] = (agg.byTrafficCtrl[trafficCtrl] || 0) + 1;
    }
    
    // Intersection vs non-intersection
    if (isInt) {
        agg.intersection.total++;
        if (sev) agg.intersection[sev]++;
    } else {
        agg.nonIntersection.total++;
        if (sev) agg.nonIntersection[sev]++;
    }
    
    // Pedestrian
    if (isPed) {
        agg.ped.total++;
        if (sev) agg.ped[sev]++;
        if (year) agg.ped.byYear[year] = (agg.ped.byYear[year] || 0) + 1;
        agg.ped.byLight[light] = (agg.ped.byLight[light] || 0) + 1;
        if (route !== 'Unknown') agg.ped.byRoute[route] = (agg.ped.byRoute[route] || 0) + 1;
    }
    
    // Bicycle
    if (isBike) {
        agg.bike.total++;
        if (sev) agg.bike[sev]++;
        if (year) agg.bike.byYear[year] = (agg.bike.byYear[year] || 0) + 1;
        agg.bike.byLight[light] = (agg.bike.byLight[light] || 0) + 1;
        if (route !== 'Unknown') agg.bike.byRoute[route] = (agg.bike.byRoute[route] || 0) + 1;
    }
    
    // Sample rows for search
    if (crashState.sampleRows.length < 30000) crashState.sampleRows.push(row);
    
    // Map points - coordinates are already WGS84 (lng, lat)
    const x = parseFloat(row[COL.X]);
    const y = parseFloat(row[COL.Y]);
    if (!isNaN(x) && !isNaN(y) && x !== 0 && y !== 0) {
        crashState.mapPoints.push({
            lat: y, lng: x, sev, route, node, collision,
            date: row[COL.DATE], time: row[COL.TIME],
            isPed, isBike, isInt, weather, light
        });
    }
}

function finalizeData() {
    crashState.years = Object.keys(crashState.aggregates.byYear).map(Number).sort((a,b) => a-b);
    crashState.routes = Object.keys(crashState.aggregates.byRoute).filter(r => r !== 'Unknown').sort();
    crashState.nodes = Object.keys(crashState.aggregates.byNode).sort();
}

function updateProgress(count, startTime) {
    const elapsed = (Date.now() - startTime) / 1000;
    const speed = Math.round(count / elapsed);
    document.getElementById('progressBar').style.width = '100%';
    document.getElementById('progressText').textContent = count.toLocaleString() + ' rows';
    document.getElementById('statRows').textContent = count.toLocaleString();
    document.getElementById('statSpeed').textContent = speed.toLocaleString();
    document.getElementById('statElapsed').textContent = elapsed.toFixed(1) + 's';
}

function showUploadSummary() {
    document.getElementById('summaryTotal').textContent = crashState.totalRows.toLocaleString();
    document.getElementById('summaryYears').textContent = crashState.years.length > 0 ? `${crashState.years[0]} - ${crashState.years[crashState.years.length-1]}` : '--';
    document.getElementById('summaryRoutes').textContent = crashState.routes.length.toLocaleString();
    document.getElementById('uploadSummary').style.display = 'block';
}

function initDropdowns() {
    const yearOpts = crashState.years.map(y => `<option value="${y}">${y}</option>`).join('');
    const routeOpts = crashState.routes.map(r => `<option value="${esc(r)}">${esc(r)}</option>`).join('');
    const intTypes = Object.keys(crashState.aggregates.byIntType).sort();
    const intOpts = intTypes.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join('');
    
    ['filterStartYear', 'filterEndYear', 'mapYearFilter', 'searchYear', 'reportStartYear', 'reportEndYear'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<option value="">All</option>' + yearOpts;
    });
    
    ['filterRoute', 'reportRoute'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '<option value="">All Routes</option>' + routeOpts;
    });
    
    document.getElementById('filterIntersection').innerHTML = '<option value="">All</option>' + intOpts;
}
</script>
<script>
// ============================================================
// FILTERING
// ============================================================
function applyFilters() {
    currentFilters.startYear = document.getElementById('filterStartYear').value || null;
    currentFilters.endYear = document.getElementById('filterEndYear').value || null;
    currentFilters.route = document.getElementById('filterRoute').value || null;
    currentFilters.intersection = document.getElementById('filterIntersection').value || null;
    currentFilters.severity = [];
    ['K','A','B','C','O'].forEach(s => { if(document.getElementById('sev'+s).checked) currentFilters.severity.push(s); });
    updateDashboard();
    if (crashMap) updateMapDisplay();
}

function resetFilters() {
    document.getElementById('filterStartYear').value = '';
    document.getElementById('filterEndYear').value = '';
    document.getElementById('filterRoute').value = '';
    document.getElementById('filterIntersection').value = '';
    ['K','A','B','C','O'].forEach(s => document.getElementById('sev'+s).checked = true);
    currentFilters.startYear = null;
    currentFilters.endYear = null;
    currentFilters.route = null;
    currentFilters.intersection = null;
    currentFilters.severity = ['K','A','B','C','O'];
    updateDashboard();
    if (crashMap) updateMapDisplay();
}

function getFilteredStats() {
    const f = currentFilters;
    if (!f.startYear && !f.endYear && !f.route && !f.intersection && f.severity.length === 5) {
        return { agg: crashState.aggregates, total: crashState.totalRows };
    }
    
    const stats = { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0, ped: 0, bike: 0 };
    crashState.sampleRows.forEach(row => {
        const year = parseInt(row[COL.YEAR]);
        const sev = (row[COL.SEVERITY] || '').trim().toUpperCase().charAt(0);
        if (f.startYear && year < parseInt(f.startYear)) return;
        if (f.endYear && year > parseInt(f.endYear)) return;
        if (f.route && row[COL.ROUTE] !== f.route) return;
        if (f.intersection && row[COL.INT_TYPE] !== f.intersection) return;
        if (!f.severity.includes(sev)) return;
        
        stats.total++;
        if (sev && stats[sev] !== undefined) stats[sev]++;
        if (isYes(row[COL.PED])) stats.ped++;
        if (isYes(row[COL.BIKE])) stats.bike++;
    });
    return { stats, total: stats.total };
}

// ============================================================
// DASHBOARD
// ============================================================
function updateDashboard() {
    if (!crashState.loaded) return;
    
    const filtered = getFilteredStats();
    const sev = filtered.stats || crashState.aggregates.bySeverity;
    const total = filtered.total || crashState.totalRows;
    const pedTotal = filtered.stats?.ped ?? crashState.aggregates.ped.total;
    const bikeTotal = filtered.stats?.bike ?? crashState.aggregates.bike.total;
    const years = crashState.years;
    const numYears = years.length || 1;
    
    document.getElementById('kpiTotal').textContent = total.toLocaleString();
    document.getElementById('kpiFatal').textContent = sev.K;
    document.getElementById('kpiFatalPct').textContent = pct(sev.K, total) + '%';
    document.getElementById('kpiInjuryA').textContent = sev.A;
    document.getElementById('kpiAPct').textContent = pct(sev.A, total) + '%';
    document.getElementById('kpiInjuryBC').textContent = (sev.B + sev.C).toLocaleString();
    document.getElementById('kpiPDO').textContent = sev.O.toLocaleString();
    
    // EPDO with breakdown
    const epdo = calcEPDO(sev);
    const epdoK = sev.K * EPDO_WEIGHTS.K;
    const epdoA = sev.A * EPDO_WEIGHTS.A;
    const epdoB = sev.B * EPDO_WEIGHTS.B;
    const epdoC = sev.C * EPDO_WEIGHTS.C;
    const epdoO = sev.O * EPDO_WEIGHTS.O;
    
    document.getElementById('kpiEPDO').textContent = epdo.toLocaleString();
    document.getElementById('kpiYearRange').textContent = years.length > 0 ? `${years[0]}-${years[years.length-1]}` : '';
    document.getElementById('kpiEPDOAvg').innerHTML = `Avg/Year: ${Math.round(epdo/numYears).toLocaleString()}`;
    
    // EPDO breakdown
    document.getElementById('epdoK').textContent = epdoK.toLocaleString();
    document.getElementById('epdoA').textContent = epdoA.toLocaleString();
    document.getElementById('epdoB').textContent = epdoB.toLocaleString();
    document.getElementById('epdoC').textContent = epdoC.toLocaleString();
    document.getElementById('epdoO').textContent = epdoO.toLocaleString();
    
    document.getElementById('epdoKPct').textContent = pct(epdoK, epdo) + '%';
    document.getElementById('epdoAPct').textContent = pct(epdoA, epdo) + '%';
    document.getElementById('epdoBPct').textContent = pct(epdoB, epdo) + '%';
    document.getElementById('epdoCPct').textContent = pct(epdoC, epdo) + '%';
    document.getElementById('epdoOPct').textContent = pct(epdoO, epdo) + '%';
    
    document.getElementById('epdoKBar').style.width = pct(epdoK, epdo) + '%';
    document.getElementById('epdoABar').style.width = pct(epdoA, epdo) + '%';
    document.getElementById('epdoBBar').style.width = pct(epdoB, epdo) + '%';
    document.getElementById('epdoCBar').style.width = pct(epdoC, epdo) + '%';
    document.getElementById('epdoOBar').style.width = pct(epdoO, epdo) + '%';
    
    document.getElementById('epdoAnnual').textContent = Math.round(epdo/numYears).toLocaleString();
    document.getElementById('epdoPer100').textContent = total > 0 ? (epdo/total*100).toFixed(1) : '0';
    
    document.getElementById('kpiPed').textContent = pedTotal;
    document.getElementById('kpiPedPct').textContent = pct(pedTotal, total) + '%';
    document.getElementById('kpiBike').textContent = bikeTotal;
    document.getElementById('kpiBikePct').textContent = pct(bikeTotal, total) + '%';
    
    updateCharts();
}

function updateCharts() {
    const agg = crashState.aggregates;
    const sev = agg.bySeverity;
    const totalCrashes = crashState.totalRows;
    
    // Severity chart with custom legend
    const sevLabels = ['Fatal (K)', 'Serious (A)', 'Minor (B)', 'Possible (C)', 'PDO (O)'];
    const sevData = [sev.K, sev.A, sev.B, sev.C, sev.O];
    const sevColors = ['#dc2626','#ea580c','#eab308','#22c55e','#64748b'];
    
    createChart('chartSeverity', 'doughnut', {
        labels: sevLabels,
        datasets: [{ data: sevData, backgroundColor: sevColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    buildCustomLegend('legendSeverity', sevLabels, sevData, sevColors, totalCrashes);
    
    // Year chart
    const years = Object.keys(agg.byYear).sort();
    createChart('chartYear', 'bar', {
        labels: years,
        datasets: [
            { label: 'Total', data: years.map(y => agg.byYear[y].total), backgroundColor: '#1e40af' },
            { label: 'K+A', data: years.map(y => agg.byYear[y].K + agg.byYear[y].A), backgroundColor: '#dc2626' }
        ]
    });
    
    // Collision chart
    const collisions = Object.entries(agg.byCollision).sort((a,b) => b[1]-a[1]).slice(0,10);
    createChart('chartCollision', 'bar', {
        labels: collisions.map(c => c[0].substring(0,25)),
        datasets: [{ label: 'Crashes', data: collisions.map(c => c[1]), backgroundColor: '#7c3aed' }]
    }, { indexAxis: 'y' });
    
    // Time of day chart
    const hours = Array.from({length:24}, (_,i) => i);
    createChart('chartTimeOfDay', 'bar', {
        labels: hours.map(h => h.toString().padStart(2,'0')),
        datasets: [{ label: 'Crashes', data: hours.map(h => agg.byHour[h] || 0), backgroundColor: hours.map(h => (h >= 19 || h < 6) ? '#4f46e5' : '#06b6d4') }]
    });
    
    // Weather chart with custom legend
    const weather = Object.entries(agg.byWeather).sort((a,b) => b[1]-a[1]).slice(0,6);
    const weatherLabels = weather.map(w => w[0].substring(0,20));
    const weatherData = weather.map(w => w[1]);
    const weatherColors = ['#0ea5e9','#64748b','#f59e0b','#10b981','#8b5cf6','#ec4899'];
    
    createChart('chartWeather', 'doughnut', {
        labels: weatherLabels,
        datasets: [{ data: weatherData, backgroundColor: weatherColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    buildCustomLegend('legendWeather', weatherLabels, weatherData, weatherColors, totalCrashes);
    
    // Light chart with custom legend
    const light = Object.entries(agg.byLight).sort((a,b) => b[1]-a[1]).slice(0,6);
    const lightLabels = light.map(l => l[0].substring(0,20));
    const lightData = light.map(l => l[1]);
    const lightColors = ['#fcd34d','#1e293b','#94a3b8','#f97316','#6366f1','#14b8a6'];
    
    createChart('chartLight', 'doughnut', {
        labels: lightLabels,
        datasets: [{ data: lightData, backgroundColor: lightColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    buildCustomLegend('legendLight', lightLabels, lightData, lightColors, totalCrashes);
    
    // EPDO Breakdown Chart
    const epdoK = sev.K * 462;
    const epdoA = sev.A * 62;
    const epdoB = sev.B * 12;
    const epdoC = sev.C * 5;
    const epdoO = sev.O * 1;
    const totalEPDO = epdoK + epdoA + epdoB + epdoC + epdoO;
    
    const epdoLabels = ['Fatal (KÃ—462)', 'Serious (AÃ—62)', 'Minor (BÃ—12)', 'Possible (CÃ—5)', 'PDO (OÃ—1)'];
    const epdoData = [epdoK, epdoA, epdoB, epdoC, epdoO];
    const epdoColors = ['#dc2626', '#ea580c', '#eab308', '#22c55e', '#64748b'];
    
    createChart('chartEPDO', 'doughnut', {
        labels: epdoLabels,
        datasets: [{ data: epdoData, backgroundColor: epdoColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    buildCustomLegend('legendEPDO', epdoLabels, epdoData, epdoColors, totalEPDO);
    
    // EPDO by Year Chart - calculate from aggregates
    const epdoYearData = years.map(y => {
        const yearData = agg.byYear[y] || 0;
        // We need severity breakdown by year, use sample rows
        let yK = 0, yA = 0, yB = 0, yC = 0, yO = 0;
        crashState.sampleRows.forEach(r => {
            if (String(r[COL.YEAR]) === String(y)) {
                const s = (r[COL.SEVERITY] || '').charAt(0);
                if (s === 'K') yK++;
                else if (s === 'A') yA++;
                else if (s === 'B') yB++;
                else if (s === 'C') yC++;
                else if (s === 'O') yO++;
            }
        });
        return yK * 462 + yA * 62 + yB * 12 + yC * 5 + yO;
    });
    
    createChart('chartEPDOYear', 'bar', {
        labels: years,
        datasets: [{
            label: 'EPDO Score',
            data: epdoYearData,
            backgroundColor: '#7c3aed',
            borderRadius: 4
        }]
    }, { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } });
}

// Helper function to build custom legends with numbers and percentages
function buildCustomLegend(containerId, labels, data, colors, total) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    let html = '';
    labels.forEach((label, i) => {
        const val = data[i] || 0;
        const pct = total > 0 ? (val / total * 100).toFixed(1) : 0;
        html += `<div style="display:flex;align-items:center;gap:.4rem;margin-bottom:.2rem;white-space:nowrap">
            <span style="width:10px;height:10px;background:${colors[i]};border-radius:2px;flex-shrink:0"></span>
            <span style="max-width:120px;overflow:hidden;text-overflow:ellipsis">${label}</span>
            <span style="font-weight:600;margin-left:auto">${val.toLocaleString()}</span>
            <span style="color:#64748b">(${pct}%)</span>
        </div>`;
    });
    container.innerHTML = html;
}

function createChart(id, type, data, opts = {}) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    if (charts[id]) { charts[id].destroy(); }
    
    const defaults = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { position: type === 'doughnut' ? 'right' : 'top', labels: { font: { size: 10 } } } }
    };
    if (type === 'bar' && !opts.indexAxis) {
        defaults.scales = { x: { ticks: { font: { size: 9 } } }, y: { beginAtZero: true, ticks: { font: { size: 9 } } } };
    }
    if (opts.indexAxis === 'y') {
        defaults.scales = { x: { beginAtZero: true, ticks: { font: { size: 9 } } }, y: { ticks: { font: { size: 9 } } } };
    }
    
    charts[id] = new Chart(ctx, { type, data, options: { ...defaults, ...opts } });
}
</script>
<script>
// ============================================================
// MAP - FIXED FOR WGS84 COORDINATES
// ============================================================
function initMap() {
    if (crashMap) return;
    
    // Find center from data or use Henrico default
    let center = HENRICO_CENTER;
    if (crashState.mapPoints.length > 0) {
        const validPts = crashState.mapPoints.filter(p => p.lat && p.lng && p.lat > 30 && p.lat < 45 && p.lng > -85 && p.lng < -70);
        if (validPts.length > 0) {
            const avgLat = validPts.slice(0,1000).reduce((s,p) => s + p.lat, 0) / Math.min(validPts.length, 1000);
            const avgLng = validPts.slice(0,1000).reduce((s,p) => s + p.lng, 0) / Math.min(validPts.length, 1000);
            center = [avgLat, avgLng];
        }
    }
    
    crashMap = L.map('map').setView(center, 11);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(crashMap);
    
    // Initialize cluster group
    markerCluster = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        iconCreateFunction: function(cluster) {
            const count = cluster.getChildCount();
            let size = 'small';
            if (count > 100) size = 'large';
            else if (count > 20) size = 'medium';
            return L.divIcon({
                html: `<div><span>${count}</span></div>`,
                className: `marker-cluster marker-cluster-${size}`,
                iconSize: L.point(40, 40)
            });
        }
    });
    
    // Initialize markers layer
    markersLayer = L.layerGroup();
    
    updateMapDisplay();
    
    // Fit bounds to data
    const validPts = crashState.mapPoints.filter(p => p.lat && p.lng && p.lat > 30 && p.lat < 45 && p.lng > -85 && p.lng < -70);
    if (validPts.length > 0) {
        const bounds = L.latLngBounds(validPts.slice(0, 5000).map(p => [p.lat, p.lng]));
        crashMap.fitBounds(bounds, { padding: [30, 30] });
    }
}

function getFilteredMapPoints() {
    const f = currentFilters;
    const mf = f.mapFilters;
    const yearFilter = document.getElementById('mapYearFilter')?.value;
    
    return crashState.mapPoints.filter(p => {
        // Validate coordinates
        if (!p.lat || !p.lng || p.lat < 30 || p.lat > 45 || p.lng < -85 || p.lng > -70) return false;
        
        // Year filter
        if (yearFilter && p.date) {
            const year = new Date(p.date).getFullYear();
            if (year !== parseInt(yearFilter)) return false;
        }
        
        // Severity filter
        if (!f.severity.includes(p.sev)) return false;
        
        // Quick filters (if any active, must match)
        const anyActive = Object.values(mf).some(v => v);
        if (anyActive) {
            let matches = false;
            if (mf.fatal && p.sev === 'K') matches = true;
            if (mf.serious && (p.sev === 'K' || p.sev === 'A')) matches = true;
            if (mf.ped && p.isPed) matches = true;
            if (mf.bike && p.isBike) matches = true;
            if (mf.intersection && p.isInt) matches = true;
            if (!matches) return false;
        }
        
        return true;
    });
}

function updateMapDisplay() {
    if (!crashMap) return;
    
    const filtered = getFilteredMapPoints();
    
    // Calculate stats
    const stats = { total: filtered.length, fatal: 0, serious: 0, epdo: 0 };
    filtered.forEach(p => {
        if (p.sev === 'K') stats.fatal++;
        if (p.sev === 'A') stats.serious++;
        stats.epdo += EPDO_WEIGHTS[p.sev] || 0;
    });
    
    // Update overlay
    document.getElementById('mapCount').textContent = stats.total.toLocaleString();
    document.getElementById('mapFatal').textContent = stats.fatal;
    document.getElementById('mapSerious').textContent = stats.serious;
    document.getElementById('mapEPDO').textContent = stats.epdo.toLocaleString();
    
    // Clear existing layers
    markerCluster.clearLayers();
    if (markersLayer) crashMap.removeLayer(markersLayer);
    markersLayer.clearLayers();
    if (heatLayer) { crashMap.removeLayer(heatLayer); heatLayer = null; }
    
    if (currentMapMode === 'heat') {
        // Heatmap mode
        const heatData = filtered.map(p => {
            const intensity = p.sev === 'K' ? 1.0 : p.sev === 'A' ? 0.8 : p.sev === 'B' ? 0.5 : 0.3;
            return [p.lat, p.lng, intensity];
        });
        
        heatLayer = L.heatLayer(heatData, {
            radius: 20,
            blur: 15,
            maxZoom: 17,
            gradient: { 0.2: '#22c55e', 0.4: '#eab308', 0.6: '#f97316', 0.8: '#ef4444', 1.0: '#dc2626' }
        }).addTo(crashMap);
        
    } else if (currentMapMode === 'markers') {
        // Individual markers (limited)
        const limit = Math.min(filtered.length, 3000);
        for (let i = 0; i < limit; i++) {
            const p = filtered[i];
            const marker = createMarker(p);
            markersLayer.addLayer(marker);
        }
        crashMap.addLayer(markersLayer);
        
    } else {
        // Cluster mode (default)
        const limit = Math.min(filtered.length, 50000);
        for (let i = 0; i < limit; i++) {
            const p = filtered[i];
            const marker = createMarker(p);
            markerCluster.addLayer(marker);
        }
        crashMap.addLayer(markerCluster);
    }
}

function createMarker(p) {
    const colors = { K: '#dc2626', A: '#ea580c', B: '#eab308', C: '#22c55e', O: '#64748b' };
    const color = colors[p.sev] || '#64748b';
    const size = p.sev === 'K' ? 14 : p.sev === 'A' ? 12 : 10;
    
    let iconHtml = `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.4)"></div>`;
    if (p.isPed) iconHtml = `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;border:2px solid #0891b2;box-shadow:0 1px 3px rgba(0,0,0,.4)"></div>`;
    if (p.isBike) iconHtml = `<div style="background:${color};width:${size}px;height:${size}px;border-radius:50%;border:2px solid #059669;box-shadow:0 1px 3px rgba(0,0,0,.4)"></div>`;
    
    const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [size, size], iconAnchor: [size/2, size/2] });
    const marker = L.marker([p.lat, p.lng], { icon });
    
    marker.bindPopup(`
        <div style="font-size:12px;min-width:200px">
            <strong style="font-size:13px">${esc(p.route || 'Unknown Route')}</strong><br>
            ${p.node ? `<span style="color:#64748b">Node: ${esc(p.node)}</span><br>` : ''}
            <span class="severity-badge severity-${p.sev}" style="margin:4px 0;display:inline-block">${p.sev}</span>
            ${p.isPed ? '<span style="margin-left:4px">ğŸš¶</span>' : ''}
            ${p.isBike ? '<span style="margin-left:4px">ğŸš´</span>' : ''}<br>
            <strong>Date:</strong> ${p.date || '--'}<br>
            <strong>Time:</strong> ${fmtTime(p.time)}<br>
            <strong>Type:</strong> ${esc((p.collision || '').substring(0,35))}<br>
            <strong>Weather:</strong> ${esc((p.weather || '').substring(0,25))}<br>
            <strong>Light:</strong> ${esc((p.light || '').substring(0,25))}
        </div>
    `);
    
    return marker;
}

function setMapMode(mode) {
    currentMapMode = mode;
    document.getElementById('btnCluster').classList.toggle('active', mode === 'cluster');
    document.getElementById('btnHeat').classList.toggle('active', mode === 'heat');
    document.getElementById('btnMarkers').classList.toggle('active', mode === 'markers');
    updateMapDisplay();
}

function toggleMapFilter(el) {
    const filter = el.dataset.filter;
    currentFilters.mapFilters[filter] = !currentFilters.mapFilters[filter];
    el.classList.toggle('active', currentFilters.mapFilters[filter]);
    updateMapDisplay();
}

// ============================================================
// MAP SELECTION - Route/Intersection Selection
// ============================================================
let mapSelectionMode = 'route';
let selectedMapLocation = null;
let routePolylines = [];

function setSelectionMode(mode) {
    mapSelectionMode = mode;
    document.getElementById('btnSelectRoute').classList.toggle('active', mode === 'route');
    document.getElementById('btnSelectNode').classList.toggle('active', mode === 'node');
    document.getElementById('mapSearchInput').placeholder = mode === 'route' ? 'Search routes...' : 'Search intersections...';
    populateMapList();
}

function populateMapList() {
    const container = document.getElementById('mapList');
    const searchTerm = (document.getElementById('mapSearchInput').value || '').toLowerCase();
    
    let items = [];
    if (mapSelectionMode === 'route') {
        items = Object.entries(crashState.aggregates.byRoute)
            .map(([name, data]) => ({ name, total: data.total, K: data.K || 0, A: data.A || 0 }))
            .filter(item => item.name.toLowerCase().includes(searchTerm))
            .sort((a, b) => b.total - a.total)
            .slice(0, 50);
    } else {
        items = Object.entries(crashState.aggregates.byNode)
            .map(([name, data]) => ({ name, total: data.total, K: data.K || 0, A: data.A || 0, route: data.route || '' }))
            .filter(item => item.name.toLowerCase().includes(searchTerm) || (item.route && item.route.toLowerCase().includes(searchTerm)))
            .sort((a, b) => b.total - a.total)
            .slice(0, 50);
    }
    
    container.innerHTML = items.map(item => `
        <div class="map-list-item ${selectedMapLocation === item.name ? 'selected' : ''}" 
             onclick="selectMapLocation('${esc(item.name)}')" 
             data-name="${esc(item.name)}">
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(item.name)}">
                ${mapSelectionMode === 'node' && item.route ? `<span style="color:var(--gray);font-size:.7rem">${esc(item.route.substring(0,15))}</span><br>` : ''}
                ${esc(item.name.substring(0, 35))}${item.name.length > 35 ? '...' : ''}
            </span>
            <span class="count" style="${item.K > 0 ? 'background:#fee2e2;color:#dc2626' : ''}">${item.total}</span>
        </div>
    `).join('') || '<div style="padding:.75rem;color:var(--gray);text-align:center;font-size:.8rem">No locations found</div>';
}

function filterMapList() {
    populateMapList();
}

function selectMapLocation(name) {
    selectedMapLocation = name;
    
    // Update list selection
    document.querySelectorAll('.map-list-item').forEach(el => {
        el.classList.toggle('selected', el.dataset.name === name);
    });
    
    // Get stats for selected location
    const data = mapSelectionMode === 'route' ? 
        crashState.aggregates.byRoute[name] : 
        crashState.aggregates.byNode[name];
    
    if (data) {
        const epdo = calcEPDO(data);
        document.getElementById('selectedLocationName').textContent = name.length > 40 ? name.substring(0, 40) + '...' : name;
        document.getElementById('selTotal').textContent = data.total;
        document.getElementById('selFatal').textContent = data.K || 0;
        document.getElementById('selKA').textContent = (data.K || 0) + (data.A || 0);
        document.getElementById('selEPDO').textContent = epdo.toLocaleString();
        document.getElementById('mapSelectedInfo').style.display = 'block';
        document.getElementById('mapSelected').textContent = name.substring(0, 15) + (name.length > 15 ? '...' : '');
    }
    
    // Filter map to show only selected location
    highlightLocationOnMap(name);
}

function highlightLocationOnMap(name) {
    // Clear existing highlights
    clearRouteHighlights();
    
    // Get points for this location
    const points = crashState.mapPoints.filter(p => 
        mapSelectionMode === 'route' ? p.route === name : p.node === name
    );
    
    if (points.length === 0) return;
    
    // Update map to show only these points
    markerCluster.clearLayers();
    if (markersLayer) crashMap.removeLayer(markersLayer);
    markersLayer.clearLayers();
    if (heatLayer) { crashMap.removeLayer(heatLayer); heatLayer = null; }
    
    // Add markers for selected location
    points.forEach(p => {
        const marker = createMarker(p);
        markerCluster.addLayer(marker);
    });
    crashMap.addLayer(markerCluster);
    
    // Fit bounds to selected points
    if (points.length > 0) {
        const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
        crashMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
    }
    
    // Draw polyline if route mode and enough points
    if (mapSelectionMode === 'route' && points.length >= 2) {
        const sortedPts = points.sort((a, b) => {
            // Sort by longitude for east-west routes, latitude for north-south
            const lngRange = Math.max(...points.map(p => p.lng)) - Math.min(...points.map(p => p.lng));
            const latRange = Math.max(...points.map(p => p.lat)) - Math.min(...points.map(p => p.lat));
            return lngRange > latRange ? a.lng - b.lng : a.lat - b.lat;
        });
        
        const polyline = L.polyline(sortedPts.map(p => [p.lat, p.lng]), {
            color: '#1e40af',
            weight: 4,
            opacity: 0.6,
            dashArray: '10, 5'
        }).addTo(crashMap);
        routePolylines.push(polyline);
    }
    
    // Update stats overlay
    const stats = { total: points.length, fatal: 0, serious: 0, epdo: 0 };
    points.forEach(p => {
        if (p.sev === 'K') stats.fatal++;
        if (p.sev === 'A') stats.serious++;
        stats.epdo += EPDO_WEIGHTS[p.sev] || 0;
    });
    
    document.getElementById('mapCount').textContent = stats.total.toLocaleString();
    document.getElementById('mapFatal').textContent = stats.fatal;
    document.getElementById('mapSerious').textContent = stats.serious;
    document.getElementById('mapEPDO').textContent = stats.epdo.toLocaleString();
}

function clearRouteHighlights() {
    routePolylines.forEach(pl => crashMap.removeLayer(pl));
    routePolylines = [];
}

function clearMapSelection() {
    selectedMapLocation = null;
    document.getElementById('mapSelectedInfo').style.display = 'none';
    document.getElementById('mapSelected').textContent = 'None';
    document.querySelectorAll('.map-list-item').forEach(el => el.classList.remove('selected'));
    clearRouteHighlights();
    updateMapDisplay();
}

function generateLocationReport() {
    if (!selectedMapLocation) return;
    
    // Set up report parameters
    document.getElementById('reportType').value = mapSelectionMode === 'route' ? 'corridor' : 'intersection';
    document.getElementById('reportRoute').value = mapSelectionMode === 'route' ? selectedMapLocation : '';
    document.getElementById('reportTitle').value = `Crash Analysis: ${selectedMapLocation}`;
    
    showTab('reports');
    setTimeout(generateReport, 100);
}

function toggleMapLabels() {
    // Feature for future enhancement - show route labels on map
    const show = document.getElementById('mapShowLabels').checked;
    // Implementation would add text labels to route polylines
}

// Initialize map list when map tab is shown
const originalInitMap = initMap;
initMap = function() {
    originalInitMap();
    populateMapList();
};

document.getElementById('mapYearFilter')?.addEventListener('change', updateMapDisplay);
</script>
<script>
// ============================================================
// HOT SPOTS ANALYSIS
// ============================================================
function analyzeHotspots() {
    if (!crashState.loaded) { alert('Load data first'); return; }
    showLoading('Analyzing hot spots...');
    
    setTimeout(() => {
        const minCrashes = parseInt(document.getElementById('hsMinCrashes').value) || 5;
        const topN = parseInt(document.getElementById('hsTopN').value) || 25;
        const sortBy = document.getElementById('hsSortBy').value;
        const groupBy = document.getElementById('hsGroupBy').value;
        
        const source = groupBy === 'node' ? crashState.aggregates.byNode : crashState.aggregates.byRoute;
        const numYears = crashState.years.length || 1;
        
        let hotspots = Object.entries(source)
            .filter(([_, d]) => d.total >= minCrashes)
            .map(([loc, d]) => {
                const epdo = calcEPDO(d);
                const ka = (d.K || 0) + (d.A || 0);
                const perYear = (d.total / numYears).toFixed(1);
                const topType = d.collisions ? Object.entries(d.collisions).sort((a,b) => b[1]-a[1])[0] : null;
                return { loc, total: d.total, K: d.K||0, A: d.A||0, B: d.B||0, C: d.C||0, O: d.O||0, epdo, ka, perYear, topType: topType ? topType[0] : 'N/A', route: d.route || '' };
            });
        
        if (sortBy === 'epdo') hotspots.sort((a,b) => b.epdo - a.epdo);
        else if (sortBy === 'total') hotspots.sort((a,b) => b.total - a.total);
        else if (sortBy === 'ka') hotspots.sort((a,b) => b.ka - a.ka);
        else hotspots.sort((a,b) => parseFloat(b.perYear) - parseFloat(a.perYear));
        
        crashState.hotspots = hotspots.slice(0, topN);
        renderHotspots();
        hideLoading();
    }, 50);
}

function renderHotspots() {
    document.getElementById('hotspotBody').innerHTML = crashState.hotspots.map((h, i) => `
        <tr>
            <td><span class="rank-badge ${i < 3 ? 'top3' : ''}">${i+1}</span></td>
            <td><strong>${esc(h.loc)}</strong></td>
            <td>${h.total}</td>
            <td><span class="severity-badge severity-K">${h.K}</span></td>
            <td><span class="severity-badge severity-A">${h.A}</span></td>
            <td><span class="severity-badge severity-B">${h.B}</span></td>
            <td><span class="severity-badge severity-C">${h.C}</span></td>
            <td><span class="severity-badge severity-O">${h.O}</span></td>
            <td><strong>${h.epdo.toLocaleString()}</strong></td>
            <td>${h.perYear}</td>
            <td style="font-size:.75rem">${esc(h.topType.substring(0,20))}</td>
            <td><button class="btn-details" onclick="showLocationDetail('${esc(h.loc)}', 'hotspot')">ğŸ“ Details</button></td>
        </tr>
    `).join('');
}

function showLocationModal(loc) {
    const crashes = crashState.sampleRows.filter(r => r[COL.ROUTE] === loc || r[COL.NODE] === loc);
    const stats = { total: crashes.length, K: 0, A: 0, B: 0, C: 0, O: 0 };
    crashes.forEach(c => { const s = (c[COL.SEVERITY]||'').charAt(0); if(stats[s] !== undefined) stats[s]++; });
    
    document.getElementById('modalTitle').textContent = loc;
    document.getElementById('modalBody').innerHTML = `
        <div class="kpi-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:1rem">
            <div class="kpi-card total" style="padding:.75rem"><div class="kpi-value" style="font-size:1.2rem">${stats.total}</div><div class="kpi-label">Total</div></div>
            <div class="kpi-card fatal" style="padding:.75rem"><div class="kpi-value" style="font-size:1.2rem">${stats.K}</div><div class="kpi-label">Fatal</div></div>
            <div class="kpi-card injury-a" style="padding:.75rem"><div class="kpi-value" style="font-size:1.2rem">${stats.A}</div><div class="kpi-label">Serious</div></div>
            <div class="kpi-card injury-bc" style="padding:.75rem"><div class="kpi-value" style="font-size:1.2rem">${stats.B + stats.C}</div><div class="kpi-label">Other Inj</div></div>
            <div class="kpi-card epdo" style="padding:.75rem"><div class="kpi-value" style="font-size:1.2rem">${calcEPDO(stats)}</div><div class="kpi-label">EPDO</div></div>
        </div>
        <h4 style="font-size:.9rem;margin-bottom:.5rem">Recent Crashes</h4>
        <div class="table-wrapper" style="max-height:280px;overflow-y:auto">
            <table class="data-table"><thead><tr><th>Date</th><th>Sev</th><th>Type</th><th>Weather</th><th>Light</th></tr></thead>
            <tbody>${crashes.slice(0,25).map(c => `<tr>
                <td>${c[COL.DATE] || '--'}</td>
                <td><span class="severity-badge severity-${(c[COL.SEVERITY]||'').charAt(0)}">${(c[COL.SEVERITY]||'').charAt(0)}</span></td>
                <td style="font-size:.75rem">${esc((c[COL.COLLISION]||'').substring(0,30))}</td>
                <td style="font-size:.75rem">${esc((c[COL.WEATHER]||'').substring(0,20))}</td>
                <td style="font-size:.75rem">${esc((c[COL.LIGHT]||'').substring(0,20))}</td>
            </tr>`).join('')}</tbody></table>
        </div>
    `;
    document.getElementById('locationModal').classList.add('visible');
}

function zoomToLocation(loc) {
    const points = crashState.mapPoints.filter(p => p.route === loc || p.node === loc);
    if (points.length > 0) {
        showTab('map');
        setTimeout(() => {
            if (crashMap) {
                const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
                crashMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
            }
        }, 150);
    }
}

function exportHotspotsCSV() {
    if (!crashState.hotspots.length) { alert('Run analysis first'); return; }
    const csv = [['Rank','Location','Total','K','A','B','C','O','EPDO','Per Year','Top Type'],
        ...crashState.hotspots.map((h,i) => [i+1, h.loc, h.total, h.K, h.A, h.B, h.C, h.O, h.epdo, h.perYear, h.topType])
    ].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    downloadFile(csv, 'hotspots_analysis.csv', 'text/csv');
}

function exportHotspotsPDF() {
    if (!crashState.hotspots.length) { alert('Run analysis first'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16); doc.text('High-Crash Location Analysis', 14, 20);
    doc.setFontSize(10); doc.text(`Henrico County â€¢ Generated: ${new Date().toLocaleDateString()}`, 14, 27);
    doc.autoTable({
        startY: 35, head: [['#','Location','Total','K','A','B+C','O','EPDO','/Yr']],
        body: crashState.hotspots.map((h,i) => [i+1, h.loc.substring(0,35), h.total, h.K, h.A, h.B+h.C, h.O, h.epdo, h.perYear]),
        styles: { fontSize: 8 }, headStyles: { fillColor: [30, 64, 175] }
    });
    doc.save('hotspots_report.pdf');
}

// ============================================================
// ANALYSIS TAB
// ============================================================
function updateAnalysis() {
    if (!crashState.loaded) return;
    const agg = crashState.aggregates;
    const years = Object.keys(agg.byYear).sort();
    
    // Yearly table
    let prevTotal = null;
    document.getElementById('yearlyBody').innerHTML = years.map(y => {
        const d = agg.byYear[y];
        const epdo = calcEPDO(d);
        const kaRate = pct(d.K + d.A, d.total);
        let change = '--';
        if (prevTotal !== null) {
            const pctChg = ((d.total - prevTotal) / prevTotal * 100).toFixed(1);
            change = `<span style="color:${pctChg > 0 ? 'var(--danger)' : 'var(--success)'}">${pctChg > 0 ? '+' : ''}${pctChg}%</span>`;
        }
        prevTotal = d.total;
        return `<tr><td><strong>${y}</strong></td><td>${d.total.toLocaleString()}</td>
            <td><span class="severity-badge severity-K">${d.K}</span></td>
            <td><span class="severity-badge severity-A">${d.A}</span></td>
            <td><span class="severity-badge severity-B">${d.B}</span></td>
            <td><span class="severity-badge severity-C">${d.C}</span></td>
            <td><span class="severity-badge severity-O">${d.O}</span></td>
            <td><strong>${epdo.toLocaleString()}</strong></td><td>${kaRate}%</td>
            <td>${d.ped || 0}</td><td>${d.bike || 0}</td><td>${change}</td></tr>`;
    }).join('');
    
    // YoY chart
    if (years.length > 1) {
        const changes = [];
        for (let i = 1; i < years.length; i++) {
            const prev = agg.byYear[years[i-1]].total;
            const curr = agg.byYear[years[i]].total;
            changes.push({ year: years[i], pct: prev > 0 ? ((curr - prev) / prev * 100) : 0 });
        }
        createChart('chartYoY', 'bar', {
            labels: changes.map(c => c.year),
            datasets: [{ label: '% Change', data: changes.map(c => c.pct.toFixed(1)), backgroundColor: changes.map(c => c.pct > 0 ? '#dc2626' : '#059669') }]
        });
    }
    
    // K+A by year
    createChart('chartKAYear', 'line', {
        labels: years,
        datasets: [
            { label: 'Fatal (K)', data: years.map(y => agg.byYear[y].K), borderColor: '#dc2626', backgroundColor: 'rgba(220,38,38,.1)', fill: true },
            { label: 'Serious (A)', data: years.map(y => agg.byYear[y].A), borderColor: '#ea580c', backgroundColor: 'rgba(234,88,12,.1)', fill: true }
        ]
    });
    
    // Day of week
    const dowLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    createChart('chartDOW', 'bar', {
        labels: dowLabels,
        datasets: [{ label: 'Crashes', data: dowLabels.map((_,i) => agg.byDOW[i] || 0), backgroundColor: '#1e40af' }]
    });
    
    // Monthly
    const monthLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    createChart('chartMonth', 'bar', {
        labels: monthLabels,
        datasets: [{ label: 'Crashes', data: monthLabels.map((_,i) => agg.byMonth[i] || 0), backgroundColor: '#7c3aed' }]
    });
    
    // Functional class
    const fcSorted = Object.entries(agg.byFuncClass).sort((a,b) => b[1].total - a[1].total);
    createChart('chartFuncClass', 'bar', {
        labels: fcSorted.slice(0,8).map(f => f[0].substring(0,20)),
        datasets: [{ label: 'Crashes', data: fcSorted.slice(0,8).map(f => f[1].total), backgroundColor: '#059669' }]
    }, { indexAxis: 'y' });
    
    const total = crashState.totalRows;
    document.getElementById('funcClassBody').innerHTML = fcSorted.slice(0,10).map(([fc, d]) => 
        `<tr><td>${esc(fc)}</td><td>${d.total}</td><td>${d.K}</td><td>${d.A}</td><td>${calcEPDO(d)}</td><td>${pct(d.total, total)}%</td></tr>`
    ).join('');
}

// ============================================================
// INTERSECTION TAB
// ============================================================
function updateIntersectionTab() {
    const agg = crashState.aggregates;
    const int = agg.intersection;
    const total = crashState.totalRows;
    
    document.getElementById('intTotal').textContent = int.total.toLocaleString();
    document.getElementById('intFatal').textContent = int.K;
    document.getElementById('intSerious').textContent = int.A;
    document.getElementById('intPct').textContent = pct(int.total, total) + '%';
    
    // Intersection type chart
    const intTypes = Object.entries(agg.byIntType).sort((a,b) => b[1].total - a[1].total).slice(0,8);
    createChart('chartIntType', 'bar', {
        labels: intTypes.map(t => t[0].substring(0,20)),
        datasets: [{ label: 'Crashes', data: intTypes.map(t => t[1].total), backgroundColor: '#1e40af' }]
    }, { indexAxis: 'y' });
    
    // Traffic control chart with custom legend
    const tcSorted = Object.entries(agg.byTrafficCtrl).sort((a,b) => b[1] - a[1]).slice(0,8);
    const tcLabels = tcSorted.map(t => t[0].substring(0,20));
    const tcData = tcSorted.map(t => t[1]);
    const tcColors = ['#dc2626','#f59e0b','#22c55e','#3b82f6','#8b5cf6','#ec4899','#64748b','#0ea5e9'];
    const tcTotal = tcData.reduce((a,b) => a+b, 0);
    
    createChart('chartTrafficControl', 'doughnut', {
        labels: tcLabels,
        datasets: [{ data: tcData, backgroundColor: tcColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    buildCustomLegend('legendTrafficControl', tcLabels, tcData, tcColors, tcTotal);
    
    // Intersection collision types - filter sample rows
    const intCrashes = crashState.sampleRows.filter(r => isIntersection(r));
    const intCollisions = {};
    intCrashes.forEach(r => { const c = r[COL.COLLISION] || 'Unknown'; intCollisions[c] = (intCollisions[c]||0)+1; });
    const icSorted = Object.entries(intCollisions).sort((a,b) => b[1]-a[1]).slice(0,8);
    createChart('chartIntCollision', 'bar', {
        labels: icSorted.map(c => c[0].substring(0,20)),
        datasets: [{ label: 'Crashes', data: icSorted.map(c => c[1]), backgroundColor: '#7c3aed' }]
    }, { indexAxis: 'y' });
    
    // Int vs non-int severity comparison
    const nonInt = agg.nonIntersection;
    createChart('chartIntSeverity', 'bar', {
        labels: ['K','A','B','C','O'],
        datasets: [
            { label: 'Intersection', data: [int.K, int.A, int.B, int.C, int.O], backgroundColor: '#1e40af' },
            { label: 'Non-Intersection', data: [nonInt.K, nonInt.A, nonInt.B, nonInt.C, nonInt.O], backgroundColor: '#64748b' }
        ]
    });
    
    // Top intersection nodes
    const nodeSorted = Object.entries(agg.byNode).sort((a,b) => b[1].total - a[1].total).slice(0,15);
    document.getElementById('intBody').innerHTML = nodeSorted.map(([node, d]) =>
        `<tr><td>${esc(node)}</td><td style="font-size:.75rem">${esc(d.route||'')}</td><td>${d.total}</td>
        <td><span class="severity-badge severity-K">${d.K||0}</span></td>
        <td><span class="severity-badge severity-A">${d.A||0}</span></td>
        <td>${calcEPDO(d)}</td><td style="font-size:.75rem">${esc((d.ctrl||'').substring(0,20))}</td></tr>`
    ).join('');
}
</script>
<script>
// ============================================================
// PEDESTRIAN / BICYCLE TAB
// ============================================================
function updatePedBikeTab() {
    const ped = crashState.aggregates.ped;
    const bike = crashState.aggregates.bike;
    const years = crashState.years;
    
    // Pedestrian KPIs
    const pedEPDO = calcEPDO(ped);
    const pedKARate = ped.total > 0 ? ((ped.K + ped.A) / ped.total * 100).toFixed(1) : 0;
    document.getElementById('pedTotal').textContent = ped.total.toLocaleString();
    document.getElementById('pedFatal').textContent = ped.K;
    document.getElementById('pedKA').textContent = ped.K + ped.A;
    document.getElementById('pedEPDO').textContent = pedEPDO.toLocaleString();
    document.getElementById('pedKARate').textContent = pedKARate + '%';
    
    // Bicycle KPIs
    const bikeEPDO = calcEPDO(bike);
    const bikeKARate = bike.total > 0 ? ((bike.K + bike.A) / bike.total * 100).toFixed(1) : 0;
    document.getElementById('bikeTotal').textContent = bike.total.toLocaleString();
    document.getElementById('bikeFatal').textContent = bike.K;
    document.getElementById('bikeKA').textContent = bike.K + bike.A;
    document.getElementById('bikeEPDO').textContent = bikeEPDO.toLocaleString();
    document.getElementById('bikeKARate').textContent = bikeKARate + '%';
    
    // Pedestrian Year Chart - Bar style for clearer visualization
    createChart('chartPedYear', 'bar', {
        labels: years,
        datasets: [{ 
            label: 'Pedestrian Crashes', 
            data: years.map(y => ped.byYear[y] || 0), 
            backgroundColor: '#0891b2',
            borderRadius: 4
        }]
    }, { plugins: { legend: { display: false } } });
    
    // Pedestrian Light Condition with custom legend
    const pedLight = Object.entries(ped.byLight).sort((a,b) => b[1]-a[1]).slice(0,6);
    const lightColors = ['#fcd34d','#1e293b','#94a3b8','#f97316','#6366f1','#22c55e'];
    
    createChart('chartPedLight', 'doughnut', {
        labels: pedLight.map(l => l[0]),
        datasets: [{ data: pedLight.map(l => l[1]), backgroundColor: lightColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    // Build ped light legend with numbers
    let pedLightLegendHtml = '';
    pedLight.forEach((l, i) => {
        const pctVal = ped.total > 0 ? (l[1] / ped.total * 100).toFixed(1) : 0;
        pedLightLegendHtml += `<div style="display:flex;align-items:center;gap:.5rem">
            <span style="width:12px;height:12px;background:${lightColors[i]};border-radius:2px"></span>
            <span style="flex:1">${l[0].substring(0,20)}</span>
            <span style="font-weight:600">${l[1]}</span>
            <span style="color:#64748b">(${pctVal}%)</span>
        </div>`;
    });
    document.getElementById('pedLightLegend').innerHTML = pedLightLegendHtml;
    
    // Bicycle Year Chart
    createChart('chartBikeYear', 'bar', {
        labels: years,
        datasets: [{ 
            label: 'Bicycle Crashes', 
            data: years.map(y => bike.byYear[y] || 0), 
            backgroundColor: '#059669',
            borderRadius: 4
        }]
    }, { plugins: { legend: { display: false } } });
    
    // Bicycle Light Condition with custom legend
    const bikeLight = Object.entries(bike.byLight).sort((a,b) => b[1]-a[1]).slice(0,6);
    
    createChart('chartBikeLight', 'doughnut', {
        labels: bikeLight.map(l => l[0]),
        datasets: [{ data: bikeLight.map(l => l[1]), backgroundColor: lightColors, borderWidth: 2, borderColor: '#fff' }]
    }, { cutout: '50%', plugins: { legend: { display: false } } });
    
    // Build bike light legend with numbers
    let bikeLightLegendHtml = '';
    bikeLight.forEach((l, i) => {
        const pctVal = bike.total > 0 ? (l[1] / bike.total * 100).toFixed(1) : 0;
        bikeLightLegendHtml += `<div style="display:flex;align-items:center;gap:.5rem">
            <span style="width:12px;height:12px;background:${lightColors[i]};border-radius:2px"></span>
            <span style="flex:1">${l[0].substring(0,20)}</span>
            <span style="font-weight:600">${l[1]}</span>
            <span style="color:#64748b">(${pctVal}%)</span>
        </div>`;
    });
    document.getElementById('bikeLightLegend').innerHTML = bikeLightLegendHtml;
    
    // Populate year dropdowns for Ped/Bike location tables
    const pedYearSelect = document.getElementById('pedYearFilter');
    const bikeYearSelect = document.getElementById('bikeYearFilter');
    if (pedYearSelect && pedYearSelect.options.length <= 1) {
        years.forEach(y => {
            pedYearSelect.add(new Option(y, y));
            bikeYearSelect.add(new Option(y, y));
        });
    }
    
    // Update location tables
    updatePedLocations();
    updateBikeLocations();
    
    // Comparison table
    const totalVRU = ped.total + bike.total;
    const totalVRUK = ped.K + bike.K;
    const totalVRUKA = (ped.K + ped.A) + (bike.K + bike.A);
    const totalVRUEPDO = pedEPDO + bikeEPDO;
    
    document.getElementById('pedBikeCompareBody').innerHTML = `
        <tr><td><strong>Total Crashes</strong></td>
            <td style="text-align:center;font-size:1.1rem;font-weight:600;color:#0891b2">${ped.total.toLocaleString()}</td>
            <td style="text-align:center;font-size:1.1rem;font-weight:600;color:#059669">${bike.total.toLocaleString()}</td>
            <td style="text-align:center;font-size:1.1rem;font-weight:700">${totalVRU.toLocaleString()}</td></tr>
        <tr><td><strong>Fatal (K)</strong></td>
            <td style="text-align:center"><span class="severity-badge severity-K">${ped.K}</span></td>
            <td style="text-align:center"><span class="severity-badge severity-K">${bike.K}</span></td>
            <td style="text-align:center"><span class="severity-badge severity-K">${totalVRUK}</span></td></tr>
        <tr><td><strong>Serious Injury (K+A)</strong></td>
            <td style="text-align:center"><span class="severity-badge severity-A">${ped.K + ped.A}</span></td>
            <td style="text-align:center"><span class="severity-badge severity-A">${bike.K + bike.A}</span></td>
            <td style="text-align:center"><span class="severity-badge severity-A">${totalVRUKA}</span></td></tr>
        <tr><td><strong>EPDO Score</strong></td>
            <td style="text-align:center;font-weight:600">${pedEPDO.toLocaleString()}</td>
            <td style="text-align:center;font-weight:600">${bikeEPDO.toLocaleString()}</td>
            <td style="text-align:center;font-weight:700">${totalVRUEPDO.toLocaleString()}</td></tr>
        <tr><td><strong>K+A Rate</strong></td>
            <td style="text-align:center;color:${parseFloat(pedKARate) > 25 ? '#dc2626' : '#059669'}">${pedKARate}%</td>
            <td style="text-align:center;color:${parseFloat(bikeKARate) > 25 ? '#dc2626' : '#059669'}">${bikeKARate}%</td>
            <td style="text-align:center">${totalVRU > 0 ? (totalVRUKA / totalVRU * 100).toFixed(1) : 0}%</td></tr>
        <tr><td><strong>% of All Crashes</strong></td>
            <td style="text-align:center">${(ped.total / crashState.totalRows * 100).toFixed(2)}%</td>
            <td style="text-align:center">${(bike.total / crashState.totalRows * 100).toFixed(2)}%</td>
            <td style="text-align:center">${(totalVRU / crashState.totalRows * 100).toFixed(2)}%</td></tr>
    `;
    
    // Comparison line chart
    createChart('chartPedBikeCompare', 'line', {
        labels: years,
        datasets: [
            { label: 'ğŸš¶ Pedestrian', data: years.map(y => ped.byYear[y] || 0), borderColor: '#0891b2', backgroundColor: 'rgba(8,145,178,.1)', fill: true, tension: 0.3 },
            { label: 'ğŸš´ Bicycle', data: years.map(y => bike.byYear[y] || 0), borderColor: '#059669', backgroundColor: 'rgba(5,150,105,.1)', fill: true, tension: 0.3 }
        ]
    }, { 
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
    });
    
    // Update People Analysis
    updatePeopleAnalysis();
}

// ============================================================
// PED/BIKE LOCATION TABLES WITH DETAILS
// ============================================================
function updatePedLocations() {
    const yearFilter = document.getElementById('pedYearFilter')?.value || '';
    let crashes = crashState.sampleRows.filter(c => isYes(c[COL.PED]));
    
    if (yearFilter) {
        crashes = crashes.filter(c => String(c[COL.YEAR]) === yearFilter);
    }
    
    // Group by route
    const byRoute = {};
    crashes.forEach(c => {
        const r = c[COL.ROUTE] || 'Unknown';
        if (!byRoute[r]) byRoute[r] = { crashes: [], K: 0, A: 0, B: 0, C: 0, O: 0 };
        byRoute[r].crashes.push(c);
        const sev = (c[COL.SEVERITY]||'').charAt(0);
        if (byRoute[r][sev] !== undefined) byRoute[r][sev]++;
    });
    
    const routes = Object.entries(byRoute).sort((a,b) => b[1].crashes.length - a[1].crashes.length).slice(0,10);
    
    document.getElementById('pedRouteBody').innerHTML = routes.map(([r, d]) => {
        const cnt = d.crashes.length;
        const epdo = d.K*462 + d.A*62 + d.B*12 + d.C*5 + d.O;
        return `<tr>
            <td style="font-size:.8rem">${esc(r.substring(0,30))}</td>
            <td><strong>${cnt}</strong></td>
            <td><span class="severity-badge severity-K">${d.K}</span></td>
            <td><span class="severity-badge severity-A">${d.A}</span></td>
            <td>${epdo.toLocaleString()}</td>
            <td><button class="btn-details" onclick="showLocationDetail('${esc(r)}', 'ped')">ğŸ“ Details</button></td>
        </tr>`;
    }).join('');
}

function updateBikeLocations() {
    const yearFilter = document.getElementById('bikeYearFilter')?.value || '';
    let crashes = crashState.sampleRows.filter(c => isYes(c[COL.BIKE]));
    
    if (yearFilter) {
        crashes = crashes.filter(c => String(c[COL.YEAR]) === yearFilter);
    }
    
    // Group by route
    const byRoute = {};
    crashes.forEach(c => {
        const r = c[COL.ROUTE] || 'Unknown';
        if (!byRoute[r]) byRoute[r] = { crashes: [], K: 0, A: 0, B: 0, C: 0, O: 0 };
        byRoute[r].crashes.push(c);
        const sev = (c[COL.SEVERITY]||'').charAt(0);
        if (byRoute[r][sev] !== undefined) byRoute[r][sev]++;
    });
    
    const routes = Object.entries(byRoute).sort((a,b) => b[1].crashes.length - a[1].crashes.length).slice(0,10);
    
    document.getElementById('bikeRouteBody').innerHTML = routes.map(([r, d]) => {
        const cnt = d.crashes.length;
        const epdo = d.K*462 + d.A*62 + d.B*12 + d.C*5 + d.O;
        return `<tr>
            <td style="font-size:.8rem">${esc(r.substring(0,30))}</td>
            <td><strong>${cnt}</strong></td>
            <td><span class="severity-badge severity-K">${d.K}</span></td>
            <td><span class="severity-badge severity-A">${d.A}</span></td>
            <td>${epdo.toLocaleString()}</td>
            <td><button class="btn-details" onclick="showLocationDetail('${esc(r)}', 'bike')">ğŸ“ Details</button></td>
        </tr>`;
    }).join('');
}

function showLocationDetail(location, type) {
    let crashes;
    let color;
    let icon;
    
    if (type === 'ped') {
        crashes = crashState.sampleRows.filter(c => c[COL.ROUTE] === location && isYes(c[COL.PED]));
        color = '#0891b2';
        icon = 'ğŸš¶';
    } else if (type === 'bike') {
        crashes = crashState.sampleRows.filter(c => c[COL.ROUTE] === location && isYes(c[COL.BIKE]));
        color = '#059669';
        icon = 'ğŸš´';
    } else {
        crashes = crashState.sampleRows.filter(c => c[COL.ROUTE] === location || c[COL.NODE] === location);
        color = '#1e40af';
        icon = 'ğŸ“';
    }
    
    if (crashes.length === 0) return;
    
    // Calculate stats
    const stats = { total: crashes.length, K: 0, A: 0, B: 0, C: 0, O: 0 };
    const collisionTypes = {};
    
    crashes.forEach(c => {
        const sev = (c[COL.SEVERITY]||'').charAt(0);
        if (stats[sev] !== undefined) stats[sev]++;
        const ct = c[COL.COLLISION] || 'Unknown';
        collisionTypes[ct] = (collisionTypes[ct] || 0) + 1;
    });
    
    const epdo = stats.K*462 + stats.A*62 + stats.B*12 + stats.C*5 + stats.O;
    const collisionsSorted = Object.entries(collisionTypes).sort((a,b) => b[1]-a[1]);
    
    // Sort crashes by date (most recent first)
    crashes.sort((a,b) => new Date(b[COL.DATE]) - new Date(a[COL.DATE]));
    
    document.getElementById('modalLocationTitle').innerHTML = `${icon} ${location}`;
    document.getElementById('modalBody').innerHTML = `
        <div class="modal-kpi-grid">
            <div class="modal-kpi blue">
                <div class="modal-kpi-value">${stats.total}</div>
                <div class="modal-kpi-label">Total Crashes</div>
            </div>
            <div class="modal-kpi red">
                <div class="modal-kpi-value">${stats.K}</div>
                <div class="modal-kpi-label">Fatal</div>
            </div>
            <div class="modal-kpi purple">
                <div class="modal-kpi-value">${epdo.toLocaleString()}</div>
                <div class="modal-kpi-label">EPDO</div>
            </div>
        </div>
        
        <h4 style="margin-bottom:.5rem;color:#1e293b">Collision Types</h4>
        <div style="margin-bottom:1.25rem;background:#f8fafc;border-radius:8px;padding:.75rem">
            ${collisionsSorted.slice(0, 5).map(([type, count]) => `
                <div class="metric-row">
                    <span>${esc(type)}</span>
                    <span class="metric-value">${count}</span>
                </div>
            `).join('')}
        </div>
        
        <h4 style="margin-bottom:.5rem;color:#1e293b">Recent Crashes</h4>
        <div class="table-wrapper" style="max-height:300px;overflow-y:auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Severity</th>
                        <th>Type</th>
                        <th>Weather</th>
                    </tr>
                </thead>
                <tbody>
                    ${crashes.slice(0, 20).map(c => `
                        <tr>
                            <td>${c[COL.DATE] ? new Date(c[COL.DATE]).toLocaleDateString() : 'N/A'}</td>
                            <td><span class="severity-badge severity-${(c[COL.SEVERITY]||'O').charAt(0)}">${(c[COL.SEVERITY]||'O').charAt(0)}</span></td>
                            <td>${esc((c[COL.COLLISION] || 'Unknown').substring(0, 25))}</td>
                            <td>${esc((c[COL.WEATHER] || 'Unknown').substring(0, 20))}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    // Update modal header color based on type
    document.querySelector('.modal-header').style.background = color;
    document.getElementById('locationModal').classList.add('visible');
}

function closeModal() {
    document.getElementById('locationModal').classList.remove('visible');
}

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('locationModal');
    if (e.target === modal) {
        closeModal();
    }
});

// ============================================================
// PEOPLE INJURY ANALYSIS
// ============================================================
function updatePeopleAnalysis() {
    if (!crashState.loaded) return;
    
    const filter = document.getElementById('peopleInjuryFilter')?.value || 'all';
    const rows = crashState.sampleRows;
    
    // Debug: check if rows exist
    if (!rows || rows.length === 0) {
        console.log('No sample rows available for People Analysis');
        return;
    }
    
    // Calculate people counts based on filter
    let peopleData = { walking: 0, motorcycle: 0, bike: 0, noBelt: 0, protected: 0, seniorBelted: 0 };
    let peopleByYear = {};
    let factors = { speed: 0, speedNo: 0, belt: 0, noBeltCnt: 0, alcohol: 0, alcoholNo: 0, distracted: 0, distractedNo: 0, senior: 0, young: 0, other: 0 };
    let userTypes = { driver: 0, pedestrian: 0, passenger: 0, other: 0 };
    
    rows.forEach(row => {
        const year = row[COL.YEAR];
        const kPeople = parseInt(row[COL.K] || 0);
        const aPeople = parseInt(row[COL.A] || 0);
        const bPeople = parseInt(row[COL.B] || 0);
        const cPeople = parseInt(row[COL.C] || 0);
        
        let peopleCount = 0;
        if (filter === 'all') peopleCount = kPeople + aPeople + bPeople + cPeople;
        else if (filter === 'K') peopleCount = kPeople;
        else if (filter === 'A') peopleCount = aPeople;
        else if (filter === 'B') peopleCount = bPeople;
        else if (filter === 'C') peopleCount = cPeople;
        
        if (peopleCount === 0) return;
        
        // By year
        if (year) {
            peopleByYear[year] = (peopleByYear[year] || 0) + peopleCount;
        }
        
        // By type - check various conditions
        const isPed = isYes(row[COL.PED]);
        const isMoto = isYes(row[COL.MOTORCYCLE]);
        const isBike = isYes(row[COL.BIKE]);
        const isUnbelted = row[COL.UNRESTRAINED] === 'Unbelted';
        const isSenior = isYes(row[COL.SENIOR]);
        
        if (isPed) {
            peopleData.walking += peopleCount;
            userTypes.pedestrian += peopleCount;
        } else if (isMoto) {
            peopleData.motorcycle += peopleCount;
            userTypes.driver += peopleCount;
        } else if (isBike) {
            peopleData.bike += peopleCount;
            userTypes.other += peopleCount;
        } else if (isUnbelted) {
            peopleData.noBelt += peopleCount;
            userTypes.driver += Math.ceil(peopleCount * 0.7);
            userTypes.passenger += Math.floor(peopleCount * 0.3);
        } else if (isSenior) {
            peopleData.seniorBelted += peopleCount;
            userTypes.driver += Math.ceil(peopleCount * 0.8);
            userTypes.passenger += Math.floor(peopleCount * 0.2);
        } else {
            peopleData.protected += peopleCount;
            userTypes.driver += Math.ceil(peopleCount * 0.7);
            userTypes.passenger += Math.floor(peopleCount * 0.3);
        }
        
        // Contributing factors
        if (isYes(row[COL.SPEED])) factors.speed += peopleCount;
        else if (!isPed) factors.speedNo += peopleCount;
        
        if (isUnbelted) factors.noBeltCnt += peopleCount;
        else if (!isPed) factors.belt += peopleCount;
        
        if (isYes(row[COL.ALCOHOL])) factors.alcohol += peopleCount;
        else factors.alcoholNo += peopleCount;
        
        if (isYes(row[COL.DISTRACTED])) factors.distracted += peopleCount;
        else factors.distractedNo += peopleCount;
        
        if (isSenior) factors.senior += peopleCount;
        else if (isYes(row[COL.YOUNG])) factors.young += peopleCount;
        else factors.other += peopleCount;
    });
    
    const totalPeople = Object.values(peopleData).reduce((a, b) => a + b, 0);
    document.getElementById('peopleTotalNum').textContent = totalPeople.toLocaleString();
    
    // Build custom legend for people type chart
    const typeColors = ['#f97316', '#eab308', '#22c55e', '#3b82f6', '#06b6d4', '#8b5cf6'];
    const typeLabels = ['Walking', 'Riding Motorcycle', 'Riding Bike', 'No Belt', 'Protected (not senior)', 'Senior wearing seatbelt'];
    const typeData = [peopleData.walking, peopleData.motorcycle, peopleData.bike, peopleData.noBelt, peopleData.protected, peopleData.seniorBelted];
    
    let legendHtml = '';
    typeLabels.forEach((label, i) => {
        const val = typeData[i];
        const pctVal = totalPeople > 0 ? (val / totalPeople * 100).toFixed(1) : 0;
        legendHtml += `<div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem">
            <span style="width:14px;height:14px;background:${typeColors[i]};border-radius:3px;flex-shrink:0"></span>
            <span style="flex:1">${label}</span>
            <span style="font-weight:600;min-width:50px;text-align:right">${val.toLocaleString()}</span>
            <span style="color:#64748b;min-width:45px;text-align:right">(${pctVal}%)</span>
        </div>`;
    });
    document.getElementById('peopleTypeLegend').innerHTML = legendHtml;
    
    // People type donut chart - no built-in legend since we have custom
    createChart('chartPeopleType', 'doughnut', {
        labels: typeLabels,
        datasets: [{
            data: typeData,
            backgroundColor: typeColors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    }, { cutout: '65%', plugins: { legend: { display: false } } });
    
    // People by year bar chart with data labels
    const years = Object.keys(peopleByYear).sort();
    createChart('chartPeopleYear', 'bar', {
        labels: years,
        datasets: [{
            label: filter === 'all' ? 'People Injured' : `${filter} Injuries`,
            data: years.map(y => peopleByYear[y] || 0),
            backgroundColor: '#1e40af',
            borderRadius: 4
        }]
    }, { 
        plugins: { 
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(ctx) {
                        return `People: ${ctx.raw.toLocaleString()}`;
                    }
                }
            }
        },
        scales: {
            y: { beginAtZero: true, ticks: { font: { size: 11 } } },
            x: { ticks: { font: { size: 11 } } }
        }
    });
    
    // Contributing factor charts with custom side legends
    const createFactorChart = (id, labels, data, colors) => {
        const total = data.reduce((a, b) => a + b, 0);
        
        createChart(id, 'pie', {
            labels: labels,
            datasets: [{ 
                data: data, 
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        }, { 
            plugins: { legend: { display: false } }, 
            maintainAspectRatio: true 
        });
        
        // Build custom legend - replace 'chart' with 'legend' in ID
        const legendId = id.replace('chart', 'legend');
        buildCustomLegend(legendId, labels, data, colors, total);
    };
    
    createFactorChart('chartFactorSpeed', ['Speeding', 'Not Speeding', 'N/A'], 
        [factors.speed, factors.speedNo, peopleData.walking], ['#64748b', '#cbd5e1', '#e2e8f0']);
    
    createFactorChart('chartFactorBelt', ['Unrestrained', 'Restrained', 'N/A'], 
        [factors.noBeltCnt, factors.belt, peopleData.walking], ['#3b82f6', '#cbd5e1', '#e2e8f0']);
    
    createFactorChart('chartFactorAlcohol', ['Alcohol', 'Not Alcohol'], 
        [factors.alcohol, factors.alcoholNo], ['#22c55e', '#cbd5e1']);
    
    createFactorChart('chartFactorDistracted', ['Distracted', 'Not Distracted'], 
        [factors.distracted, factors.distractedNo], ['#64748b', '#cbd5e1']);
    
    createFactorChart('chartFactorAge', ['Young (15-20)', 'Senior (65+)', 'Other'], 
        [factors.young, factors.senior, factors.other], ['#3b82f6', '#64748b', '#cbd5e1']);
    
    createFactorChart('chartFactorUserType', ['Driver', 'Pedestrian', 'Passenger', 'Other'], 
        [userTypes.driver, userTypes.pedestrian, userTypes.passenger, userTypes.other], ['#3b82f6', '#f97316', '#64748b', '#cbd5e1']);
}

// ============================================================
// SEARCH TAB
// ============================================================
function searchCrashes() {
    const text = (document.getElementById('searchText').value || '').toLowerCase();
    const year = document.getElementById('searchYear').value;
    const sev = document.getElementById('searchSeverity').value;
    const pb = document.getElementById('searchPedBike').value;
    
    searchResults = crashState.sampleRows.filter(row => {
        if (year && String(row[COL.YEAR]) !== year) return false;
        if (sev && (row[COL.SEVERITY]||'').charAt(0) !== sev) return false;
        if (pb === 'ped' && !isYes(row[COL.PED])) return false;
        if (pb === 'bike' && !isYes(row[COL.BIKE])) return false;
        if (text) {
            const searchable = [row[COL.ROUTE], row[COL.COLLISION], row[COL.WEATHER], row[COL.NODE]].join(' ').toLowerCase();
            if (!searchable.includes(text)) return false;
        }
        return true;
    });
    
    currentSearchPage = 1;
    renderSearchResults();
}

function clearSearch() {
    document.getElementById('searchText').value = '';
    document.getElementById('searchYear').value = '';
    document.getElementById('searchSeverity').value = '';
    document.getElementById('searchPedBike').value = '';
    searchResults = [...crashState.sampleRows];
    currentSearchPage = 1;
    renderSearchResults();
}

function renderSearchResults() {
    const start = (currentSearchPage - 1) * PAGE_SIZE;
    const page = searchResults.slice(start, start + PAGE_SIZE);
    
    document.getElementById('searchBody').innerHTML = page.map(r => {
        const flags = [];
        if (isYes(r[COL.PED])) flags.push('ğŸš¶');
        if (isYes(r[COL.BIKE])) flags.push('ğŸš´');
        if (isYes(r[COL.ALCOHOL])) flags.push('ğŸº');
        if (isYes(r[COL.SPEED])) flags.push('âš¡');
        if (isYes(r[COL.HITRUN])) flags.push('ğŸš—ğŸ’¨');
        return `<tr>
            <td>${r[COL.DATE] || '--'}</td>
            <td>${fmtTime(r[COL.TIME])}</td>
            <td><span class="severity-badge severity-${(r[COL.SEVERITY]||'').charAt(0)}">${(r[COL.SEVERITY]||'').charAt(0)}</span></td>
            <td style="font-size:.75rem">${esc((r[COL.ROUTE]||'').substring(0,25))}</td>
            <td style="font-size:.75rem">${esc((r[COL.NODE]||'').substring(0,15))}</td>
            <td style="font-size:.75rem">${esc((r[COL.COLLISION]||'').substring(0,25))}</td>
            <td style="font-size:.75rem">${esc((r[COL.WEATHER]||'').substring(0,15))}</td>
            <td style="font-size:.75rem">${esc((r[COL.LIGHT]||'').substring(0,15))}</td>
            <td>${flags.join(' ') || '-'}</td>
        </tr>`;
    }).join('') || '<tr><td colspan="9" style="text-align:center;color:var(--gray)">No results</td></tr>';
    
    renderSearchPagination();
}

function renderSearchPagination() {
    const totalPages = Math.ceil(searchResults.length / PAGE_SIZE);
    if (totalPages <= 1) {
        document.getElementById('searchPagination').innerHTML = `<span style="color:var(--gray);font-size:.8rem">${searchResults.length} results</span>`;
        return;
    }
    let html = `<span style="color:var(--gray);font-size:.8rem;margin-right:.5rem">${searchResults.length.toLocaleString()} results</span>`;
    html += `<button class="page-btn" onclick="goSearchPage(1)" ${currentSearchPage===1?'disabled':''}>Â«</button>`;
    html += `<button class="page-btn" onclick="goSearchPage(${currentSearchPage-1})" ${currentSearchPage===1?'disabled':''}>â€¹</button>`;
    const start = Math.max(1, currentSearchPage - 2), end = Math.min(totalPages, currentSearchPage + 2);
    for (let i = start; i <= end; i++) html += `<button class="page-btn ${i===currentSearchPage?'active':''}" onclick="goSearchPage(${i})">${i}</button>`;
    html += `<button class="page-btn" onclick="goSearchPage(${currentSearchPage+1})" ${currentSearchPage===totalPages?'disabled':''}>â€º</button>`;
    html += `<button class="page-btn" onclick="goSearchPage(${totalPages})" ${currentSearchPage===totalPages?'disabled':''}>Â»</button>`;
    document.getElementById('searchPagination').innerHTML = html;
}

function goSearchPage(p) { currentSearchPage = p; renderSearchResults(); }

function exportSearchCSV() {
    if (!searchResults.length) { alert('No results'); return; }
    const headers = ['Date','Time','Severity','Route','Node','Collision Type','Weather','Light','Ped','Bike','Alcohol','Speed'];
    const rows = searchResults.map(r => [r[COL.DATE], r[COL.TIME], r[COL.SEVERITY], r[COL.ROUTE], r[COL.NODE], r[COL.COLLISION], r[COL.WEATHER], r[COL.LIGHT], r[COL.PED], r[COL.BIKE], r[COL.ALCOHOL], r[COL.SPEED]]);
    const csv = [headers, ...rows].map(r => r.map(c => `"${c||''}"`).join(',')).join('\n');
    downloadFile(csv, 'crash_search_results.csv', 'text/csv');
}

// Init search when tab shown
document.querySelector('[data-tab="search"]').addEventListener('click', () => {
    if (crashState.loaded && searchResults.length === 0) {
        searchResults = [...crashState.sampleRows];
        renderSearchResults();
    }
});
</script>
<script>
// ============================================================
// PROFESSIONAL REPORTS - For Traffic Engineers
// ============================================================
function updateReportOptions() {
    const type = document.getElementById('reportType').value;
    document.getElementById('reportRouteGroup').style.display = (type === 'corridor' || type === 'intersection') ? 'flex' : 'none';
    document.getElementById('reportNodeGroup').style.display = type === 'intersection' ? 'flex' : 'none';
}

function generateReport() {
    const type = document.getElementById('reportType').value;
    showLoading('Generating report...');
    
    setTimeout(() => {
        const title = document.getElementById('reportTitle').value || 'Crash Analysis Report';
        const author = document.getElementById('reportAuthor').value || 'Traffic Engineering Division';
        const route = document.getElementById('reportRoute').value;
        const startYear = document.getElementById('reportStartYear').value;
        const endYear = document.getElementById('reportEndYear').value;
        
        // Filter data for report
        let crashes = crashState.sampleRows;
        if (route) crashes = crashes.filter(r => r[COL.ROUTE] === route);
        if (startYear) crashes = crashes.filter(r => parseInt(r[COL.YEAR]) >= parseInt(startYear));
        if (endYear) crashes = crashes.filter(r => parseInt(r[COL.YEAR]) <= parseInt(endYear));
        
        // Generate based on type
        if (type === 'systemwide') generateSystemwideReport(crashes, title, author);
        else if (type === 'corridor') generateCorridorReport(crashes, route || 'All Routes', title, author);
        else if (type === 'safety') generateSafetyReport(crashes, title, author);
        else if (type === 'pedbike') generatePedBikeReport(crashes, title, author);
        else if (type === 'trend') generateTrendReport(crashes, title, author);
        else if (type === 'intersection') generateIntersectionReport(crashes, route, title, author);
        
        document.getElementById('reportOutput').style.display = 'block';
        hideLoading();
        
        // Scroll to report
        document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth' });
    }, 100);
}

function generateSystemwideReport(crashes, title, author) {
    const stats = computeStats(crashes);
    const yearRange = getYearRange(crashes);
    
    document.getElementById('rptTitle').textContent = title;
    document.getElementById('rptSubtitle').textContent = `Henrico County System-Wide Analysis`;
    document.getElementById('rptMeta').textContent = `Period: ${yearRange} | Prepared by: ${author} | Generated: ${new Date().toLocaleDateString()}`;
    
    document.getElementById('rptKPIs').innerHTML = `
        <div class="report-kpi"><div class="value">${stats.total.toLocaleString()}</div><div class="label">Total Crashes</div></div>
        <div class="report-kpi"><div class="value">${stats.K}</div><div class="label">Fatalities</div></div>
        <div class="report-kpi"><div class="value">${stats.A}</div><div class="label">Serious Injury</div></div>
        <div class="report-kpi"><div class="value">${(stats.B + stats.C).toLocaleString()}</div><div class="label">Other Injury</div></div>
        <div class="report-kpi"><div class="value">${stats.O.toLocaleString()}</div><div class="label">PDO</div></div>
        <div class="report-kpi"><div class="value">${calcEPDO(stats).toLocaleString()}</div><div class="label">EPDO</div></div>
        <div class="report-kpi"><div class="value">${stats.ped}</div><div class="label">Pedestrian</div></div>
        <div class="report-kpi"><div class="value">${stats.bike}</div><div class="label">Bicycle</div></div>
    `;
    
    // Findings
    const findings = generateFindings(stats, crashes);
    document.getElementById('rptFindings').innerHTML = `<h4>Key Findings</h4>${findings.map(f => `<div class="finding-item ${f.type}">${f.text}</div>`).join('')}`;
    
    // Yearly section
    document.getElementById('rptYearlySection').innerHTML = generateYearlySection(crashes);
    
    // Charts section
    document.getElementById('rptChartsSection').innerHTML = `
        <div class="report-section"><h4>Collision Types</h4><div style="height:220px"><canvas id="rptChartCollision"></canvas></div></div>
        <div class="report-section"><h4>Severity Distribution</h4><div style="height:220px"><canvas id="rptChartSeverity"></canvas></div></div>
    `;
    
    setTimeout(() => {
        createReportCharts(stats, crashes);
    }, 100);
    
    // Tables
    document.getElementById('rptTablesSection').innerHTML = generateTopLocationsTable(crashes);
    
    // Recommendations
    document.getElementById('rptRecommendations').innerHTML = generateRecommendations(stats, crashes);
}

function generateCorridorReport(crashes, route, title, author) {
    const stats = computeStats(crashes);
    const yearRange = getYearRange(crashes);
    
    document.getElementById('rptTitle').textContent = `${title}: ${route}`;
    document.getElementById('rptSubtitle').textContent = `Corridor Crash Analysis`;
    document.getElementById('rptMeta').textContent = `Period: ${yearRange} | Prepared by: ${author} | Generated: ${new Date().toLocaleDateString()}`;
    
    document.getElementById('rptKPIs').innerHTML = `
        <div class="report-kpi"><div class="value">${stats.total.toLocaleString()}</div><div class="label">Total Crashes</div></div>
        <div class="report-kpi"><div class="value">${stats.K + stats.A}</div><div class="label">K+A Crashes</div></div>
        <div class="report-kpi"><div class="value">${calcEPDO(stats).toLocaleString()}</div><div class="label">EPDO Score</div></div>
        <div class="report-kpi"><div class="value">${pct(stats.K + stats.A, stats.total)}%</div><div class="label">K+A Rate</div></div>
        <div class="report-kpi"><div class="value">${stats.ped}</div><div class="label">Pedestrian</div></div>
        <div class="report-kpi"><div class="value">${stats.intersection}</div><div class="label">At Intersection</div></div>
    `;
    
    const findings = generateFindings(stats, crashes);
    document.getElementById('rptFindings').innerHTML = `<h4>Key Findings</h4>${findings.map(f => `<div class="finding-item ${f.type}">${f.text}</div>`).join('')}`;
    document.getElementById('rptYearlySection').innerHTML = generateYearlySection(crashes);
    document.getElementById('rptChartsSection').innerHTML = `
        <div class="report-section"><h4>Collision Types</h4><div style="height:220px"><canvas id="rptChartCollision"></canvas></div></div>
        <div class="report-section"><h4>Time of Day</h4><div style="height:220px"><canvas id="rptChartTime"></canvas></div></div>
    `;
    setTimeout(() => createReportCharts(stats, crashes), 100);
    document.getElementById('rptTablesSection').innerHTML = generateNodeTable(crashes);
    document.getElementById('rptRecommendations').innerHTML = generateRecommendations(stats, crashes);
}

function generateSafetyReport(crashes, title, author) {
    const stats = computeStats(crashes);
    const yearRange = getYearRange(crashes);
    const kaRate = stats.total > 0 ? ((stats.K + stats.A) / stats.total * 100).toFixed(2) : 0;
    
    document.getElementById('rptTitle').textContent = title;
    document.getElementById('rptSubtitle').textContent = `Traffic Safety Performance Report`;
    document.getElementById('rptMeta').textContent = `Period: ${yearRange} | Prepared by: ${author} | Generated: ${new Date().toLocaleDateString()}`;
    
    document.getElementById('rptKPIs').innerHTML = `
        <div class="report-kpi"><div class="value">${stats.K}</div><div class="label">Fatal Crashes</div></div>
        <div class="report-kpi"><div class="value">${stats.A}</div><div class="label">Serious Injury</div></div>
        <div class="report-kpi"><div class="value">${kaRate}%</div><div class="label">K+A Rate</div></div>
        <div class="report-kpi"><div class="value">${calcEPDO(stats).toLocaleString()}</div><div class="label">EPDO Score</div></div>
        <div class="report-kpi"><div class="value">${stats.ped}</div><div class="label">Ped Crashes</div></div>
        <div class="report-kpi"><div class="value">${stats.bike}</div><div class="label">Bike Crashes</div></div>
    `;
    
    // Focus on severe crashes
    const severeCrashes = crashes.filter(c => ['K','A'].includes((c[COL.SEVERITY]||'').charAt(0)));
    const severeFindings = [];
    
    // Analyze severe crash patterns
    const severeByType = {};
    const severeByLight = {};
    severeCrashes.forEach(c => {
        const type = c[COL.COLLISION] || 'Unknown';
        const light = c[COL.LIGHT] || 'Unknown';
        severeByType[type] = (severeByType[type]||0)+1;
        severeByLight[light] = (severeByLight[light]||0)+1;
    });
    
    const topSevereType = Object.entries(severeByType).sort((a,b) => b[1]-a[1])[0];
    if (topSevereType) severeFindings.push({ type: 'danger', text: `Most common severe crash type: ${topSevereType[0]} (${topSevereType[1]} K+A crashes)` });
    
    const darkCrashes = Object.entries(severeByLight).filter(([k]) => k.toLowerCase().includes('dark')).reduce((s,e) => s+e[1], 0);
    if (darkCrashes > severeCrashes.length * 0.3) {
        severeFindings.push({ type: 'warning', text: `${pct(darkCrashes, severeCrashes.length)}% of severe crashes occurred in dark conditions - consider lighting improvements` });
    }
    
    document.getElementById('rptFindings').innerHTML = `<h4>Safety Analysis Findings</h4>${severeFindings.concat(generateFindings(stats, crashes)).map(f => `<div class="finding-item ${f.type}">${f.text}</div>`).join('')}`;
    document.getElementById('rptYearlySection').innerHTML = generateYearlySection(crashes);
    document.getElementById('rptChartsSection').innerHTML = `
        <div class="report-section"><h4>K+A by Collision Type</h4><div style="height:220px"><canvas id="rptChartCollision"></canvas></div></div>
        <div class="report-section"><h4>K+A by Light Condition</h4><div style="height:220px"><canvas id="rptChartLight"></canvas></div></div>
    `;
    setTimeout(() => createSafetyCharts(severeCrashes), 100);
    document.getElementById('rptTablesSection').innerHTML = generateTopLocationsTable(crashes, true);
    document.getElementById('rptRecommendations').innerHTML = generateSafetyRecommendations(stats, severeCrashes);
}

function generatePedBikeReport(crashes, title, author) {
    const pedCrashes = crashes.filter(c => isYes(c[COL.PED]));
    const bikeCrashes = crashes.filter(c => isYes(c[COL.BIKE]));
    const yearRange = getYearRange(crashes);
    
    const pedStats = computeStats(pedCrashes);
    const bikeStats = computeStats(bikeCrashes);
    
    const pedEPDO = calcEPDO(pedStats);
    const bikeEPDO = calcEPDO(bikeStats);
    const pedKARate = pedStats.total > 0 ? ((pedStats.K + pedStats.A) / pedStats.total * 100).toFixed(1) : 0;
    const bikeKARate = bikeStats.total > 0 ? ((bikeStats.K + bikeStats.A) / bikeStats.total * 100).toFixed(1) : 0;
    const totalVRU = pedStats.total + bikeStats.total;
    const totalVRUKA = (pedStats.K + pedStats.A) + (bikeStats.K + bikeStats.A);
    
    document.getElementById('rptTitle').textContent = title;
    document.getElementById('rptSubtitle').textContent = `Vulnerable Road User Safety Analysis`;
    document.getElementById('rptMeta').textContent = `Period: ${yearRange} | Prepared by: ${author} | Generated: ${new Date().toLocaleDateString()}`;
    
    document.getElementById('rptKPIs').innerHTML = `
        <div class="report-kpi" style="background:#0891b2"><div class="value">${pedStats.total}</div><div class="label">ğŸš¶ Ped Crashes</div></div>
        <div class="report-kpi" style="background:#dc2626"><div class="value">${pedStats.K}</div><div class="label">ğŸš¶ Ped Fatal</div></div>
        <div class="report-kpi" style="background:#7c3aed"><div class="value">${pedEPDO.toLocaleString()}</div><div class="label">ğŸš¶ Ped EPDO</div></div>
        <div class="report-kpi" style="background:#059669"><div class="value">${bikeStats.total}</div><div class="label">ğŸš´ Bike Crashes</div></div>
        <div class="report-kpi" style="background:#dc2626"><div class="value">${bikeStats.K}</div><div class="label">ğŸš´ Bike Fatal</div></div>
        <div class="report-kpi" style="background:#7c3aed"><div class="value">${bikeEPDO.toLocaleString()}</div><div class="label">ğŸš´ Bike EPDO</div></div>
    `;
    
    const findings = [];
    if (pedStats.K > 0) findings.push({ type: 'danger', text: `${pedStats.K} pedestrian fatalities recorded in the analysis period` });
    if (bikeStats.K > 0) findings.push({ type: 'danger', text: `${bikeStats.K} bicycle fatalities recorded in the analysis period` });
    
    if (parseFloat(pedKARate) > 25) findings.push({ type: 'warning', text: `High pedestrian K+A rate: ${pedKARate}% of pedestrian crashes result in fatal or serious injury` });
    if (parseFloat(bikeKARate) > 25) findings.push({ type: 'warning', text: `High bicycle K+A rate: ${bikeKARate}% of bicycle crashes result in fatal or serious injury` });
    
    // Light condition analysis
    const pedDark = pedCrashes.filter(c => (c[COL.LIGHT]||'').toLowerCase().includes('dark')).length;
    const bikeDark = bikeCrashes.filter(c => (c[COL.LIGHT]||'').toLowerCase().includes('dark')).length;
    const pedDarkPct = pedStats.total > 0 ? (pedDark / pedStats.total * 100).toFixed(1) : 0;
    const bikeDarkPct = bikeStats.total > 0 ? (bikeDark / bikeStats.total * 100).toFixed(1) : 0;
    
    if (parseFloat(pedDarkPct) > 30) findings.push({ type: 'warning', text: `${pedDarkPct}% of pedestrian crashes occur in dark conditions - consider enhanced lighting` });
    if (parseFloat(bikeDarkPct) > 30) findings.push({ type: 'warning', text: `${bikeDarkPct}% of bicycle crashes occur in dark conditions - consider enhanced lighting` });
    
    findings.push({ type: '', text: `Total VRU crashes: ${totalVRU} (${(totalVRU / crashes.length * 100).toFixed(2)}% of all crashes)` });
    
    document.getElementById('rptFindings').innerHTML = `<h4>ğŸš¨ Vulnerable Road User Findings</h4>${findings.map(f => `<div class="finding-item ${f.type}">${f.text}</div>`).join('')}`;
    
    // Comparison table
    document.getElementById('rptYearlySection').innerHTML = `
        <h4>ğŸ“Š Pedestrian vs Bicycle Comparison</h4>
        <table class="data-table" style="width:100%;margin-bottom:1.5rem">
            <thead>
                <tr style="background:linear-gradient(135deg,#1e3a5f,#1e40af);color:#fff">
                    <th style="text-align:left;padding:.75rem">Metric</th>
                    <th style="text-align:center;padding:.75rem">ğŸš¶ Pedestrian</th>
                    <th style="text-align:center;padding:.75rem">ğŸš´ Bicycle</th>
                    <th style="text-align:center;padding:.75rem">ğŸ“Š Total VRU</th>
                </tr>
            </thead>
            <tbody>
                <tr><td><strong>Total Crashes</strong></td>
                    <td style="text-align:center;font-weight:600;color:#0891b2">${pedStats.total}</td>
                    <td style="text-align:center;font-weight:600;color:#059669">${bikeStats.total}</td>
                    <td style="text-align:center;font-weight:700">${totalVRU}</td></tr>
                <tr><td><strong>Fatal (K)</strong></td>
                    <td style="text-align:center"><span class="severity-badge severity-K">${pedStats.K}</span></td>
                    <td style="text-align:center"><span class="severity-badge severity-K">${bikeStats.K}</span></td>
                    <td style="text-align:center"><span class="severity-badge severity-K">${pedStats.K + bikeStats.K}</span></td></tr>
                <tr><td><strong>Serious Injury (A)</strong></td>
                    <td style="text-align:center"><span class="severity-badge severity-A">${pedStats.A}</span></td>
                    <td style="text-align:center"><span class="severity-badge severity-A">${bikeStats.A}</span></td>
                    <td style="text-align:center"><span class="severity-badge severity-A">${pedStats.A + bikeStats.A}</span></td></tr>
                <tr><td><strong>K+A Total</strong></td>
                    <td style="text-align:center;font-weight:600">${pedStats.K + pedStats.A}</td>
                    <td style="text-align:center;font-weight:600">${bikeStats.K + bikeStats.A}</td>
                    <td style="text-align:center;font-weight:700">${totalVRUKA}</td></tr>
                <tr><td><strong>K+A Rate</strong></td>
                    <td style="text-align:center;color:${parseFloat(pedKARate) > 25 ? '#dc2626' : '#059669'}">${pedKARate}%</td>
                    <td style="text-align:center;color:${parseFloat(bikeKARate) > 25 ? '#dc2626' : '#059669'}">${bikeKARate}%</td>
                    <td style="text-align:center">${totalVRU > 0 ? (totalVRUKA / totalVRU * 100).toFixed(1) : 0}%</td></tr>
                <tr><td><strong>EPDO Score</strong></td>
                    <td style="text-align:center;font-weight:600">${pedEPDO.toLocaleString()}</td>
                    <td style="text-align:center;font-weight:600">${bikeEPDO.toLocaleString()}</td>
                    <td style="text-align:center;font-weight:700">${(pedEPDO + bikeEPDO).toLocaleString()}</td></tr>
                <tr><td><strong>Dark Condition Crashes</strong></td>
                    <td style="text-align:center">${pedDark} (${pedDarkPct}%)</td>
                    <td style="text-align:center">${bikeDark} (${bikeDarkPct}%)</td>
                    <td style="text-align:center">${pedDark + bikeDark}</td></tr>
            </tbody>
        </table>
        ${generatePedBikeYearlySection(pedCrashes, bikeCrashes)}
    `;
    
    document.getElementById('rptChartsSection').innerHTML = `
        <div class="report-section"><h4>ğŸš¶ Pedestrian Crashes by Year</h4><div style="height:220px"><canvas id="rptChartPedYear"></canvas></div></div>
        <div class="report-section"><h4>ğŸš´ Bicycle Crashes by Year</h4><div style="height:220px"><canvas id="rptChartBikeYear"></canvas></div></div>
        <div class="report-section"><h4>ğŸ’¡ Pedestrian by Light Condition</h4><div style="height:220px"><canvas id="rptChartPedLight"></canvas></div></div>
        <div class="report-section"><h4>ğŸ’¡ Bicycle by Light Condition</h4><div style="height:220px"><canvas id="rptChartBikeLight"></canvas></div></div>
    `;
    setTimeout(() => createEnhancedPedBikeCharts(pedCrashes, bikeCrashes), 100);
    document.getElementById('rptTablesSection').innerHTML = generatePedBikeLocationTable(pedCrashes, bikeCrashes);
    document.getElementById('rptRecommendations').innerHTML = generatePedBikeRecommendations(pedStats, bikeStats, pedDarkPct, bikeDarkPct);
}

function createEnhancedPedBikeCharts(pedCrashes, bikeCrashes) {
    const years = crashState.years;
    
    // Ped by year
    const pedByYear = {};
    pedCrashes.forEach(c => {
        const y = c[COL.YEAR];
        pedByYear[y] = (pedByYear[y] || 0) + 1;
    });
    createChart('rptChartPedYear', 'bar', {
        labels: years,
        datasets: [{ label: 'Pedestrian Crashes', data: years.map(y => pedByYear[y] || 0), backgroundColor: '#0891b2', borderRadius: 4 }]
    }, { plugins: { legend: { display: false } } });
    
    // Bike by year
    const bikeByYear = {};
    bikeCrashes.forEach(c => {
        const y = c[COL.YEAR];
        bikeByYear[y] = (bikeByYear[y] || 0) + 1;
    });
    createChart('rptChartBikeYear', 'bar', {
        labels: years,
        datasets: [{ label: 'Bicycle Crashes', data: years.map(y => bikeByYear[y] || 0), backgroundColor: '#059669', borderRadius: 4 }]
    }, { plugins: { legend: { display: false } } });
    
    // Ped by light
    const pedLight = {};
    pedCrashes.forEach(c => {
        const l = c[COL.LIGHT] || 'Unknown';
        pedLight[l] = (pedLight[l] || 0) + 1;
    });
    const pedLightSorted = Object.entries(pedLight).sort((a,b) => b[1]-a[1]).slice(0,5);
    createChart('rptChartPedLight', 'doughnut', {
        labels: pedLightSorted.map(l => l[0].substring(0,20)),
        datasets: [{ data: pedLightSorted.map(l => l[1]), backgroundColor: ['#fcd34d','#1e293b','#94a3b8','#f97316','#6366f1'] }]
    }, { cutout: '40%' });
    
    // Bike by light
    const bikeLight = {};
    bikeCrashes.forEach(c => {
        const l = c[COL.LIGHT] || 'Unknown';
        bikeLight[l] = (bikeLight[l] || 0) + 1;
    });
    const bikeLightSorted = Object.entries(bikeLight).sort((a,b) => b[1]-a[1]).slice(0,5);
    createChart('rptChartBikeLight', 'doughnut', {
        labels: bikeLightSorted.map(l => l[0].substring(0,20)),
        datasets: [{ data: bikeLightSorted.map(l => l[1]), backgroundColor: ['#fcd34d','#1e293b','#94a3b8','#f97316','#6366f1'] }]
    }, { cutout: '40%' });
}

function generateTrendReport(crashes, title, author) {
    const stats = computeStats(crashes);
    const yearRange = getYearRange(crashes);
    
    document.getElementById('rptTitle').textContent = title;
    document.getElementById('rptSubtitle').textContent = `Multi-Year Trend Analysis`;
    document.getElementById('rptMeta').textContent = `Period: ${yearRange} | Prepared by: ${author} | Generated: ${new Date().toLocaleDateString()}`;
    
    const byYear = {};
    crashes.forEach(c => {
        const y = parseInt(c[COL.YEAR]) || null;
        if (!y) return;
        if (!byYear[y]) byYear[y] = { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 };
        byYear[y].total++;
        const s = (c[COL.SEVERITY]||'').charAt(0);
        if (byYear[y][s] !== undefined) byYear[y][s]++;
    });
    
    const years = Object.keys(byYear).sort();
    let trend = 'stable';
    if (years.length >= 3) {
        const first = byYear[years[0]].total;
        const last = byYear[years[years.length-1]].total;
        const change = (last - first) / first * 100;
        if (change > 10) trend = 'increasing';
        else if (change < -10) trend = 'decreasing';
    }
    
    document.getElementById('rptKPIs').innerHTML = `
        <div class="report-kpi"><div class="value">${stats.total.toLocaleString()}</div><div class="label">Total (${yearRange})</div></div>
        <div class="report-kpi"><div class="value">${years.length}</div><div class="label">Years Analyzed</div></div>
        <div class="report-kpi"><div class="value">${Math.round(stats.total / years.length)}</div><div class="label">Avg per Year</div></div>
        <div class="report-kpi"><div class="value" style="text-transform:capitalize">${trend}</div><div class="label">Overall Trend</div></div>
    `;
    
    const findings = [];
    if (trend === 'increasing') findings.push({ type: 'danger', text: 'Crash numbers show an increasing trend over the analysis period' });
    if (trend === 'decreasing') findings.push({ type: '', text: 'Crash numbers show a decreasing trend - positive safety improvement' });
    
    document.getElementById('rptFindings').innerHTML = `<h4>Trend Analysis Findings</h4>${findings.map(f => `<div class="finding-item ${f.type}">${f.text}</div>`).join('')}`;
    document.getElementById('rptYearlySection').innerHTML = generateYearlySection(crashes);
    document.getElementById('rptChartsSection').innerHTML = `
        <div class="report-section"><h4>Crash Trend</h4><div style="height:220px"><canvas id="rptChartTrend"></canvas></div></div>
        <div class="report-section"><h4>K+A Trend</h4><div style="height:220px"><canvas id="rptChartKATrend"></canvas></div></div>
    `;
    setTimeout(() => createTrendCharts(byYear), 100);
    document.getElementById('rptTablesSection').innerHTML = '';
    document.getElementById('rptRecommendations').innerHTML = '';
}

// Helper functions
function computeStats(crashes) {
    const stats = { total: crashes.length, K: 0, A: 0, B: 0, C: 0, O: 0, ped: 0, bike: 0, intersection: 0 };
    crashes.forEach(c => {
        const s = (c[COL.SEVERITY]||'').charAt(0);
        if (stats[s] !== undefined) stats[s]++;
        if (isYes(c[COL.PED])) stats.ped++;
        if (isYes(c[COL.BIKE])) stats.bike++;
        if (isIntersection(c)) stats.intersection++;
    });
    return stats;
}

function getYearRange(crashes) {
    const years = crashes.map(c => parseInt(c[COL.YEAR])).filter(y => !isNaN(y));
    if (!years.length) return '--';
    return `${Math.min(...years)} - ${Math.max(...years)}`;
}

function generateFindings(stats, crashes) {
    const findings = [];
    const kaRate = stats.total > 0 ? (stats.K + stats.A) / stats.total * 100 : 0;
    
    if (stats.K > 0) findings.push({ type: 'danger', text: `${stats.K} fatal crash(es) recorded - highest priority for safety countermeasures` });
    if (kaRate > 5) findings.push({ type: 'warning', text: `K+A rate of ${kaRate.toFixed(1)}% indicates elevated severe crash frequency` });
    if (stats.ped > 5) findings.push({ type: 'warning', text: `${stats.ped} pedestrian-involved crashes - consider pedestrian safety improvements` });
    if (stats.bike > 3) findings.push({ type: '', text: `${stats.bike} bicycle-involved crashes recorded` });
    
    // Collision type analysis
    const byType = {};
    crashes.forEach(c => { const t = c[COL.COLLISION]||'Unknown'; byType[t]=(byType[t]||0)+1; });
    const topType = Object.entries(byType).sort((a,b) => b[1]-a[1])[0];
    if (topType && topType[1] > stats.total * 0.2) {
        findings.push({ type: '', text: `Predominant crash type: ${topType[0]} (${pct(topType[1], stats.total)}% of crashes)` });
    }
    
    return findings;
}

function generateYearlySection(crashes) {
    const byYear = {};
    crashes.forEach(c => {
        const y = parseInt(c[COL.YEAR]);
        if (!y) return;
        if (!byYear[y]) byYear[y] = { total: 0, K: 0, A: 0, B: 0, C: 0, O: 0 };
        byYear[y].total++;
        const s = (c[COL.SEVERITY]||'').charAt(0);
        if (byYear[y][s] !== undefined) byYear[y][s]++;
    });
    
    const years = Object.keys(byYear).sort();
    return `<h4>Yearly Summary</h4>
        <div class="table-wrapper"><table class="data-table">
        <thead><tr><th>Year</th><th>Total</th><th>K</th><th>A</th><th>B</th><th>C</th><th>O</th><th>EPDO</th></tr></thead>
        <tbody>${years.map(y => {
            const d = byYear[y];
            return `<tr><td>${y}</td><td>${d.total}</td><td>${d.K}</td><td>${d.A}</td><td>${d.B}</td><td>${d.C}</td><td>${d.O}</td><td>${calcEPDO(d)}</td></tr>`;
        }).join('')}</tbody></table></div>`;
}

function generateTopLocationsTable(crashes, kaOnly = false) {
    const byRoute = {};
    crashes.forEach(c => {
        if (kaOnly && !['K','A'].includes((c[COL.SEVERITY]||'').charAt(0))) return;
        const r = c[COL.ROUTE] || 'Unknown';
        if (!byRoute[r]) byRoute[r] = { total: 0, K: 0, A: 0 };
        byRoute[r].total++;
        const s = (c[COL.SEVERITY]||'').charAt(0);
        if (s === 'K') byRoute[r].K++;
        if (s === 'A') byRoute[r].A++;
    });
    
    const sorted = Object.entries(byRoute).sort((a,b) => b[1].total - a[1].total).slice(0, 15);
    return `<h4>Top ${kaOnly ? 'K+A' : ''} Crash Locations</h4>
        <div class="table-wrapper"><table class="data-table">
        <thead><tr><th>Route</th><th>Total</th><th>K</th><th>A</th></tr></thead>
        <tbody>${sorted.map(([r, d]) => `<tr><td>${esc(r)}</td><td>${d.total}</td><td>${d.K}</td><td>${d.A}</td></tr>`).join('')}</tbody></table></div>`;
}

function generateNodeTable(crashes) {
    const byNode = {};
    crashes.forEach(c => {
        const n = c[COL.NODE];
        if (!n) return;
        if (!byNode[n]) byNode[n] = { total: 0, K: 0, A: 0 };
        byNode[n].total++;
        const s = (c[COL.SEVERITY]||'').charAt(0);
        if (s === 'K') byNode[n].K++;
        if (s === 'A') byNode[n].A++;
    });
    
    const sorted = Object.entries(byNode).sort((a,b) => b[1].total - a[1].total).slice(0, 15);
    return `<h4>Crash Frequency by Node/Intersection</h4>
        <div class="table-wrapper"><table class="data-table">
        <thead><tr><th>Node</th><th>Total</th><th>K</th><th>A</th></tr></thead>
        <tbody>${sorted.map(([n, d]) => `<tr><td>${esc(n)}</td><td>${d.total}</td><td>${d.K}</td><td>${d.A}</td></tr>`).join('')}</tbody></table></div>`;
}

function generateRecommendations(stats, crashes) {
    const recs = [];
    if (stats.K > 0) recs.push('Conduct detailed fatal crash reviews to identify systemic issues');
    if (stats.ped > 5) recs.push('Evaluate pedestrian crossing facilities and consider enhanced crossings, signals, or lighting');
    if (stats.intersection > stats.total * 0.5) recs.push('Focus on intersection safety improvements including signal timing, turn restrictions, or geometric changes');
    
    return `<h4>Recommended Actions</h4><ul style="margin-left:1.5rem;line-height:1.8">${recs.map(r => `<li>${r}</li>`).join('')}</ul>`;
}

function generateSafetyRecommendations(stats, severeCrashes) {
    const recs = ['Prioritize systemic safety improvements at high-K+A locations'];
    const byLight = {};
    severeCrashes.forEach(c => { const l = c[COL.LIGHT]||'Unknown'; byLight[l]=(byLight[l]||0)+1; });
    const darkPct = Object.entries(byLight).filter(([k]) => k.toLowerCase().includes('dark')).reduce((s,e) => s+e[1], 0) / severeCrashes.length;
    if (darkPct > 0.3) recs.push('Consider roadway lighting improvements - significant portion of severe crashes occur in dark conditions');
    
    return `<h4>Safety Recommendations</h4><ul style="margin-left:1.5rem;line-height:1.8">${recs.map(r => `<li>${r}</li>`).join('')}</ul>`;
}

function generatePedBikeRecommendations(pedStats, bikeStats, pedDarkPct, bikeDarkPct) {
    const recs = [];
    
    // Fatal crash recommendations
    if (pedStats.K > 0) recs.push('ğŸš¨ <strong>Priority:</strong> Conduct detailed review of all pedestrian fatality locations');
    if (bikeStats.K > 0) recs.push('ğŸš¨ <strong>Priority:</strong> Conduct detailed review of all bicycle fatality locations');
    
    // K+A rate recommendations
    const pedKARate = pedStats.total > 0 ? ((pedStats.K + pedStats.A) / pedStats.total * 100) : 0;
    const bikeKARate = bikeStats.total > 0 ? ((bikeStats.K + bikeStats.A) / bikeStats.total * 100) : 0;
    
    if (pedKARate > 25) recs.push('Evaluate pedestrian crossing locations for enhanced treatments (RRFB, PHB, or signals)');
    if (bikeKARate > 25) recs.push('Consider protected bicycle facilities on high-crash corridors');
    
    // Lighting recommendations
    if (parseFloat(pedDarkPct) > 30) recs.push('ğŸ”¦ Install/upgrade pedestrian-scale lighting at high-pedestrian crash locations');
    if (parseFloat(bikeDarkPct) > 30) recs.push('ğŸ”¦ Improve roadway lighting and consider reflective treatments on bicycle routes');
    
    // General recommendations
    recs.push('Conduct speed studies on corridors with pedestrian/bicycle crashes');
    recs.push('Review sight distance and visibility at pedestrian crossing locations');
    if (bikeStats.total > 10) recs.push('Perform bicycle network gap analysis to identify missing connections');
    recs.push('Consider systemic safety improvements at similar locations countywide');
    recs.push('Coordinate with local schools and community groups on pedestrian/bicycle safety education');
    
    return `<h4>ğŸ“‹ Recommendations</h4>
        <div style="background:#f8fafc;border-radius:8px;padding:1rem;border-left:4px solid #1e40af">
            <ul style="margin-left:1rem;line-height:2">${recs.map(r => `<li>${r}</li>`).join('')}</ul>
        </div>`;
}

function generatePedBikeYearlySection(pedCrashes, bikeCrashes) {
    const pedByYear = {}, bikeByYear = {};
    pedCrashes.forEach(c => { const y = parseInt(c[COL.YEAR]); if(y) pedByYear[y]=(pedByYear[y]||0)+1; });
    bikeCrashes.forEach(c => { const y = parseInt(c[COL.YEAR]); if(y) bikeByYear[y]=(bikeByYear[y]||0)+1; });
    const years = [...new Set([...Object.keys(pedByYear), ...Object.keys(bikeByYear)])].sort();
    
    return `<h4>Yearly Summary</h4>
        <div class="table-wrapper"><table class="data-table">
        <thead><tr><th>Year</th><th>Pedestrian</th><th>Bicycle</th><th>Total</th></tr></thead>
        <tbody>${years.map(y => `<tr><td>${y}</td><td>${pedByYear[y]||0}</td><td>${bikeByYear[y]||0}</td><td>${(pedByYear[y]||0)+(bikeByYear[y]||0)}</td></tr>`).join('')}</tbody></table></div>`;
}

function generatePedBikeLocationTable(pedCrashes, bikeCrashes) {
    const pedByRoute = {}, bikeByRoute = {};
    pedCrashes.forEach(c => { const r = c[COL.ROUTE]; if(r) pedByRoute[r]=(pedByRoute[r]||0)+1; });
    bikeCrashes.forEach(c => { const r = c[COL.ROUTE]; if(r) bikeByRoute[r]=(bikeByRoute[r]||0)+1; });
    
    const pedTop = Object.entries(pedByRoute).sort((a,b) => b[1]-a[1]).slice(0,8);
    const bikeTop = Object.entries(bikeByRoute).sort((a,b) => b[1]-a[1]).slice(0,8);
    
    return `<div class="two-col">
        <div><h4>Top Pedestrian Locations</h4><div class="table-wrapper"><table class="data-table"><thead><tr><th>Route</th><th>Crashes</th></tr></thead>
        <tbody>${pedTop.map(([r,c]) => `<tr><td>${esc(r)}</td><td>${c}</td></tr>`).join('')}</tbody></table></div></div>
        <div><h4>Top Bicycle Locations</h4><div class="table-wrapper"><table class="data-table"><thead><tr><th>Route</th><th>Crashes</th></tr></thead>
        <tbody>${bikeTop.map(([r,c]) => `<tr><td>${esc(r)}</td><td>${c}</td></tr>`).join('')}</tbody></table></div></div>
    </div>`;
}

// Report chart creation functions
function createReportCharts(stats, crashes) {
    const byType = {};
    crashes.forEach(c => { const t = c[COL.COLLISION]||'Unknown'; byType[t]=(byType[t]||0)+1; });
    const typeSorted = Object.entries(byType).sort((a,b) => b[1]-a[1]).slice(0,8);
    createChart('rptChartCollision', 'bar', {
        labels: typeSorted.map(t => t[0].substring(0,18)),
        datasets: [{ label: 'Crashes', data: typeSorted.map(t => t[1]), backgroundColor: '#1e40af' }]
    }, { indexAxis: 'y' });
    
    createChart('rptChartSeverity', 'doughnut', {
        labels: ['K','A','B','C','O'],
        datasets: [{ data: [stats.K, stats.A, stats.B, stats.C, stats.O], backgroundColor: ['#dc2626','#ea580c','#eab308','#22c55e','#64748b'] }]
    });
}

function createSafetyCharts(severeCrashes) {
    const byType = {}, byLight = {};
    severeCrashes.forEach(c => {
        const t = c[COL.COLLISION]||'Unknown';
        const l = c[COL.LIGHT]||'Unknown';
        byType[t]=(byType[t]||0)+1;
        byLight[l]=(byLight[l]||0)+1;
    });
    
    const typeSorted = Object.entries(byType).sort((a,b) => b[1]-a[1]).slice(0,8);
    createChart('rptChartCollision', 'bar', {
        labels: typeSorted.map(t => t[0].substring(0,18)),
        datasets: [{ label: 'K+A Crashes', data: typeSorted.map(t => t[1]), backgroundColor: '#dc2626' }]
    }, { indexAxis: 'y' });
    
    const lightSorted = Object.entries(byLight).sort((a,b) => b[1]-a[1]).slice(0,6);
    createChart('rptChartLight', 'doughnut', {
        labels: lightSorted.map(l => l[0].substring(0,18)),
        datasets: [{ data: lightSorted.map(l => l[1]), backgroundColor: ['#fcd34d','#1e293b','#94a3b8','#f97316','#6366f1','#14b8a6'] }]
    });
}

function createPedBikeCharts(pedCrashes, bikeCrashes) {
    const pedByHour = {}, bikeByHour = {};
    pedCrashes.forEach(c => { const h = getHour(c[COL.TIME]); if(h!==null) pedByHour[h]=(pedByHour[h]||0)+1; });
    bikeCrashes.forEach(c => { const h = getHour(c[COL.TIME]); if(h!==null) bikeByHour[h]=(bikeByHour[h]||0)+1; });
    
    const hours = Array.from({length:24}, (_,i) => i);
    createChart('rptChartPedTime', 'bar', {
        labels: hours.map(h => h.toString().padStart(2,'0')),
        datasets: [{ label: 'Ped', data: hours.map(h => pedByHour[h]||0), backgroundColor: '#0891b2' }]
    });
    createChart('rptChartBikeTime', 'bar', {
        labels: hours.map(h => h.toString().padStart(2,'0')),
        datasets: [{ label: 'Bike', data: hours.map(h => bikeByHour[h]||0), backgroundColor: '#059669' }]
    });
}

function createTrendCharts(byYear) {
    const years = Object.keys(byYear).sort();
    createChart('rptChartTrend', 'line', {
        labels: years,
        datasets: [{ label: 'Total Crashes', data: years.map(y => byYear[y].total), borderColor: '#1e40af', backgroundColor: 'rgba(30,64,175,.1)', fill: true, tension: 0.3 }]
    });
    createChart('rptChartKATrend', 'line', {
        labels: years,
        datasets: [
            { label: 'Fatal', data: years.map(y => byYear[y].K), borderColor: '#dc2626', tension: 0.3 },
            { label: 'Serious', data: years.map(y => byYear[y].A), borderColor: '#ea580c', tension: 0.3 }
        ]
    });
}

function printReport() { window.print(); }

function downloadReportPDF() {
    showLoading('Generating PDF...');
    html2canvas(document.getElementById('reportContainer'), { scale: 2 }).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 10;
        
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= 277;
        
        while (heightLeft > 0) {
            position = heightLeft - imgHeight + 10;
            pdf.addPage();
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= 277;
        }
        
        pdf.save('crash_analysis_report.pdf');
        hideLoading();
    }).catch(e => { hideLoading(); alert('Error: ' + e.message); });
}

function copyReportText() {
    const text = document.getElementById('reportContainer').innerText;
    navigator.clipboard.writeText(text).then(() => alert('Report text copied to clipboard'));
}

function generateIntersectionReport(crashes, route, title, author) {
    generateCorridorReport(crashes, route || 'All Intersections', title + ' - Intersection Analysis', author);
}

function generateHotspotReport() {
    document.getElementById('reportType').value = 'systemwide';
    document.getElementById('reportTitle').value = 'High-Crash Location Analysis';
    showTab('reports');
    setTimeout(generateReport, 100);
}

// ============================================================
// SESSION SAVE/LOAD & UTILITIES
// ============================================================
function saveSession() {
    if (!crashState.loaded) { alert('No data'); return; }
    const session = {
        version: 2, timestamp: new Date().toISOString(),
        totalRows: crashState.totalRows, aggregates: crashState.aggregates,
        years: crashState.years, routes: crashState.routes
    };
    downloadFile(JSON.stringify(session), 'crash_session_' + new Date().toISOString().slice(0,10) + '.json', 'application/json');
}

function loadSession(event) {
    const file = event.target.files[0];
    if (!file) return;
    showLoading('Loading...');
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const s = JSON.parse(e.target.result);
            crashState.loaded = true;
            crashState.totalRows = s.totalRows;
            crashState.aggregates = s.aggregates;
            crashState.years = s.years;
            crashState.routes = s.routes;
            initDropdowns();
            hideLoading();
            alert('Session loaded!');
            showTab('dashboard');
        } catch(err) { hideLoading(); alert('Error: ' + err.message); }
    };
    reader.readAsText(file);
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
}

// ============================================================
// AI ANALYST - Multi-Provider Support with Attachments
// ============================================================
const aiState = {
    messages: [],
    attachments: [],
    conversationHistory: []
};

function loadSavedKey() {
    const provider = document.getElementById('aiProvider').value;
    const saved = localStorage.getItem('crashAI_key_' + provider);
    if (saved) {
        document.getElementById('aiApiKey').value = atob(saved);
        document.getElementById('aiSaveKey').checked = true;
    } else {
        document.getElementById('aiApiKey').value = '';
        document.getElementById('aiSaveKey').checked = false;
    }
}

function handleAIFileSelect(event) {
    const files = event.target.files;
    for (const file of files) {
        if (aiState.attachments.length >= 5) {
            alert('Maximum 5 attachments allowed');
            break;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const attachment = {
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result
            };
            
            // For images, create thumbnail
            if (file.type.startsWith('image/')) {
                attachment.isImage = true;
                attachment.preview = e.target.result;
            }
            
            aiState.attachments.push(attachment);
            renderAttachments();
        };
        
        if (file.type.startsWith('image/') || file.type === 'application/pdf') {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
    }
    event.target.value = '';
}

function renderAttachments() {
    const container = document.getElementById('aiAttachments');
    container.innerHTML = aiState.attachments.map((att, i) => `
        <div class="ai-attachment">
            ${att.isImage ? `<img src="${att.preview}" alt="${esc(att.name)}">` : 'ğŸ“„'}
            <span>${esc(att.name.substring(0, 20))}${att.name.length > 20 ? '...' : ''}</span>
            <span class="remove" onclick="removeAttachment(${i})">&times;</span>
        </div>
    `).join('');
}

function removeAttachment(index) {
    aiState.attachments.splice(index, 1);
    renderAttachments();
}

function askSuggestion(btn) {
    document.getElementById('aiQuestion').value = btn.textContent;
    askAI();
}

function clearAIChat() {
    aiState.messages = [];
    aiState.conversationHistory = [];
    document.getElementById('aiChatMessages').innerHTML = `
        <div class="ai-message assistant">
            <div class="ai-avatar">ğŸ¤–</div>
            <div class="ai-bubble">
                <p><strong>Chat cleared!</strong> Ready for new questions about your crash data.</p>
            </div>
        </div>
    `;
}

function clearApiKey() {
    const provider = document.getElementById('aiProvider').value;
    const keyName = `crash_ai_key_${provider}`;
    
    // Clear from localStorage
    localStorage.removeItem(keyName);
    
    // Clear input field
    document.getElementById('aiApiKey').value = '';
    
    // Uncheck save checkbox
    document.getElementById('aiSaveKey').checked = false;
    
    // Show confirmation
    alert(`API key for ${provider === 'openai' ? 'OpenAI' : provider === 'claude' ? 'Claude' : 'Gemini'} has been cleared.`);
}

function addMessage(role, content, attachmentPreviews = []) {
    const container = document.getElementById('aiChatMessages');
    const isUser = role === 'user';
    
    let attachHtml = '';
    if (attachmentPreviews.length > 0) {
        attachHtml = '<div style="display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem">' +
            attachmentPreviews.map(a => a.isImage ? 
                `<img src="${a.preview}" style="max-width:100px;max-height:80px;border-radius:4px">` : 
                `<span style="padding:.25rem .5rem;background:rgba(0,0,0,.1);border-radius:4px;font-size:.75rem">ğŸ“„ ${esc(a.name)}</span>`
            ).join('') + '</div>';
    }
    
    const messageHtml = `
        <div class="ai-message ${isUser ? 'user' : 'assistant'}">
            <div class="ai-avatar">${isUser ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
            <div class="ai-bubble">${isUser ? esc(content) + attachHtml : content}</div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', messageHtml);
    container.scrollTop = container.scrollHeight;
}

function addTypingIndicator() {
    const container = document.getElementById('aiChatMessages');
    container.insertAdjacentHTML('beforeend', `
        <div class="ai-message assistant" id="aiTyping">
            <div class="ai-avatar">ğŸ¤–</div>
            <div class="ai-bubble">
                <div class="ai-typing"><span></span><span></span><span></span></div>
            </div>
        </div>
    `);
    container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
    const typing = document.getElementById('aiTyping');
    if (typing) typing.remove();
}

function buildCrashDataContext() {
    if (!crashState.loaded) return null;
    
    const agg = crashState.aggregates;
    const sev = agg.bySeverity;
    const years = crashState.years;
    const yearRange = years.length > 0 ? `${years[0]}-${years[years.length-1]}` : 'N/A';
    
    return {
        summary: {
            totalCrashes: crashState.totalRows,
            yearRange: yearRange,
            yearsAnalyzed: years.length
        },
        severity: {
            fatal_K: sev.K,
            seriousInjury_A: sev.A,
            minorInjury_B: sev.B,
            possibleInjury_C: sev.C,
            propertyDamageOnly_O: sev.O,
            totalEPDO: calcEPDO(sev),
            fatalRate: (sev.K / crashState.totalRows * 100).toFixed(2) + '%',
            KA_rate: ((sev.K + sev.A) / crashState.totalRows * 100).toFixed(2) + '%'
        },
        pedestrianBicycle: {
            pedestrianCrashes: agg.ped.total,
            pedestrianFatal: agg.ped.K,
            pedestrianKA: agg.ped.K + agg.ped.A,
            bicycleCrashes: agg.bike.total,
            bicycleFatal: agg.bike.K,
            bicycleKA: agg.bike.K + agg.bike.A
        },
        intersectionAnalysis: {
            intersectionCrashes: agg.intersection.total,
            intersectionFatal: agg.intersection.K,
            nonIntersectionCrashes: agg.nonIntersection.total,
            intersectionPercent: (agg.intersection.total / crashState.totalRows * 100).toFixed(1) + '%'
        },
        topCollisionTypes: Object.entries(agg.byCollision).sort((a,b) => b[1]-a[1]).slice(0,8).map(e => ({type: e[0], count: e[1]})),
        topLocations: Object.entries(agg.byRoute).sort((a,b) => b[1].total - a[1].total).slice(0,10).map(e => ({
            route: e[0], total: e[1].total, fatal: e[1].K, serious: e[1].A, epdo: calcEPDO(e[1])
        })),
        weatherConditions: Object.entries(agg.byWeather).sort((a,b) => b[1]-a[1]).slice(0,6),
        lightConditions: Object.entries(agg.byLight).sort((a,b) => b[1]-a[1]).slice(0,6),
        yearlyTrend: Object.entries(agg.byYear).sort((a,b) => a[0]-b[0]).map(([y,d]) => ({
            year: y, total: d.total, fatal: d.K, serious: d.A, epdo: calcEPDO(d)
        }))
    };
}

function buildSystemPrompt() {
    return `You are an expert Traffic Safety Analyst AI assistant for Henrico County, Virginia. You help traffic engineers analyze crash data, identify patterns, and develop safety countermeasures.

Your responses should be:
- Professional and data-driven
- Formatted with clear structure using **bold** for emphasis
- Include specific numbers and percentages from the data
- Provide actionable recommendations when appropriate
- Reference FHWA, AASHTO, and MUTCD standards when relevant

When analyzing data:
1. Identify key patterns and trends
2. Highlight safety concerns (especially K+A crashes)
3. Compare to benchmarks when possible
4. Suggest evidence-based countermeasures
5. Prioritize by severity (fatal/serious injury first)

For image analysis:
- Describe what you observe in the image
- Identify potential safety issues
- Suggest improvements based on traffic engineering principles

Always maintain a helpful, professional tone appropriate for government traffic engineering work.`;
}

async function askAI() {
    const provider = document.getElementById('aiProvider').value;
    const apiKey = document.getElementById('aiApiKey').value;
    const question = document.getElementById('aiQuestion').value.trim();
    
    if (!apiKey) {
        alert('Please enter an API key for ' + provider);
        return;
    }
    
    if (!question && aiState.attachments.length === 0) {
        alert('Please enter a question or attach a file');
        return;
    }
    
    // Save key if requested
    if (document.getElementById('aiSaveKey').checked) {
        localStorage.setItem('crashAI_key_' + provider, btoa(apiKey));
    }
    
    // Show user message
    const attachmentPreviews = [...aiState.attachments];
    addMessage('user', question || 'Please analyze the attached file(s)', attachmentPreviews);
    
    // Clear input
    document.getElementById('aiQuestion').value = '';
    const currentAttachments = [...aiState.attachments];
    aiState.attachments = [];
    renderAttachments();
    
    // Show typing indicator
    addTypingIndicator();
    document.getElementById('aiSendBtn').disabled = true;
    
    // Build context
    const crashContext = buildCrashDataContext();
    const systemPrompt = buildSystemPrompt();
    
    let contextMessage = '';
    if (crashContext) {
        contextMessage = `\n\nCRASH DATA CONTEXT (Henrico County):\n${JSON.stringify(crashContext, null, 2)}`;
        document.getElementById('aiDataBadge').style.display = 'inline-flex';
    } else {
        contextMessage = '\n\n[No crash data loaded yet - please upload data for data-specific analysis]';
        document.getElementById('aiDataBadge').style.display = 'none';
    }
    
    const userMessage = question + contextMessage;
    
    try {
        let response;
        
        if (provider === 'openai') {
            response = await callOpenAI(apiKey, systemPrompt, userMessage, currentAttachments);
        } else if (provider === 'claude') {
            response = await callClaude(apiKey, systemPrompt, userMessage, currentAttachments);
        } else if (provider === 'gemini') {
            response = await callGemini(apiKey, systemPrompt, userMessage, currentAttachments);
        }
        
        removeTypingIndicator();
        addMessage('assistant', formatAIResponse(response));
        
        // Store in conversation history
        aiState.conversationHistory.push({ role: 'user', content: userMessage });
        aiState.conversationHistory.push({ role: 'assistant', content: response });
        
    } catch (error) {
        removeTypingIndicator();
        addMessage('assistant', `<div class="ai-error">âŒ Error: ${esc(error.message)}</div><p>Please check your API key and try again.</p>`);
    }
    
    document.getElementById('aiSendBtn').disabled = false;
}

async function callOpenAI(apiKey, systemPrompt, userMessage, attachments) {
    const messages = [
        { role: 'system', content: systemPrompt }
    ];
    
    // Add conversation history (limited)
    const history = aiState.conversationHistory.slice(-6);
    history.forEach(m => messages.push({ role: m.role, content: m.content }));
    
    // Build user message content
    const content = [];
    content.push({ type: 'text', text: userMessage });
    
    // Add images if any
    for (const att of attachments) {
        if (att.isImage) {
            content.push({
                type: 'image_url',
                image_url: { url: att.data, detail: 'high' }
            });
        }
    }
    
    messages.push({ role: 'user', content: content.length === 1 ? userMessage : content });
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
            model: 'gpt-4o',
            messages: messages,
            max_tokens: 2000,
            temperature: 0.7
        })
    });
    
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return data.choices[0].message.content;
}

async function callClaude(apiKey, systemPrompt, userMessage, attachments) {
    const content = [];
    
    // Add images first
    for (const att of attachments) {
        if (att.isImage) {
            const base64Data = att.data.split(',')[1];
            const mediaType = att.type || 'image/jpeg';
            content.push({
                type: 'image',
                source: {
                    type: 'base64',
                    media_type: mediaType,
                    data: base64Data
                }
            });
        } else if (att.type === 'application/pdf') {
            const base64Data = att.data.split(',')[1];
            content.push({
                type: 'document',
                source: {
                    type: 'base64',
                    media_type: 'application/pdf',
                    data: base64Data
                }
            });
        }
    }
    
    content.push({ type: 'text', text: userMessage });
    
    // Build messages array
    const messages = [];
    const history = aiState.conversationHistory.slice(-6);
    history.forEach(m => messages.push({ role: m.role, content: m.content }));
    messages.push({ role: 'user', content });
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            system: systemPrompt,
            max_tokens: 2000,
            messages: messages
        })
    });
    
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    return data.content[0].text;
}

async function callGemini(apiKey, systemPrompt, userMessage, attachments) {
    const parts = [];
    
    // Add images
    for (const att of attachments) {
        if (att.isImage) {
            const base64Data = att.data.split(',')[1];
            parts.push({
                inline_data: {
                    mime_type: att.type || 'image/jpeg',
                    data: base64Data
                }
            });
        }
    }
    
    parts.push({ text: systemPrompt + '\n\n' + userMessage });
    
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts }],
            generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 2000
            }
        })
    });
    
    const data = await response.json();
    if (data.error) throw new Error(data.error.message);
    if (!data.candidates || !data.candidates[0]) throw new Error('No response generated');
    return data.candidates[0].content.parts[0].text;
}

function formatAIResponse(text) {
    // Convert markdown-like formatting to HTML
    let html = text
        // Escape HTML first
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Bold
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // Code blocks
        .replace(/```([^`]+)```/g, '<pre style="background:#f1f5f9;padding:.75rem;border-radius:4px;overflow-x:auto;font-size:.8rem"><code>$1</code></pre>')
        // Inline code
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Headers
        .replace(/^### (.+)$/gm, '<h4 style="margin:1rem 0 .5rem;color:var(--primary)">$1</h4>')
        .replace(/^## (.+)$/gm, '<h3 style="margin:1rem 0 .5rem;color:var(--primary)">$1</h3>')
        // Bullet points
        .replace(/^\s*[-â€¢]\s+(.+)$/gm, '<li>$1</li>')
        // Numbered lists
        .replace(/^\s*\d+\.\s+(.+)$/gm, '<li>$1</li>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    // Wrap lists
    html = html.replace(/(<li>.*?<\/li>)+/gs, '<ul style="margin:.5rem 0 .5rem 1.25rem">$&</ul>');
    
    return '<p>' + html + '</p>';
}

// Initialize AI tab
document.addEventListener('DOMContentLoaded', function() {
    loadSavedKey();
    
    // Update data badge when data loads
    const originalShowUploadSummary = showUploadSummary;
    showUploadSummary = function() {
        originalShowUploadSummary();
        document.getElementById('aiDataBadge').style.display = 'inline-flex';
    };
});

// ============================================================
// CMF COUNTERMEASURES MODULE
// ============================================================

const cmfState = {
    database: [],
    loaded: false,
    selectedLocation: null,
    locationCrashes: [],
    recommendations: [],
    crashProfile: {}
};

// Load CMF database
async function loadCMFDatabase() {
    const statusEl = document.getElementById('cmfDatabaseStatus');
    
    try {
        // Try loading from same directory first, then from data folder
        let response;
        const urls = ['cmf_data.json', 'data/cmf_data.json', './cmf_data.json'];
        
        for (const url of urls) {
            try {
                response = await fetch(url);
                if (response.ok) break;
            } catch (e) {
                continue;
            }
        }
        
        if (!response || !response.ok) {
            throw new Error('CMF database not found');
        }
        
        cmfState.database = await response.json();
        cmfState.loaded = true;
        
        // Count by category
        const categories = {};
        cmfState.database.forEach(cmf => {
            categories[cmf.category] = (categories[cmf.category] || 0) + 1;
        });
        
        statusEl.innerHTML = `
            <div style="display:flex;align-items:center;gap:.5rem;color:var(--success);margin-bottom:.75rem">
                <span style="font-size:1.2rem">âœ…</span>
                <strong>CMF Database Loaded Successfully</strong>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.5rem;font-size:.8rem">
                <div style="padding:.5rem;background:var(--light);border-radius:var(--radius)">
                    <div style="font-size:1.1rem;font-weight:700;color:var(--primary)">${cmfState.database.length.toLocaleString()}</div>
                    <div style="color:var(--gray)">Total Countermeasures</div>
                </div>
                <div style="padding:.5rem;background:var(--light);border-radius:var(--radius)">
                    <div style="font-size:1.1rem;font-weight:700;color:var(--primary)">${Object.keys(categories).length}</div>
                    <div style="color:var(--gray)">Categories</div>
                </div>
                <div style="padding:.5rem;background:var(--light);border-radius:var(--radius)">
                    <div style="font-size:1.1rem;font-weight:700;color:var(--primary)">${cmfState.database.filter(c => c.rating >= 4).length.toLocaleString()}</div>
                    <div style="color:var(--gray)">High Quality (4+ Stars)</div>
                </div>
            </div>
            <div style="margin-top:.75rem;font-size:.75rem;color:var(--gray)">
                Source: FHWA Crash Modification Factors Clearinghouse | 
                <a href="https://www.cmfclearinghouse.org" target="_blank" style="color:var(--primary)">cmfclearinghouse.org</a>
            </div>
        `;
        
        // Populate location dropdown
        populateCMFLocations();
        
    } catch (error) {
        statusEl.innerHTML = `
            <div style="color:var(--danger)">
                <strong>âš ï¸ CMF Database Not Loaded</strong>
                <p style="font-size:.85rem;margin-top:.5rem">
                    Place <code>cmf_data.json</code> in the same folder as this HTML file or in a <code>data/</code> subfolder.
                </p>
                <button class="btn btn-sm btn-primary" onclick="loadCMFDatabase()" style="margin-top:.5rem">ğŸ”„ Retry</button>
            </div>
        `;
    }
}

function populateCMFLocations() {
    const select = document.getElementById('cmfLocationSelect');
    if (!select || !crashState.loaded) return;
    
    select.innerHTML = '<option value="">-- Select a route or intersection --</option>';
    
    // Add routes
    if (crashState.routes && crashState.routes.length > 0) {
        const routeGroup = document.createElement('optgroup');
        routeGroup.label = 'ğŸ›£ï¸ Routes/Corridors';
        crashState.routes.slice(0, 100).forEach(route => {
            const opt = document.createElement('option');
            opt.value = 'route:' + route;
            opt.textContent = route;
            routeGroup.appendChild(opt);
        });
        select.appendChild(routeGroup);
    }
    
    // Add intersections/nodes
    if (crashState.nodes && crashState.nodes.length > 0) {
        const nodeGroup = document.createElement('optgroup');
        nodeGroup.label = 'ğŸš¦ Intersections/Nodes';
        crashState.nodes.slice(0, 100).forEach(node => {
            const opt = document.createElement('option');
            opt.value = 'node:' + node;
            opt.textContent = node;
            nodeGroup.appendChild(opt);
        });
        select.appendChild(nodeGroup);
    }
}

function loadLocationForCMF() {
    const select = document.getElementById('cmfLocationSelect');
    const value = select.value;
    
    if (!value) {
        document.getElementById('cmfLocationSummary').style.display = 'none';
        document.getElementById('cmfRecommendations').style.display = 'none';
        return;
    }
    
    const [type, name] = value.split(':');
    cmfState.selectedLocation = { type, name };
    
    // Filter crashes for this location
    cmfState.locationCrashes = crashState.sampleRows.filter(row => {
        if (type === 'route') {
            return row[COL.ROUTE] === name;
        } else {
            return row[COL.NODE] === name;
        }
    });
    
    // Build crash profile
    buildCrashProfile();
    displayCrashProfile();
}

function buildCrashProfile() {
    const crashes = cmfState.locationCrashes;
    const profile = {
        total: crashes.length,
        severity: { K: 0, A: 0, B: 0, C: 0, O: 0 },
        collisionTypes: {},
        weatherConditions: {},
        lightConditions: {},
        factors: {
            pedestrian: 0,
            bicycle: 0,
            alcohol: 0,
            speed: 0,
            distracted: 0,
            nighttime: 0,
            wetRoad: 0,
            intersection: 0
        },
        epdo: 0
    };
    
    crashes.forEach(row => {
        const sev = row[COL.SEVERITY] || 'O';
        if (profile.severity[sev] !== undefined) {
            profile.severity[sev]++;
        }
        
        // Collision type
        const collision = row[COL.COLLISION] || 'Unknown';
        profile.collisionTypes[collision] = (profile.collisionTypes[collision] || 0) + 1;
        
        // Weather
        const weather = row[COL.WEATHER] || 'Unknown';
        profile.weatherConditions[weather] = (profile.weatherConditions[weather] || 0) + 1;
        
        // Light
        const light = row[COL.LIGHT] || 'Unknown';
        profile.lightConditions[light] = (profile.lightConditions[light] || 0) + 1;
        
        // Factors
        if (row[COL.PED] === 'Yes' || row[COL.PED] === '1') profile.factors.pedestrian++;
        if (row[COL.BIKE] === 'Yes' || row[COL.BIKE] === '1') profile.factors.bicycle++;
        if (row[COL.ALCOHOL] === 'Yes' || row[COL.ALCOHOL] === '1') profile.factors.alcohol++;
        if (row[COL.SPEED] === 'Yes' || row[COL.SPEED] === '1') profile.factors.speed++;
        if (row[COL.DISTRACTED] === 'Yes' || row[COL.DISTRACTED] === '1') profile.factors.distracted++;
        if (row[COL.NIGHT] === 'Yes' || row[COL.NIGHT] === '1') profile.factors.nighttime++;
        
        // Wet road
        const surface = (row[COL.SURFACE] || '').toLowerCase();
        if (surface.includes('wet') || surface.includes('snow') || surface.includes('ice')) {
            profile.factors.wetRoad++;
        }
        
        // Intersection
        const intType = row[COL.INT_TYPE] || '';
        if (intType && !intType.toLowerCase().includes('non') && !intType.toLowerCase().includes('not')) {
            profile.factors.intersection++;
        }
        
        // EPDO
        profile.epdo += EPDO_WEIGHTS[sev] || 1;
    });
    
    cmfState.crashProfile = profile;
}

function displayCrashProfile() {
    const profile = cmfState.crashProfile;
    const summaryEl = document.getElementById('cmfLocationSummary');
    const kpisEl = document.getElementById('cmfLocationKPIs');
    const crashTypesEl = document.getElementById('cmfCrashTypes');
    const factorsEl = document.getElementById('cmfContribFactors');
    
    // KPIs
    kpisEl.innerHTML = `
        <div class="kpi-card total" style="padding:.75rem">
            <div class="kpi-value" style="font-size:1.3rem">${profile.total}</div>
            <div class="kpi-label" style="font-size:.7rem">Total Crashes</div>
        </div>
        <div class="kpi-card fatal" style="padding:.75rem">
            <div class="kpi-value" style="font-size:1.3rem">${profile.severity.K}</div>
            <div class="kpi-label" style="font-size:.7rem">Fatal (K)</div>
        </div>
        <div class="kpi-card injury-a" style="padding:.75rem">
            <div class="kpi-value" style="font-size:1.3rem">${profile.severity.A}</div>
            <div class="kpi-label" style="font-size:.7rem">Serious (A)</div>
        </div>
        <div class="kpi-card injury-bc" style="padding:.75rem">
            <div class="kpi-value" style="font-size:1.3rem">${profile.severity.B + profile.severity.C}</div>
            <div class="kpi-label" style="font-size:.7rem">Injury (B+C)</div>
        </div>
        <div class="kpi-card pdo" style="padding:.75rem">
            <div class="kpi-value" style="font-size:1.3rem">${profile.severity.O}</div>
            <div class="kpi-label" style="font-size:.7rem">PDO (O)</div>
        </div>
        <div class="kpi-card epdo" style="padding:.75rem">
            <div class="kpi-value" style="font-size:1.3rem">${profile.epdo.toLocaleString()}</div>
            <div class="kpi-label" style="font-size:.7rem">EPDO Score</div>
        </div>
    `;
    
    // Top crash types
    const sortedTypes = Object.entries(profile.collisionTypes)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
    
    crashTypesEl.innerHTML = sortedTypes.map(([type, count]) => {
        const pct = ((count / profile.total) * 100).toFixed(0);
        return `<span class="filter-chip active" style="background:var(--primary);color:white;border-color:var(--primary)">${type} (${pct}%)</span>`;
    }).join('');
    
    // Contributing factors
    const factorLabels = {
        pedestrian: 'ğŸš¶ Pedestrian',
        bicycle: 'ğŸš´ Bicycle',
        alcohol: 'ğŸº Alcohol',
        speed: 'âš¡ Speed',
        distracted: 'ğŸ“± Distracted',
        nighttime: 'ğŸŒ™ Nighttime',
        wetRoad: 'ğŸ’§ Wet Road',
        intersection: 'ğŸš¦ Intersection'
    };
    
    const activeFactors = Object.entries(profile.factors)
        .filter(([_, count]) => count > 0)
        .sort((a, b) => b[1] - a[1]);
    
    factorsEl.innerHTML = activeFactors.map(([factor, count]) => {
        const pct = ((count / profile.total) * 100).toFixed(0);
        return `<span class="filter-chip" style="background:var(--warning-light);border-color:var(--warning);color:#92400e">${factorLabels[factor] || factor} (${pct}%)</span>`;
    }).join('');
    
    summaryEl.style.display = 'block';
}

function findCountermeasures() {
    if (!cmfState.loaded) {
        alert('CMF database not loaded. Please wait or check the database status.');
        return;
    }
    
    if (!cmfState.selectedLocation) {
        alert('Please select a location first.');
        return;
    }
    
    const profile = cmfState.crashProfile;
    const locationType = document.getElementById('cmfLocationType').value;
    const areaType = document.getElementById('cmfAreaType').value;
    const minRating = parseInt(document.getElementById('cmfMinRating').value);
    
    // New advanced filters
    const lanesFilter = document.getElementById('cmfLanes') ? document.getElementById('cmfLanes').value : '';
    const intGeomFilter = document.getElementById('cmfIntGeometry') ? document.getElementById('cmfIntGeometry').value : '';
    const roadDivFilter = document.getElementById('cmfRoadDivision') ? document.getElementById('cmfRoadDivision').value : '';
    const provenOnly = document.getElementById('cmfProvenOnly') ? document.getElementById('cmfProvenOnly').checked : false;
    const hsmOnly = document.getElementById('cmfHSMOnly') ? document.getElementById('cmfHSMOnly').checked : false;
    const virginiaFirst = document.getElementById('cmfVirginiaFirst') ? document.getElementById('cmfVirginiaFirst').checked : false;
    
    // Determine location type if auto
    let effectiveLocationType = locationType;
    if (locationType === 'auto') {
        if (cmfState.selectedLocation.type === 'node') {
            effectiveLocationType = 'intersection';
        } else {
            const intPct = (profile.factors.intersection / profile.total) * 100;
            effectiveLocationType = intPct > 40 ? 'intersection' : 'segment';
        }
    }
    
    // Identify crash type tags from profile
    const crashTypeTags = [];
    const collisionMap = {
        'Angle': 'angle', 'Rear End': 'rear_end', 'Rear-end': 'rear_end',
        'Head On': 'head_on', 'Head-on': 'head_on', 'Sideswipe': 'sideswipe',
        'Fixed Object': 'run_off_road', 'Run Off Road': 'run_off_road',
        'Left Turn': 'left_turn', 'Right Turn': 'right_turn',
        'Backed Into': 'rear_end', 'Non-Collision': 'single_vehicle'
    };
    
    Object.entries(profile.collisionTypes).forEach(([type, count]) => {
        if (count / profile.total > 0.08) {
            for (const [key, tag] of Object.entries(collisionMap)) {
                if (type.toLowerCase().includes(key.toLowerCase())) {
                    crashTypeTags.push(tag);
                }
            }
        }
    });
    
    if (profile.factors.pedestrian / profile.total > 0.03) crashTypeTags.push('pedestrian');
    if (profile.factors.bicycle / profile.total > 0.03) crashTypeTags.push('bicycle');
    if (profile.factors.nighttime / profile.total > 0.25) crashTypeTags.push('nighttime');
    if (profile.factors.speed / profile.total > 0.08) crashTypeTags.push('speed');
    if (profile.factors.wetRoad / profile.total > 0.15) crashTypeTags.push('wet_road');
    
    if (effectiveLocationType === 'intersection') {
        crashTypeTags.push('left_turn', 'right_turn', 'angle');
    }
    crashTypeTags.push('all');
    
    // Score and filter CMFs with new filters
    const scoredCMFs = cmfState.database
        .filter(cmf => cmf.rating >= minRating)
        .filter(cmf => {
            if (cmf.locationType !== 'both' && cmf.locationType !== effectiveLocationType) return false;
            if (areaType !== 'All' && cmf.areaType && cmf.areaType !== 'All' && 
                !cmf.areaType.toLowerCase().includes(areaType.toLowerCase())) return false;
            if (lanesFilter && cmf.minLanes && cmf.maxLanes) {
                const lanes = parseInt(lanesFilter);
                if (lanes < cmf.minLanes || lanes > cmf.maxLanes) return false;
            }
            if (intGeomFilter && cmf.intersectionGeometry && 
                !cmf.intersectionGeometry.toLowerCase().includes(intGeomFilter.toLowerCase())) return false;
            if (roadDivFilter && cmf.roadDivision && 
                !cmf.roadDivision.toLowerCase().includes(roadDivFilter.toLowerCase())) return false;
            if (provenOnly && !cmf.isProven) return false;
            if (hsmOnly && !cmf.inHSM) return false;
            return true;
        })
        .map(cmf => {
            let relevanceScore = 0;
            const matchingTypes = cmf.crashTypes.filter(t => crashTypeTags.includes(t));
            relevanceScore += matchingTypes.length * 20;
            if (matchingTypes.some(t => t !== 'all')) relevanceScore += 30;
            if (cmf.locationType === effectiveLocationType) relevanceScore += 25;
            else if (cmf.locationType === 'both') relevanceScore += 10;
            
            if (effectiveLocationType === 'intersection' && cmf.category.toLowerCase().includes('intersection')) relevanceScore += 35;
            if (effectiveLocationType === 'segment' && (cmf.category.toLowerCase().includes('roadway') || 
                cmf.category.toLowerCase().includes('shoulder'))) relevanceScore += 25;
            
            relevanceScore += cmf.rating * 5;
            if (cmf.isProven) relevanceScore += 20;
            if (cmf.inHSM) relevanceScore += 15;
            if (virginiaFirst && cmf.isVirginia) relevanceScore += 50;
            if (cmf.crfPct > 0) relevanceScore += cmf.crfPct / 2;
            
            const expectedReduction = Math.round(profile.total * (1 - cmf.cmf) * 10) / 10;
            return { ...cmf, relevanceScore, matchingTypes, expectedReduction };
        })
        .filter(cmf => cmf.relevanceScore > 10)
        .sort((a, b) => b.relevanceScore - a.relevanceScore);
    
    const seen = new Set();
    cmfState.recommendations = scoredCMFs.filter(cmf => {
        if (seen.has(cmf.name)) return false;
        seen.add(cmf.name);
        return true;
    }).slice(0, 50);
    
    displayCMFRecommendations(effectiveLocationType);
}

function displayCMFRecommendations(detectedLocationType) {
    const container = document.getElementById('cmfRecommendations');
    const listEl = document.getElementById('cmfResultsList');
    const profile = cmfState.crashProfile;
    
    if (cmfState.recommendations.length === 0) {
        listEl.innerHTML = `
            <div style="padding:2rem;text-align:center;color:var(--gray)">
                <div style="font-size:2rem;margin-bottom:.5rem">ğŸ”</div>
                <p>No matching countermeasures found. Try adjusting the filters or selecting a different location.</p>
            </div>
        `;
        container.style.display = 'block';
        return;
    }
    
    // Count special badges
    const provenCount = cmfState.recommendations.filter(c => c.isProven).length;
    const hsmCount = cmfState.recommendations.filter(c => c.inHSM).length;
    const vaCount = cmfState.recommendations.filter(c => c.isVirginia).length;
    
    const locTypeLabel = detectedLocationType === 'intersection' ? 'ğŸš¦ Intersection' : 'ğŸ›£ï¸ Road Segment';
    const locTypeColor = detectedLocationType === 'intersection' ? '#7c3aed' : '#2563eb';
    
    let headerHtml = `
        <div style="background:linear-gradient(135deg,${locTypeColor}15,${locTypeColor}05);border:1px solid ${locTypeColor}40;border-radius:var(--radius);padding:.75rem 1rem;margin-bottom:1rem">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;margin-bottom:.5rem">
                <div>
                    <span style="font-weight:600;color:${locTypeColor}">${locTypeLabel} Analysis</span>
                    <span style="color:var(--gray);font-size:.85rem;margin-left:.5rem">${cmfState.recommendations.length} countermeasures found</span>
                </div>
                <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                    ${provenCount > 0 ? `<span style="background:#059669;color:white;padding:.2rem .5rem;border-radius:4px;font-size:.7rem">ğŸ† ${provenCount} FHWA Proven</span>` : ''}
                    ${hsmCount > 0 ? `<span style="background:#2563eb;color:white;padding:.2rem .5rem;border-radius:4px;font-size:.7rem">ğŸ“˜ ${hsmCount} HSM</span>` : ''}
                    ${vaCount > 0 ? `<span style="background:#7c3aed;color:white;padding:.2rem .5rem;border-radius:4px;font-size:.7rem">ğŸ—ºï¸ ${vaCount} Virginia</span>` : ''}
                </div>
            </div>
            <div style="font-size:.8rem;color:var(--gray)">
                Based on ${profile.total} crashes at this location | Showing expected crash reductions
            </div>
        </div>
    `;
    
    listEl.innerHTML = headerHtml + cmfState.recommendations.map((cmf, idx) => {
        const stars = 'â˜…'.repeat(cmf.rating) + 'â˜†'.repeat(5 - cmf.rating);
        const effectiveness = cmf.crfPct > 0 ? 
            `<span style="color:var(--success);font-weight:700">${cmf.crfPct.toFixed(0)}% reduction</span>` :
            `<span style="color:var(--danger);font-weight:700">${Math.abs(cmf.crfPct).toFixed(0)}% increase</span>`;
        
        const categoryColors = {
            'Intersection traffic control': '#7c3aed', 'Intersection geometry': '#6366f1',
            'Pedestrians': '#0891b2', 'Bicyclists': '#059669', 'Highway lighting': '#d97706',
            'Roadside': '#dc2626', 'Roadway': '#475569', 'Shoulder treatments': '#64748b',
            'Speed management': '#ea580c', 'Signs': '#8b5cf6', 'Delineation': '#06b6d4',
            'Access management': '#0284c7', 'Advanced technology and ITS': '#2563eb'
        };
        const catColor = categoryColors[cmf.category] || '#64748b';
        
        // Special badges
        let badges = '';
        if (cmf.isProven) badges += '<span style="background:#059669;color:white;padding:.1rem .4rem;border-radius:3px;font-size:.6rem;margin-left:.3rem">ğŸ† PROVEN</span>';
        if (cmf.inHSM) badges += '<span style="background:#2563eb;color:white;padding:.1rem .4rem;border-radius:3px;font-size:.6rem;margin-left:.3rem">ğŸ“˜ HSM</span>';
        if (cmf.isVirginia) badges += '<span style="background:#7c3aed;color:white;padding:.1rem .4rem;border-radius:3px;font-size:.6rem;margin-left:.3rem">ğŸ—ºï¸ VA</span>';
        
        // Location type badge
        const locBadge = cmf.locationType === 'intersection' ? 
            '<span style="background:#7c3aed20;color:#7c3aed;padding:.1rem .4rem;border-radius:3px;font-size:.65rem;margin-left:.3rem">ğŸš¦ INT</span>' :
            cmf.locationType === 'segment' ?
            '<span style="background:#2563eb20;color:#2563eb;padding:.1rem .4rem;border-radius:3px;font-size:.65rem;margin-left:.3rem">ğŸ›£ï¸ SEG</span>' :
            '<span style="background:#05966920;color:#059669;padding:.1rem .4rem;border-radius:3px;font-size:.65rem;margin-left:.3rem">âœ“ BOTH</span>';
        
        // Confidence interval
        let ciHtml = '';
        if (cmf.ciLow !== null && cmf.ciHigh !== null) {
            ciHtml = `<span style="font-size:.7rem;color:var(--gray);margin-left:.5rem">(95% CI: ${cmf.ciLow.toFixed(2)} - ${cmf.ciHigh.toFixed(2)})</span>`;
        }
        
        // Expected crash reduction
        let reductionHtml = '';
        if (cmf.expectedReduction && cmf.expectedReduction > 0) {
            reductionHtml = `
                <div style="background:#d1fae5;border:1px solid #059669;padding:.4rem .75rem;border-radius:var(--radius);font-size:.8rem;color:#065f46">
                    <strong>ğŸ“‰ Expected:</strong> ~${cmf.expectedReduction.toFixed(1)} fewer crashes/year at this location
                </div>
            `;
        }
        
        // Applicability details
        let applicability = [];
        if (cmf.minAADT || cmf.maxAADT) {
            applicability.push(`AADT: ${cmf.minAADT || '?'}-${cmf.maxAADT || '?'}`);
        }
        if (cmf.minLanes || cmf.maxLanes) {
            applicability.push(`Lanes: ${cmf.minLanes || '?'}-${cmf.maxLanes || '?'}`);
        }
        if (cmf.intersectionGeometry) {
            applicability.push(cmf.intersectionGeometry);
        }
        if (cmf.roadDivision) {
            applicability.push(cmf.roadDivision);
        }
        
        let applicabilityHtml = '';
        if (applicability.length > 0) {
            applicabilityHtml = `<div style="font-size:.7rem;color:var(--gray);margin-top:.3rem">ğŸ“‹ Applicability: ${applicability.join(' | ')}</div>`;
        }
        
        // Study link
        let studyLinkHtml = '';
        if (cmf.studyLink) {
            studyLinkHtml = `<a href="${cmf.studyLink}" target="_blank" style="font-size:.7rem;color:var(--primary);margin-left:.5rem">ğŸ“„ View Study</a>`;
        }
        
        return `
            <div class="cmf-result-card" style="border:1px solid var(--gray-light);border-radius:var(--radius-lg);padding:1rem;margin-bottom:.75rem;background:white;transition:all .2s" 
                 onmouseover="this.style.boxShadow='var(--shadow-lg)';this.style.borderColor='var(--primary)'" 
                 onmouseout="this.style.boxShadow='none';this.style.borderColor='var(--gray-light)'">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem">
                    <div style="flex:1">
                        <span style="background:${catColor};color:white;padding:.2rem .5rem;border-radius:4px;font-size:.7rem;font-weight:600">${cmf.category}</span>
                        ${locBadge}${badges}
                    </div>
                    <div style="text-align:right">
                        <div style="color:#f59e0b;font-size:.9rem;letter-spacing:-1px">${stars}</div>
                        <div style="font-size:.7rem;color:var(--gray)">${cmf.rating}-star${cmf.pubYear ? ` Â· ${cmf.pubYear}` : ''}</div>
                    </div>
                </div>
                <h4 style="font-size:.95rem;color:var(--dark);margin-bottom:.4rem;font-weight:600">${cmf.name}${studyLinkHtml}</h4>
                ${cmf.desc ? `<p style="font-size:.8rem;color:var(--gray);margin-bottom:.5rem;line-height:1.4">${cmf.desc.substring(0, 200)}${cmf.desc.length > 200 ? '...' : ''}</p>` : ''}
                <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-top:.5rem">
                    <div style="background:var(--light);padding:.4rem .75rem;border-radius:var(--radius);font-size:.85rem">
                        <strong>CMF:</strong> ${cmf.cmf.toFixed(2)} â†’ ${effectiveness}${ciHtml}
                    </div>
                    ${reductionHtml}
                </div>
                ${applicabilityHtml}
                <div style="font-size:.75rem;color:var(--gray);margin-top:.3rem">
                    <strong>Crash types:</strong> ${cmf.crashTypes.filter(t => t !== 'all').join(', ') || 'All'}
                </div>
            </div>
        `;
    }).join('');
    
    container.style.display = 'block';
}

function sortCMFResults() {
    const sortBy = document.getElementById('cmfSortBy').value;
    
    cmfState.recommendations.sort((a, b) => {
        if (sortBy === 'effectiveness') {
            return b.crfPct - a.crfPct;
        } else if (sortBy === 'rating') {
            return b.rating - a.rating || b.crfPct - a.crfPct;
        } else {
            return b.relevanceScore - a.relevanceScore;
        }
    });
    
    // Get current location type
    const locationType = document.getElementById('cmfLocationType').value;
    let effectiveLocationType = locationType;
    if (locationType === 'auto') {
        if (cmfState.selectedLocation && cmfState.selectedLocation.type === 'node') {
            effectiveLocationType = 'intersection';
        } else {
            const intPct = (cmfState.crashProfile.factors.intersection / cmfState.crashProfile.total) * 100;
            effectiveLocationType = intPct > 40 ? 'intersection' : 'segment';
        }
    }
    
    displayCMFRecommendations(effectiveLocationType);
}

function exportCMFReport() {
    if (cmfState.recommendations.length === 0) {
        alert('No recommendations to export');
        return;
    }
    
    const profile = cmfState.crashProfile;
    const location = cmfState.selectedLocation;
    
    let csv = 'Countermeasure Recommendations Report\n';
    csv += `Location: ${location.name} (${location.type})\n`;
    csv += `Total Crashes: ${profile.total}, EPDO: ${profile.epdo}\n`;
    csv += `Generated: ${new Date().toLocaleString()}\n\n`;
    csv += 'Rank,Countermeasure,Category,CMF,CRF%,Star Rating,Crash Types,Prior Condition\n';
    
    cmfState.recommendations.forEach((cmf, idx) => {
        const row = [
            idx + 1,
            `"${cmf.name.replace(/"/g, '""')}"`,
            `"${cmf.category}"`,
            cmf.cmf.toFixed(2),
            cmf.crfPct.toFixed(1),
            cmf.rating,
            `"${cmf.crashTypes.join(', ')}"`,
            `"${(cmf.priorCondition || '').replace(/"/g, '""')}"`
        ];
        csv += row.join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CMF_Recommendations_${location.name.replace(/[^a-z0-9]/gi, '_')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

function printCMFReport() {
    window.print();
}

// Initialize CMF module when tab is shown or data loads
document.addEventListener('DOMContentLoaded', function() {
    // Load CMF database
    setTimeout(loadCMFDatabase, 1000);
    
    // Re-populate locations when data loads
    const checkDataLoaded = setInterval(() => {
        if (crashState.loaded) {
            populateCMFLocations();
            clearInterval(checkDataLoaded);
        }
    }, 1000);
});
</script>

<!-- Location Details Modal -->
<div class="modal-overlay" id="locationModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="modalLocationTitle">ğŸ“ Location Details</h3>
<button class="modal-close" onclick="closeModal()">&times;</button>
</div>
<div class="modal-body" id="modalBody"></div>
</div>
</div>

</body>
</html>
